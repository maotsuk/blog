<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure IaaS Core Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure IaaS テクニカル サポート チームより、情報をお届けします！</subtitle>
  <link href="https://jpaztech.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpaztech.github.io/blog/"/>
  <updated>2024-07-03T06:47:12.873Z</updated>
  <id>https://jpaztech.github.io/blog/</id>
  
  <author>
    <name>Japan Azure IaaS Core Support Team</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Application Gateway WAF V2 CRS 3.2 以降で追加された要求本文の検査について</title>
    <link href="https://jpaztech.github.io/blog/network/appgw-waf-body-file-size/"/>
    <id>https://jpaztech.github.io/blog/network/appgw-waf-body-file-size/</id>
    <published>2024-05-14T12:08:00.000Z</published>
    <updated>2024-07-03T06:47:12.873Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの大塚です。</p><p>この記事では、先日新たに追加された Application Gateway WAF ポリシーのマネージド ルールにおいて CRS （コア ルール セット）3.2 以上を利用している際に要求本文(＝Request Body)のサイズ、ファイル アップロードのサイズ、および要求本文の検査をより細かく制御できる機能についてご紹介します。</p><span id="more"></span><hr><h3 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h3><p>この記事は、以下の 3 つのシナリオにすべてあてはまるお客様向けの内容となります。</p><ul><li> Application Gateway WAF V2 の SKU を利用している</li><li> WAF ポリシーを利用している</li><li> WAF ポリシーのマネージド ルールで指定している CRS バージョンが 3.2 以上である</li></ul><p>WAF によってチェックされる要求サイズへの制限につきましては<a href="https://learn.microsoft.com/ja-jp/azure/web-application-firewall/ag/application-gateway-waf-request-size-limits">こちら</a>のドキュメントに記載がございますが、本ブログでは今回追加された新機能のみに焦点をおき、ご紹介いたします。</p><h3 id="新しく追加された機能"><a href="#新しく追加された機能" class="headerlink" title="新しく追加された機能"></a>新しく追加された機能</h3><p>今回追加された機能を含め、現在 CRS 3.2 以上の WAFで利用できる機能は以下となります。</p><ul><li> ① 要求の本文に含まれる内容において、先頭から何 KB の範囲を WAF で評価させるかの検査の上限を指定することができる</li><li> ② 要求の本文の検査するサイズの上限の指定とは独立して、要求本文の内容を検査する/しないを指定できる</li><li> ③ 要求の本文に含まれる内容の検査とは独立して、要求本文のサイズの検査を無効にできる</li><li> ④ 要求の本文の検査とは独立して、ファイル アップロードのサイズの検査を無効にできる</li><li> ⑤ 要求本文のサイズの上限を指定できる <code>※ 8 KB から 2000 KB（2MB） の範囲</code></li><li> ⑥ ファイル アップロードのサイズの上限を指定できる <code>※ 1 MB から 4000 MB（4GB） の範囲</code></li></ul><p>実際のポータルの設定画面と上記項番の該当箇所は以下のようになります。<br><img src="/blog/network/appgw-waf-body-file-size/15.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>大きく追加された機能としては ① です。</p><p>②から④ は CRS 3.1 以下でも利用できましたが、それぞれの設定が独立して指定できるようになりました。</p><p>⑤から⑥ はこれまでと変わらず WAF 利用時のサイズの上限を指定する項目となります。  </p></div><p><span id="wafv2limit"></span></p><h3 id="上限値の整理"><a href="#上限値の整理" class="headerlink" title="上限値の整理"></a><a href="#wafv2limit">上限値の整理</a></h3><p>Application Gateway V2 の要求本文サイズやファイル アップロードサイズの「上限値」について整理しましょう。<br>（※単位の違いにもご留意ください）</p><table><thead><tr><th></th><th>要求本文のサイズ上限</th><th>ファイル アップロードのサイズ上限</th></tr></thead><tbody><tr><td>Application Gateway V2 自体の上限値 （要求本文/ファイルアップロードの上限適用を無効にした場合はこの上限になります）</td><td>4 GB</td><td>4 GB</td></tr><tr><td>Application Gateway WAF V2/CRS 3.2 以降の上限値</td><td>2 MB</td><td>4 GB</td></tr><tr><td>Application Gateway WAF V2/CRS 3.1 以前の上限値</td><td>128 KB</td><td>750 MB</td></tr></tbody></table><p><span id="labtest"></span></p><h3 id="実際の動作の確認"><a href="#実際の動作の確認" class="headerlink" title="実際の動作の確認"></a><a href="labtest">実際の動作の確認</a></h3><p>それでは新しく追加された ① の機能について動作を詳しく確認してみましょう。</p><p>この検証では、クライアントが送信するリクエストの要求本文の先頭から 10 KB 目に WAF で検知される文字列を含ませて送信してみることにします。設定内容によって実際に WAF がどのように動作するかを検証してみました。</p><h3 id="「要求本文検査の上限-KB-」が-128-既定値-の場合"><a href="#「要求本文検査の上限-KB-」が-128-既定値-の場合" class="headerlink" title="「要求本文検査の上限 (KB)」が 128 (既定値)の場合"></a>「要求本文検査の上限 (KB)」が 128 (既定値)の場合</h3><p><img src="/blog/network/appgw-waf-body-file-size/02.png"></p><p>検査する要求本文の範囲は先頭から 128 KB までを指定しています。<br>要求本文の先頭から 10 KB 目に WAF で検知される文字列が含まれているリクエストを送信しているので、この場合は該当文字列はWAF での評価がされます。アクセス ログより HTTP ステータス コード 403 が返され、ブロックされることが確認できました。</p><p><img src="/blog/network/appgw-waf-body-file-size/03.png"></p><h3 id="「要求本文検査の上限-KB-」が-8-の場合"><a href="#「要求本文検査の上限-KB-」が-8-の場合" class="headerlink" title="「要求本文検査の上限 (KB)」が 8 の場合"></a>「要求本文検査の上限 (KB)」が 8 の場合</h3><p><img src="/blog/network/appgw-waf-body-file-size/04.png"></p><p>検査する要求本文の範囲は先頭から 8 KB までを指定しています。<br>要求本文の先頭から 10 KB 目に WAF で検知される文字列が含まれているリクエストを送信しているので、この場合は該当文字列は WAF での評価はされません。アクセス ログより HTTP ステータス コード 200 が返されたことが確認できました。</p><p><img src="/blog/network/appgw-waf-body-file-size/05.png"></p><h3 id="「要求本文検査の上限-KB-」を「要求本文最大サイズ-KB-」よりも大きくした場合"><a href="#「要求本文検査の上限-KB-」を「要求本文最大サイズ-KB-」よりも大きくした場合" class="headerlink" title="「要求本文検査の上限 (KB)」を「要求本文最大サイズ (KB)」よりも大きくした場合"></a>「要求本文検査の上限 (KB)」を「要求本文最大サイズ (KB)」よりも大きくした場合</h3><p><img src="/blog/network/appgw-waf-body-file-size/09.png"></p><p>検査する要求本文の範囲は先頭から 15 KB までを指定していますが、要求本文のサイズ上限を 8 KB に指定しています。<br>この場合「要求本文最大サイズ」の上限値まで要求本文の内容が検査されます。さらにサイズの上限に合致している場合は WAF でブロックされます。アクセス ログより HTTP ステータス コード 403 が返され、ブロックされたことが確認できました。</p><p><img src="/blog/network/appgw-waf-body-file-size/11.png"></p><p>WAF 側のログでは要求本文の長さ (サイズ)が上限を超過したためブロックしたことを示すログが記録されていました。</p><p><img src="/blog/network/appgw-waf-body-file-size/10.png"></p><h3 id="「要求本文の検査を適用する」を無効にする"><a href="#「要求本文の検査を適用する」を無効にする" class="headerlink" title="「要求本文の検査を適用する」を無効にする"></a>「要求本文の検査を適用する」を無効にする</h3><p><img src="/blog/network/appgw-waf-body-file-size/06.png"></p><p>要求本文の検査を無効に指定しているので、要求本文に含まれる内容に対して WAF の評価はされません。アクセス ログより HTTP ステータス コード 200 が返されたことが確認できました。</p><p><img src="/blog/network/appgw-waf-body-file-size/07.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>要求本文の検査を無効（②の項番）にしている状態でも、要求本文の最大サイズ指定（⑤の項番）を有効としている場合はその設定は有効です。つまり以下のように設定している場合、要求本文の内容は WAF で評価されませんが、要求本文のサイズが 8 KB より大きい場合は WAF で評価されブロックされます。</p><p><img src="/blog/network/appgw-waf-body-file-size/08.png"></p></div><h3 id="Application-Gateway-V2-側の制限値によってブロックされた場合の動作"><a href="#Application-Gateway-V2-側の制限値によってブロックされた場合の動作" class="headerlink" title="Application Gateway V2 側の制限値によってブロックされた場合の動作"></a>Application Gateway V2 側の制限値によってブロックされた場合の動作</h3><p>番外編として、Application Gateway V2 自体のサイズ上限値に合致した場合はどのような動作となるかも確認しました。<br>設定値はすべて無効に指定します。</p><blockquote><p><img src="/blog/network/appgw-waf-body-file-size/13.png"></p></blockquote><p>要求本文のサイズを Application Gateway V2 の上限である 4 GB よりも大きくしてリクエストを送信したところ、アクセス ログより HTTP ステータス コード 413 が返されることが確認できました。この時 WAF 側のログには何も記録はありません。また、ファイル アップロードサイズでも同じ動作が確認できました。</p><blockquote><p><img src="/blog/network/appgw-waf-body-file-size/14.png"></p></blockquote><p>Application Gateway V2 の上限に合致した場合は HTTP ステータス コード 403 ではなく 413 となることが確認できました。<br>本ブログ記事の内容が皆様のお役に少しでも立てましたら幸いです。</p><p><span id="reference"></span></p><h3 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a><a href="#reference">参考情報</a></h3><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/web-application-firewall/ag/application-gateway-waf-request-size-limits">Web Application Firewall の要求とファイル アップロードのサイズ制限</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/azure-subscription-service-limits#application-gateway-limits">Application Gateway の制限</a></li></ul>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの大塚です。&lt;/p&gt;
&lt;p&gt;この記事では、先日新たに追加された Application Gateway WAF ポリシーのマネージド ルールにおいて CRS （コア ルール セット）3.2 以上を利用している際に要求本文(＝Request Body)のサイズ、ファイル アップロードのサイズ、および要求本文の検査をより細かく制御できる機能についてご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Application Gateway" scheme="https://jpaztech.github.io/blog/tags/Application-Gateway/"/>
    
    <category term="WAF" scheme="https://jpaztech.github.io/blog/tags/WAF/"/>
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>可用性セットや可用性ゾーン上の単一 VM インスタンスの可用性について</title>
    <link href="https://jpaztech.github.io/blog/vm/sla-singlevm-availability/"/>
    <id>https://jpaztech.github.io/blog/vm/sla-singlevm-availability/</id>
    <published>2024-05-02T03:00:00.000Z</published>
    <updated>2024-07-03T06:47:13.297Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームです。 </p><p>本ブログ記事では、可用性セットや可用性ゾーン上に単一の VM インスタンスのみを構成した場合の SLA についてご案内いたします。 </p><span id="more"></span><p>可用性セットや可用性ゾーンは、VM 群を稼働するハードウェアが単一障害点とならないように分散配置することで基盤障害の影響を一部の VM に限定するサービスとなります。</p><p>例えば、あるシステムにおいてゾーン 1 とゾーン 2 に 1 台ずつ VM を構成している場合、ゾーン 1 で基盤障害が発生した際にはゾーン 1 の VM は影響を受けますが、ゾーン 2 の VM は影響を受けずに稼働を継続するため、システム全体としての可用性を向上させることができます。<br>すなわち、一つ一つの VM インスタンスとしての可用性には変わりはなく、可用性セットや可用性ゾーンに複数の VM を冗長構成で構築いただくことで、初めて高可用性の恩恵を受けることが可能となります。<br>そのため、VM インスタンス 1 台のみを可用性セットや可用性ゾーンに構成することは可能ですが、可用性が向上している訳ではございませんので、SLA の考え方としては可用性セット・可用性ゾーン無しの状態と同じ単一インスタンスとしての計算となります。  </p><p>可用性セットや可用性ゾーンを構成した場合の SLA については、構成した全ての VM インスタンスが停止してしまった際にダウンタイムとして計算されるような形となります。<br>一つ以上のインスタンスが稼働を継続できている場合にはそれぞれのインスタンスとしての SLA のみが適用されますことご留意ください。</p><p>Azure VM の可用性セットおよび可用性ゾーンの詳細については、以下の公式ドキュメントをご確認いただけますと幸いでございます。</p><p>■ご参考：Azure Virtual Machines の可用性オプション<br><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/availability">https://learn.microsoft.com/ja-jp/azure/virtual-machines/availability</a>  </p><p>また、SLA については毎月最新の情報が公開されますため、詳細につきましては、以下のサイトにございます Word ファイルをダウンロードいただき、ご確認いただきますと幸いです。<br>最新バージョンはサイト上部の [Download] からご確認いただけますので、”仮想マシン” セクションをご覧ください。  </p><p>■ご参考： Service Level Agreements (SLA) for Online Services<br><a href="https://www.microsoft.com/licensing/docs/view/Service-Level-Agreements-SLA-for-Online-Services?lang=18">https://www.microsoft.com/licensing/docs/view/Service-Level-Agreements-SLA-for-Online-Services?lang=18</a>  </p><p><img src="/blog/vm/sla-singlevm-availability/img001.png"></p><p>簡単ではございますが、上記の内容がお客様のお役に立ちますと幸いでございます。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームです。 &lt;/p&gt;
&lt;p&gt;本ブログ記事では、可用性セットや可用性ゾーン上に単一の VM インスタンスのみを構成した場合の SLA についてご案内いたします。 &lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="Information" scheme="https://jpaztech.github.io/blog/tags/Information/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway WAF  の誤検知対応</title>
    <link href="https://jpaztech.github.io/blog/network/handle-waf-false-positive/"/>
    <id>https://jpaztech.github.io/blog/network/handle-waf-false-positive/</id>
    <published>2024-05-02T03:00:00.000Z</published>
    <updated>2024-07-03T06:47:12.901Z</updated>
    
    <content type="html"><![CDATA[<p>いつもお世話になっております。Azure Networking チームの庄です。</p><p>Web アプリケーションは、SQL インジェクションやクロスサイトスクリプティングなど、既知の脆弱性を悪用した攻撃のターゲットになることが多いです。Application Gateway および Azure Front Door を使用しているお客様の Web アプリケーションをそのような攻撃から保護するためには、Azure は Web アプリケーションファイアウォール（WAF）サービスを提供しています。</p><p>Application Gateway で WAF を使用する際に、本来許可されるべき通信がブロックされる事例がしばしば発生します。このような事象が発生した場合に、お客様自身がどのように初期対応を行うことができるかについて、こちらのブログではその詳細な対応方法を説明いたします。</p><p>WAF で誤検知 (False Positive) が発生した理由は、WAF の不具合ではなく、ルールに基づく正確な検査の結果、お客様のアプリケーションにとって望ましくなく、ルール違反と判断された通信が検出されたためです。たとえば、Request Body や Header 内に攻撃と判断される文字列が存在すると、WAF によって通信がブロックされます。この結果がお客様のアプリケーションにとって望ましくない場合、その通信が WAF より誤検知されています。この記事では、WAF での誤検知が発生する際に、誤検知を回避するための対処方法につきまして紹介いたします。</p><h2 id="WAF-側の設定"><a href="#WAF-側の設定" class="headerlink" title="WAF 側の設定"></a>WAF 側の設定<br /></h2><p>Azure WAF の設定を使って誤検知を避ける方法には、主に3つの方法があります。</p><h3 id="設定方法１：除外を利用する"><a href="#設定方法１：除外を利用する" class="headerlink" title="設定方法１：除外を利用する"></a>設定方法１：除外を利用する</h3><p>除外は、特定の Header や Request Body 内で誤検知が起こった部分を指定し、これらを誤検知として検出されたルールの評価から外す方法です。この方法は、本記事で紹介した 3 つの中で最も柔軟性が高いと考えられます。除外の設定は、WAF ポリシーの「管理されているルール」のページで見つけることができます。ただし、除外の設定が利用できない場合もあるので、その場合は他の設定方法の利用をご検討いただく必要があります。その具体的な設定方法については本記事他の箇所をご確認ください。</p><img src="./exclusion.png" alt="除外を利用する" style="width:600px;"/> <h3 id="設定方法２：カスタム-ルールを利用する"><a href="#設定方法２：カスタム-ルールを利用する" class="headerlink" title="設定方法２：カスタム ルールを利用する"></a>設定方法２：カスタム ルールを利用する</h3><p>カスタム ルールを使用することで、特定の IP アドレスからの通信や特定のパスへのアクセスを WAF の評価から除外し、通信を管理されたルールから ”Bypass” するルールを作成できます。カスタム ルールは管理されたルールよりも優先され、ここで設定したルールによって通信が許可または拒否されます。カスタム ルールの設定は、WAF ポリシーの「カスタム ルール」ページで行うことができます。</p><img src="./customruleportal.png" alt="カスタム ルールを利用する" style="width:600px;"/> <h3 id="設定方法３：特定のルールの無効化"><a href="#設定方法３：特定のルールの無効化" class="headerlink" title="設定方法３：特定のルールの無効化"></a>設定方法３：特定のルールの無効化</h3><p>WAF で特定のルールによる誤検知が発生した場合、そのルールを無効にすることも誤検知への対処法の一つです。ルールの無効化は、WAF ポリシーの「管理されているルール」ページで行うことができます。</p><img src="./disabledrules.png" alt="特定のルールの無効化" style="width:700px;"/> <div class="alert is-info"><p class="alert-title">Note</p><p>これらの方法以外にも、WAF の要求本文の検査を無効にすることが考えられますが、これを行うと WAF が Request Body の検査を行わなくなり、セキュリティ リスクが高まる可能性があります。この無効化を検討する場合は、サーバー側でのセキュリティ対策の実施をお勧めします。</p></div><h2 id="アプリケーション側の対応"><a href="#アプリケーション側の対応" class="headerlink" title="アプリケーション側の対応"></a>アプリケーション側の対応</h2><p>WAF 側の設定だけでは要件を満たさない場合、アプリケーション側での対策が解決策の一つになります。例えば、ユーザー情報をフォームで収集するアプリケーションを開発する際に、フォーム入力で「#」や「%」のような、攻撃に利用される可能性のある文字の使用を制限する設定を追加することで、ユーザーがこれらの文字を含むリクエストを送信することによる誤検知を防ぐことができます。具体的にどのような文字列が管理されたルールに一致するかについては、お客様ご自身で OWASP コミュニティのサイトや Core Rule Set の GitHub ページなどで確認する必要があります。</p><p><a href="https://owasp.org/www-project-modsecurity-core-rule-set/">OWASP ModSecurity Core Rule Set</a></p><p><a href="https://github.com/coreruleset/coreruleset">Core Rule Set の GitHub</a></p><h1 id="ログ"><a href="#ログ" class="headerlink" title="ログ"></a>ログ</h1><p>誤検知が発生した場合、その原因を理解することが最初のステップです。具体的には、どのルールによって誤検知が起きているのか、そしてその誤検知の原因が何なのかを WAF のログから把握する必要があります。この情報がなければ、誤検知を避けるための適切な対策を講じることができません。WAF のログは、WAF に関連付けられた Application Gateway のログで以下のクエリを実行することで確認できます。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AzureDiagnostics </span><br><span class="line">| where ResourceProvider == &quot;MICROSOFT.NETWORK&quot; and Category == &quot;ApplicationGatewayFirewallLog&quot;</span><br></pre></td></tr></table></figure><p>このクエリを実行すると、次のような形式のログが出力されます。誤検知を避けるためには、WAF の設定で特定のログフィールドに注意を払う必要があります。該当するフィールドは下の図の赤い枠で示されています。詳しいについては、「WAF ログのフィールド」セクションをご覧ください。</p><img src="./examplelog.png" alt="ログ" style="width:900px;"/><p>上記のクエリ以外にも、以下のドキュメントには様々な WAF ログのクエリ例が記載されています。ご参考いただければと存じます。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/log-analytics">Log Analytics を使用して Application Gateway Web アプリケーション ファイアウォール (WAF) のログを調べる</a></p><h2 id="WAF-ログのフィールド"><a href="#WAF-ログのフィールド" class="headerlink" title="WAF ログのフィールド"></a>WAF ログのフィールド</h2><p>誤検知に対応するためには、以下の WAF ログのフィールドを理解する必要があります。</p><h3 id="フィールド１：ruleSetType-amp-ruleSetVersion"><a href="#フィールド１：ruleSetType-amp-ruleSetVersion" class="headerlink" title="フィールド１：ruleSetType &amp; ruleSetVersion"></a>フィールド１：ruleSetType &amp; ruleSetVersion</h3><p>ruleSetType と ruleSetVersion は、特定の通信がどのルールセット内のどのルールに一致しているを表示します。特に WAF ポリシーに複数のバージョンのルールセットが設定されている場合、正しいバージョンのルールセットに対して除外を作成する必要があるので、こちらのフィールドの参照が必要です。</p><h3 id="フィールド２：ruleId"><a href="#フィールド２：ruleId" class="headerlink" title="フィールド２：ruleId"></a>フィールド２：ruleId</h3><p>ruleId は、特定の通信がどのルールに一致しているかを示します。OWASP 3.2 以上の WAF ポリシーを利用する際には、こちらのフィールドの参照して、除外を作成するときに正しいルールを選択する必要があります。</p><h3 id="フィールド３：-details-data"><a href="#フィールド３：-details-data" class="headerlink" title="フィールド３： details_data"></a>フィールド３： details_data</h3><p>ルールにマッチした原因は、WAF ログの details_data で確認できます。通常、以下の形式でマッチした内容を確認できます。</p><img src="./details.png" alt="details_data" style="width:700px;"/><h4 id="上図-①-の部分について"><a href="#上図-①-の部分について" class="headerlink" title="上図 ① の部分について"></a>上図 ① の部分について</h4><p>① は、通常、マッチした文字列です。例えば、Request Body に「#」が含まれているためにルールによって検出された場合、①には「#」が表示されます。</p><h4 id="上図-②-の部分について"><a href="#上図-②-の部分について" class="headerlink" title="上図 ② の部分について"></a>上図 ② の部分について</h4><p>② は、通常、Request Body のどの部分にマッチする文字列が含まれているかを示します。例えば、ある Header 名に「#」が含まれている場合、② には「HeaderName」が表示されます。② に表示されるものはマッチしたルールの種類（OWASP や Bot Manager Rule など）によって異なることがあります。</p><h4 id="上図-③-の部分について"><a href="#上図-③-の部分について" class="headerlink" title="上図 ③ の部分について"></a>上図 ③ の部分について</h4><p> ③ は、② の内容と関連しています。② が要求本文フィールドの名前「xxxName」を示している場合、③ではその具体的な要求本文フィールド名が表示されます。例えば、 Header 名に不正な文字「#」が含まれてWAFによって検出された場合、③ にはその Header 名を表示します。また、「XXX : YYYY」という形式で表示される場合もあります。これは、要求本文フィールド値に不正な文字列が検出された場合のログ表示形式です。</p><div class="alert is-info"><p class="alert-title">Note</p><p>details_data に「Inbound Anomaly Score Exceeded」（受信異常スコア超過）というメッセージが記載されている場合、実際の検出原因は同じ Transaction ID を持つ他のログで確認できます。詳細については、下記の異常スコアのドキュメントを参照していただければ幸いです</p><p><a href="https://learn.microsoft.com/ja-jp/azure/web-application-firewall/ag/application-gateway-crs-rulegroups-rules?tabs=drs21#anomaly-scoring">Web Application Firewall の DRS および CRS の規則グループと規則 ｜異常スコアリング</a></p></div><h3 id="フィールド-４：action"><a href="#フィールド-４：action" class="headerlink" title="フィールド ４：action"></a>フィールド ４：action</h3><p> WAF の Action は、検出された通信に対して実施された操作を示します。ログのアクションフィールドには、「Matched」と「Blocked」の二つの値がありますが、表示される値は WAF ポリシーのモードによって異なります。</p><h4 id="ポリシー-モード-検出"><a href="#ポリシー-モード-検出" class="headerlink" title="ポリシー モード : 検出"></a>ポリシー モード : 検出</h4><p>検出モードでは WAF は Allow や Block といったアクションを実行しませんので Detected のみが記録されます。</p><h4 id="ポリシー-モード-防止"><a href="#ポリシー-モード-防止" class="headerlink" title="ポリシー モード : 防止"></a>ポリシー モード : 防止</h4><p>Allowed : 通信がカスタムルールなどにより、WAF から許可された場合に表示されます。<br>Blocked : 特定のルールに一致する要求が検出され、危険と判断されたため、通信は WAF  によってブロックされます。<br>Matched : 一部の条件に一致する要求がある場合、WAF はさらに評価を行い、最終的な異常スコアリングルールに基づいて、要求をブロックするかどうかを決定します。<br>Log : 防止モードで記録される Action です。カスタムルールの Action (結果の欄) に “トラフィックのみをログに記録する” を指定した場合に、WAF ログの Action フィールドには、Log という値が記録されます。</p><h1 id="除外"><a href="#除外" class="headerlink" title="除外"></a>除外</h1><p>除外を作成する際には、ログに検出された内容に基づいて除外を作成します。しかし、利用中の WAF ポリシーのバージョンにより、設定できる除外のパラメーターが異なります。</p><table><thead><tr><th>除外</th><th>CRS 3.1 以前</th><th>CRS 3.2 以降</th></tr></thead><tbody><tr><td>キーと値による要求属性の除外</td><td>×</td><td>○</td></tr><tr><td>ルールごとの除外</td><td>×</td><td>○</td></tr><tr><td>要求属性の大小文字区別</td><td>区別しません</td><td>Header 以外は区別します</td></tr></tbody></table><h2 id="設定フィールド：適用対象"><a href="#設定フィールド：適用対象" class="headerlink" title="設定フィールド：適用対象"></a>設定フィールド：適用対象</h2><img src="./rule.png" alt="適用対象" style="width:700px;"/><p>OWASP 3.2 以降の WAF ポリシーの除外設定では、ログの ruleSetType &amp; ruleSetVersion フィールドに記載された内容に基づいて、適切なルールセット バージョンを選択する必要があります。例えば、誤検知が発生した際に ruleSetType &amp; ruleSetVersion が以下の値を表示している場合、適用対象として OWASP_3.2 を選択する必要があります。</p><table><thead><tr><th>ruleSetType</th><th>ruleSetVersion</th></tr></thead><tbody><tr><td>OWASP CRS</td><td>3.2</td></tr></tbody></table><p>OWASP 3.1 以前の WAF ポリシーの除外設定では、グローバル除外(すべての WAF ルールに適用するように除外)のみ設定可能です。</p><h2 id="設定フィールド：ルールの追加"><a href="#設定フィールド：ルールの追加" class="headerlink" title="設定フィールド：ルールの追加"></a>設定フィールド：ルールの追加</h2><p><img src="/blog/network/handle-waf-false-positive/selectrule.png"></p><p>OWASP 3.2 以降の WAF ポリシーを利用する際には、ログに記載された ruleId フィールドに基づき、除外を適用したい特定のルールを選択します。「ルールの追加」ボタンをクリックしてルール検索ページを開き、ログに表示された ruleId フィールドに記載されたルール ID を検索することで、除外を適用する対象となるルールを選び出せます。この操作により、特定のルールに対してのみ除外を適用でき、他のルールにマッチした場合は除外が適用されません。<br>OWASP 3.1 以前の WAF ポリシーの除外設定では、こちらのルールの追加ができません。</p><h2 id="一致変数"><a href="#一致変数" class="headerlink" title="一致変数"></a>一致変数</h2><p>OWASP 3.2 以降の WAF ポリシーでは、以下の一致変数が設定できます。</p><img src="./32arg.png" alt="一致変数1" style="width:200px;"/><p>OWASP 3.1 以前の WAF ポリシーでは、以下の一致変数が設定できます。</p><img src="./30arg.png" alt="一致変数2" style="width:200px;"/><p>一致変数の選択は、details_data 内の ② の値に基づいて行います。</p><img src="./requestarg.png" alt="一致変数3"  style="width:200px;"/><p>② の値と一致変数の対応例は以下の通りです。</p><table><thead><tr><th>②の値</th><th>一致変数の選択</th></tr></thead><tbody><tr><td>xxxKey</td><td>要求xxxキー</td></tr><tr><td>xxxName</td><td>要求xxx名</td></tr><tr><td>xxxValue</td><td>要求xxx値</td></tr><tr><td>Args</td><td>要求引数値</td></tr></tbody></table><h2 id="演算子"><a href="#演算子" class="headerlink" title="演算子"></a>演算子</h2><p>演算子の選択には「次の値で始まる」、「次で終わる」、「次の値に等しい」、「次の値を含む」、「いずれかと等しい」といったオプションがあります。その中で特に注意が必要なオプションとして、「いずれかと等しい」を利用する場合、セレクターに設定される値に関わらず、「*」がセレクター値として適用されます。詳細は以下のドキュメントに関連記事があります。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/web-application-firewall/ag/application-gateway-waf-configuration?tabs=portal#identify-request-attributes-to-exclude">Web アプリケーション ファイアウォールの除外リスト</a></p><h2 id="セレクター"><a href="#セレクター" class="headerlink" title="セレクター"></a>セレクター</h2><p>セレクターでは、基本的には、details_data 内の ① の値に基づいて行いますが、セレクターを設定できないものがあります。</p><h3 id="セレクターに使用できるのは文字、数字、句読点のみです"><a href="#セレクターに使用できるのは文字、数字、句読点のみです" class="headerlink" title="セレクターに使用できるのは文字、数字、句読点のみです"></a>セレクターに使用できるのは文字、数字、句読点のみです</h3><p>セレクターのフィールドでは、文字、数字、句読点以外の入力が許可されていません。そのため、details_data 内の ① の値に特殊文字が含まれている場合、セレクターにその文字を直接設定することはできません。例えば、「Hea#der」という名前の Header が WAF によって「#」の存在で検出された場合、① には「#」が表示されます。しかし、セレクター内では「#」の入力が許可されていないため、演算子として「次の値を含む」を選択し、セレクターには「Hea」や「der」といった値を選んで除外設定を行うことで、該当する Header を除外することが可能です。</p><h3 id="効果がない除外設定"><a href="#効果がない除外設定" class="headerlink" title="効果がない除外設定"></a>効果がない除外設定</h3><p>details_data で検出された要求 xxx 値に基づいて除外を設定する際、WAF は特定の文字列を含む値に対して除外を適用できないため、以下のような除外設定では効果がありません。</p><table><thead><tr><th>検知内容</th></tr></thead><tbody><tr><td>Matched Data: <strong>#12</strong> found within <strong>ARGS</strong> : <strong>page</strong>: <strong>#1234</strong></td></tr></tbody></table><table><thead><tr><th>効果がない除外の設定</th><th>効果がある除外の設定</th></tr></thead><tbody><tr><td>一致変数：要求引数値</td><td>一致変数：要求引数値</td></tr><tr><td>演算子： 次の値を含む</td><td>演算子： 次の値を含む</td></tr><tr><td>セレクター： 12 or 34</td><td>セレクター： page</td></tr></tbody></table><table><thead><tr><th>検知内容</th></tr></thead><tbody><tr><td>Matched Data: <strong>#</strong> found within <strong>CookieValue</strong> : <strong>co</strong>: <strong>#aaaa</strong></td></tr></tbody></table><table><thead><tr><th>効果がない除外の設定</th><th>効果がある除外の設定</th></tr></thead><tbody><tr><td>一致変数：要求引数値</td><td>一致変数：要求引数値</td></tr><tr><td>演算子： 次の値を含む</td><td>演算子： 次の値を含む</td></tr><tr><td>セレクター： a or aa</td><td>セレクター： co</td></tr></tbody></table><p>上記の効果がない除外の設定例と効果がある除外の設定例を比較すると、details_data に値で検出された場合、セレクターには検出された値をセレクターに入力すると、除外の効果がありません（例：Header 値がマッチした場合は、セレクターにその Header 値を入力）。</p><p>details_data に値で検出された場合、効果がある除外を作成するためには、検出された値を含んでいる要求本文フィールドの名前をセレクターに入力する必要があります（例：Header 値がマッチした場合は、セレクターにその Header 名を入力）。</p><p>上記の例以外にも、以下のドキュメントには様々な除外例が記載されています。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/web-application-firewall/ag/application-gateway-waf-configuration?tabs=portal">要求属性の例</a></p><p><img src="/blog/network/handle-waf-false-positive/exclusionexamples.png"></p><h2 id="カスタム-ルール"><a href="#カスタム-ルール" class="headerlink" title="カスタム ルール"></a>カスタム ルール</h2><p>カスタム ルールを使用することで、特定のクエリ ストリングが含まれる URI、特定の IP アドレスからのアクセス、または特定のパスへのアクセスを許可することが可能ですが、具体的なルール設定はお客さんに決める必要があります。これらのカスタム ルールは、管理されたルールよりも高い優先順位を持ちます。カスタム ルールによって通信が許可または拒否された場合は、管理されたルールと他の優先度が低いカスタム ルールに評価されないことが想定された動作です。カスタム ルールの設定は、WAF ポリシーの「カスタム ルール」ページで行うことができます。カスタム ルールで設定できるフィールドにつきましては、以下のドキュメントをご参照ください。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/web-application-firewall/ag/custom-waf-rules-overview">Azure Application Gateway の Web アプリケーション ファイアウォール v2 カスタム規則</a></p><h2 id="特定のルールの無効化"><a href="#特定のルールの無効化" class="headerlink" title="特定のルールの無効化"></a>特定のルールの無効化</h2><p>WAF においては、個々のルールを無効化したり、ルールごとに特定のアクションを指定したりすることが可能です。ルールを無効化することで、WAF を介した通信がそのルールに基づいて評価されなくなります。ただし、管理されたルールの中には無効化ができないルールも存在する点にはご注意ください。<br><img src="/blog/network/handle-waf-false-positive/disabledrules.png"></p><h1 id="サポートからの支援"><a href="#サポートからの支援" class="headerlink" title="サポートからの支援"></a>サポートからの支援</h1><p>もしブログに記載されている方法でお客様の誤検知事象が解消されない場合は、サポート窓口にて調査を行うことができます。スムーズに状況を確認するために、WAF にアクセスし、通信がブロックされた際の HAR ファイルなどの基本的な切り分け情報を添付していただくことをお願いします。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/azure-portal/capture-browser-trace">HAR ファイルの取得手順</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;いつもお世話になっております。Azure Networking チームの庄です。&lt;/p&gt;
&lt;p&gt;Web アプリケーションは、SQL インジェクションやクロスサイトスクリプティングなど、既知の脆弱性を悪用した攻撃のターゲットになることが多いです。Application Gat</summary>
      
    
    
    
    
    <category term="Application Gateway" scheme="https://jpaztech.github.io/blog/tags/Application-Gateway/"/>
    
    <category term="WAF" scheme="https://jpaztech.github.io/blog/tags/WAF/"/>
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>オンプレミスからのインターネット宛ての通信を Azure 経由にする方法</title>
    <link href="https://jpaztech.github.io/blog/network/forcetunneling-azure-to-onpre-configuration/"/>
    <id>https://jpaztech.github.io/blog/network/forcetunneling-azure-to-onpre-configuration/</id>
    <published>2024-04-30T06:00:00.000Z</published>
    <updated>2024-07-03T06:47:12.893Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。</p><p>本ブログでは、オンプレミスからのインターネット宛ての通信を Azure 経由にする方法について、ご紹介いたします。</p><span id="more"></span><hr><p>お客様のクラウド利用が進み、オンプレミスとクラウドを組み合わせたハイブリッド クラウド環境が普及してきました。ハイブリッド クラウド環境では、オンプレミスとクラウド間の通信の他に、インターネットへのアクセスをオンプレミス経由、またはクラウド経由にさせたいというご要望をいただくことがあります。</p><p>従来から、お客様のセキュリティポリシーの要件により、Azure からのインターネットへの通信をオンプレミスを経由させて、オンプレミスでセキュリティ対策を実施されることがありました。Azure では、Azure 環境からインターネットへの通信をオンプレミス経由させることを「強制トンネリング（Forced Tunneling）」と呼んでいます。</p><p><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/01.png"></p><p><a href="https://learn.microsoft.com/ja-jp/azure/vpn-gateway/about-site-to-site-tunneling">サイト間構成用の強制トンネリングについて</a></p><p>昨今では、Azure の提供する Azure Firewall や、サードパーティー製のネットワーク仮想アプライアンス（NVA - Network Virtual Appliance）として、多くのセキュリティサービスが提供されています。<br>オンプレミスに設置されていた物理的なセキュリティベンダーの製品が、Azure 上の NVA としても提供されるようになり、従来実施していた同様のセキュリティ対策を Azure 上で実施することも可能になってきました。<br>また、NVA は物理的なデバイスと比べ、スケールアウトを迅速に行いやすいなど、クラウド環境特有のメリットもあります。</p><p>このような背景から、オンプレミスからインターネット接続を Azure を経由させたいというご要望をいただくことが多くなりましたので、本ブログでは概要をご説明します。</p><p><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/02.png"></p><p>まず、オンプレミスから Azure を経由させてインターネットに接続させるには、Azure からオンプレミスのルーターに対してデフォルトルート（0.0.0.0/0）（Azure では「既定のルート」と呼ばれることがあります）をルーティング プロトコルの BGP で広報する必要があります。<br>デフォルトルートを Azure から広報するには、以下の 2 種類の方法が考えられます。</p><p>１）Virtual WAN を利用する<br>２）Azure Route Server と NVA（Network Virtual Appliance - 仮想アプライアンス）を利用する</p><h2 id="1）Virtual-WAN-を利用する"><a href="#1）Virtual-WAN-を利用する" class="headerlink" title="1）Virtual WAN を利用する"></a>1）Virtual WAN を利用する</h2><p>比較的大規模な環境で利用される Virtual WAN では、ハブ アンド スポーク アーキテクチャで、仮想ハブ内に Azure Firewall や、サードパーティ製のセキュリティ用 NVA、または SD-WAN 用 NVA などをデプロイすることができます。<br>Azure Firewall や、これらの NVA からデフォルトルートを広報することにより、ExpressRoute 回線（ER）や Site to Site VPN（S2S VPN）で接続されたオンプレミスからの通信を、Azure を経由してインターネットにアクセスさせることが可能になります。</p><p><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/03.png"></p><p><a href="https://learn.microsoft.com/ja-jp/azure/virtual-wan/virtual-wan-about">Azure Virtual WAN とは</a></p><p>Azure Firewall をすでに Virtual WAN の仮想ハブにデプロイしている場合、インターネット向けの通信を Azure Firewall に向けるためのルーティング ポリシーを設定します。<br>次に、S2S VPN 接続の場合には VPN サイトで「既定のルートを伝達」を有効化させることにより、デフォルトルート（0.0.0.0/0）をオンプレミスに広報します。<br>ER 接続の場合も、同様の「既定のルートを伝達」を有効化させることにより、デフォルトルート（0.0.0.0/0）をオンプレミスに広報します。</p><p>これだけで、オンプレミスは Azure から広報されたデフォルトルート（0.0.0.0/0）を学習し、オンプレミスからインターネットへの通信を Azure 経由にさせることが可能になります。<br>Virtual WAN の場合には、このように簡単にデフォルトルート（0.0.0.0/0）を広報することが可能です。</p><h3 id="インターネット向けのルーティング-ポリシーを設定"><a href="#インターネット向けのルーティング-ポリシーを設定" class="headerlink" title="インターネット向けのルーティング ポリシーを設定"></a>インターネット向けのルーティング ポリシーを設定</h3><p><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/04.png"></p><h3 id="VPN-接続の場合"><a href="#VPN-接続の場合" class="headerlink" title="VPN 接続の場合"></a>VPN 接続の場合</h3><p>「既定のルートを伝達」を有効化<br><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/05.png"></p><h3 id="ExpressRoute-接続の場合"><a href="#ExpressRoute-接続の場合" class="headerlink" title="ExpressRoute 接続の場合"></a>ExpressRoute 接続の場合</h3><p>「既定のルートを伝達」を有効化<br><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/06.png"></p><h2 id="2）Azure-Route-Server-と-NVA（Network-Virtual-Appliance-ネットワーク仮想アプライアンス）を利用する"><a href="#2）Azure-Route-Server-と-NVA（Network-Virtual-Appliance-ネットワーク仮想アプライアンス）を利用する" class="headerlink" title="2）Azure Route Server と NVA（Network Virtual Appliance - ネットワーク仮想アプライアンス）を利用する"></a>2）Azure Route Server と NVA（Network Virtual Appliance - ネットワーク仮想アプライアンス）を利用する</h2><p>Virutal WAN ではなく、仮想ネットワーク（VNet）を利用している場合には、少々複雑にはなってしまいますが、Azure Route Server（RS）とサードパーティー製の NVA を利用して、実現することができます。</p><p>RS は NVA と BGP で経路交換することにより、VNet と NVA の間で経路の学習をすることができます。<br>そのため、RS を利用することで、VNet が NVA から広報されたインターネット向けの経路を学習します。<br>さらに、RS は NVA から広報されたインターネット向けの経路を、仮想ネットワークゲートウェイに対しても広報することができます。<br>これにより、オンプレミスは仮想ネットワークゲートウェイから広報されたインターネット向けの経路を学習することにより、オンプレミスからインターネットへの通信を Azure 経由にさせることが可能になります。<br>また、RS は BGP の経路交換だけに使われるため、実際のトラフィックは RS を通ることはありません。</p><p>ER 回線と Site to Site VPN（S2S VPN）では、Azure でデプロイする仮想ネットワークゲートウェイの種類が異なり、ER GW と VPN GW という 2 種類があります。<br>ER GW と VPN GW は、実装の違いによりオンプレミスへ経路広報ができる経路に違いがあります。<br>そのため、NVA で広報する経路を以下のようにする必要があるので、この点はご注意ください。</p><h3 id="ER-回線"><a href="#ER-回線" class="headerlink" title="ER 回線"></a>ER 回線</h3><p>・デフォルトルート（0.0.0.0/0）を広報する  </p><blockquote><p>[経路広報]<br>オンプレミス &lt;– ER 回線 &lt;– ER GW &lt;–  RS &lt;– NVA（0.0.0.0/0 を広報する）<br>[トラフィックフロー]<br>オンプレミス –&gt; ER 回線 –&gt; ER GW –&gt; NVA –&gt; インターネット</p></blockquote><p><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/07.png"></p><h3 id="Site-to-Site-VPN"><a href="#Site-to-Site-VPN" class="headerlink" title="Site to Site VPN"></a>Site to Site VPN</h3><p>・0.0.0.0/1, 128.0.0.0/1 の２つ経路を広報する<br>※ VPN GW は、オンプレミス向けにはデフォルトルート（0.0.0.0/0）を広報できない実装となっているため</p><blockquote><p>[経路広報]<br>オンプレミス &lt;– Site to Site VPN (S2S VPN) &lt;– VPN GW &lt;–  RS &lt;– NVA (0.0.0.0/1, 128.0.0.0/1 の２つを広報する）<br>[トラフィックフロー]<br>オンプレミス –&gt; Site to Site VPN (S2S VPN) –&gt; VPN GW –&gt; NVA –&gt; インターネット</p></blockquote><p><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/08.png"></p><p>NVA で経路広報をする方法は、NVA の設定方法に依存するため、本ブログでは割愛します。</p><p>NVA で経路広報の設定をしたのち、RS で「ピアの追加」をし「ブランチ間」を有効化することで、<br>オンプレミス – ER GW/VPN GW – RS – NVA 間で経路情報の交換を開始します。<br>これにより、オンプレミスは NVA からインターネット向けの経路を学習し、オンプレミスからインターネットへの通信を、Azure 経由にさせることが可能になります。</p><h3 id="RS-の設定について"><a href="#RS-の設定について" class="headerlink" title="RS の設定について"></a>RS の設定について</h3><p>RS でピアの追加<br><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/09.png"></p><p>RS で「ブランチ間」を有効化</p><p><img src="/blog/network/forcetunneling-azure-to-onpre-configuration/10.png"></p><p>RS と NVA を利用する方法は、NVA の OS 上のスタティックルートを設定したり、NVA の NIC のサブネットにインターネット向けのユーザー定義ルートを設定したりと、実際には複雑な作業が必要となりますので、参考情報に RS と NVA に関する情報を補足しております。</p><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>今回は、オンプレミスからのインターネット宛ての通信を Azure 経由にする方法について、以下の２つの方法をご紹介しました。</p><p>１）Virtual WAN を利用する<br>２）Azure Route Server と NVA（Network Virtual Appliance - 仮想アプライアンス）を利用する</p><p>どちらを選択されるかは、お客様の様々な状況にも依存しますので、適切な方法を選択し事前検証をした上で実際の動作もご確認ください。<br>動作でご不明な点があれば、Azure ポータルより弊社サポートまでお問い合わせください。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;/p&gt;
&lt;p&gt;本ブログでは、オンプレミスからのインターネット宛ての通信を Azure 経由にする方法について、ご紹介いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="ExpressRoute" scheme="https://jpaztech.github.io/blog/tags/ExpressRoute/"/>
    
    <category term="VPN" scheme="https://jpaztech.github.io/blog/tags/VPN/"/>
    
    <category term="Virtual WAN" scheme="https://jpaztech.github.io/blog/tags/Virtual-WAN/"/>
    
  </entry>
  
  <entry>
    <title>VM サイズの選定および変更時の注意点について</title>
    <link href="https://jpaztech.github.io/blog/vm/vm-size-change/"/>
    <id>https://jpaztech.github.io/blog/vm/vm-size-change/</id>
    <published>2024-04-17T06:00:00.000Z</published>
    <updated>2024-07-03T06:47:13.345Z</updated>
    
    <content type="html"><![CDATA[<span id="more"></span><p>こんにちは、Azure テクニカル サポート チームの前田です。<br>Azure テクニカル サポート窓口におきまして、Azure VM のサイズに関するお問い合わせをいただくことがあります。<br>しかしながら、弊サポート窓口にお問い合わせいただいた場合であっても、原則としてサポートより具体的な VM サイズを直接ご提案することは叶わず、最終的にはお客様にご判断いただく必要が生じます。<br>このため、お客様のお手元にて VM サイズの選定にあたり適切な内容をご確認いただけるよう、また変更時のトラブルについて初動対処が可能となるよう、本記事を公開させていただきます。<br>各項目に添付の弊社公開情報と併せまして、少しでもご参考になりましたら幸いに存じます。  </p><h2 id="目次"><a href="#目次" class="headerlink" title="目次  "></a>目次  <!-- omit in toc --></h2><ul><li><a href=".#VM-%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%AE%E9%81%B8%E3%81%B3%E6%96%B9">VM サイズの選び方</a><ul><li><a href=".#%E3%82%B5%E3%82%A4%E3%82%BA%E9%81%B8%E5%AE%9A%E6%99%82%E3%81%AB%E4%B8%80%E8%88%AC%E3%81%AB%E8%80%83%E6%85%AE%E3%81%99%E3%81%B9%E3%81%8D%E9%A0%85%E7%9B%AE">サイズ選定時に一般に考慮すべき項目</a></li><li><a href=".#%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3-%E3%82%BB%E3%83%AC%E3%82%AF%E3%82%BF%E3%83%BC%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">仮想マシン セレクターについて</a></li></ul></li><li><a href=".#VM-%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%AE%E9%81%B8%E6%8A%9E%E3%83%BB%E5%A4%89%E6%9B%B4%E3%81%8C%E3%81%A7%E3%81%8D%E3%81%AA%E3%81%84%E5%A0%B4%E5%90%88%E3%81%AE%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0">VM サイズの選択・変更ができない場合のトラブルシューティング</a><ul><li><a href=".#%E5%BD%93%E8%A9%B2%E3%83%AA%E3%83%BC%E3%82%B8%E3%83%A7%E3%83%B3%E3%80%81%E3%82%BE%E3%83%BC%E3%83%B3%E3%81%AB%E3%81%A6%E5%A4%89%E6%9B%B4%E5%85%88%E3%81%AE%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%8C%E6%8F%90%E4%BE%9B%E3%81%95%E3%82%8C%E3%81%A6%E3%81%84%E3%82%8B%E3%81%8B">当該リージョン、ゾーンにて変更先のサイズが提供されているか</a></li><li><a href=".#%E3%83%AD%E3%83%BC%E3%82%AB%E3%83%AB%E4%B8%80%E6%99%82%E3%83%87%E3%82%A3%E3%82%B9%E3%82%AF%E3%81%AE%E6%9C%89%E7%84%A1">ローカル一時ディスクの有無</a></li><li><a href=".#%E5%89%B2%E3%82%8A%E5%BD%93%E3%81%A6%E8%A7%A3%E9%99%A4%E3%82%92%E8%A1%8C%E3%81%86%E3%81%93%E3%81%A8%E3%81%A7-VM-%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%AE%E9%81%B8%E6%8A%9E%E8%82%A2%E3%81%8C%E5%A2%97%E3%81%88%E3%82%8B%E5%A0%B4%E5%90%88">割り当て解除を行うことで VM サイズの選択肢が増える場合</a></li><li><a href=".#%E5%8F%AF%E7%94%A8%E6%80%A7%E3%82%BB%E3%83%83%E3%83%88%E5%88%A9%E7%94%A8%E6%99%82%E3%81%AE%E6%B3%A8%E6%84%8F">可用性セット利用時の注意</a></li></ul></li><li><a href=".#%E6%B3%A8%E6%84%8F%E4%BA%8B%E9%A0%85">注意事項</a><ul><li><a href=".#%E3%82%AF%E3%82%A9%E3%83%BC%E3%82%BF%E3%81%AE%E4%B8%8D%E8%B6%B3%E3%81%AB%E3%82%88%E3%82%8B-VM-%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%AE%E9%81%B8%E6%8A%9E%E4%B8%8D%E8%83%BD%E4%BA%8B%E4%BE%8B">クォータの不足による VM サイズの選択不能事例</a></li><li><a href=".#%E4%BB%AE%E6%83%B3%E3%83%9E%E3%82%B7%E3%83%B3-%E3%82%B5%E3%82%A4%E3%82%BA%E3%81%AE%E5%A4%89%E6%9B%B4%E3%81%AB%E3%82%88%E3%82%8A%E5%86%8D%E8%B5%B7%E5%8B%95%E3%81%8C%E7%99%BA%E7%94%9F%E3%81%99%E3%82%8B">仮想マシン サイズの変更により再起動が発生する</a></li></ul></li><li><a href=".#%E3%81%8A%E3%82%8F%E3%82%8A%E3%81%AB">おわりに</a></li></ul><h2 id="VM-サイズの選び方"><a href="#VM-サイズの選び方" class="headerlink" title="VM サイズの選び方"></a>VM サイズの選び方</h2><h3 id="サイズ選定時に一般に考慮すべき項目"><a href="#サイズ選定時に一般に考慮すべき項目" class="headerlink" title="サイズ選定時に一般に考慮すべき項目"></a>サイズ選定時に一般に考慮すべき項目</h3><p>まず VM サイズを選定いただくにあたり、一般に考慮すべき項目としては下記内容が挙げられるかと存じます。<br>ご要件によりこの他にも必要な要件があるかと存じますため、一例としてご参考になりましたら幸いでございます。  </p><ul><li>CPU、メモリ、ネットワーク帯域といった基本スペック</li><li>Intel 社、AMD 社の CPU の差異 </li><li>ディスクの最大アタッチ数</li><li>Premium Storage の利用可否</li><li>一時ディスクの有無</li></ul><p>Azure におきましては、CPU 対メモリ比のバランスのとれた汎用サイズの他、メモリ比率の高いメモリの最適化サイズなど、特徴ごとに様々な VM サイズのシリーズをご用意しております。<br>各シリーズの詳細につきましては、下記公開情報にてご紹介しておりますのでご参考ください。  </p><p>ご参考：<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/sizes">VM サイズ - Azure Virtual Machines | Microsoft Learn</a>  </p><hr><h3 id="仮想マシン-セレクターについて"><a href="#仮想マシン-セレクターについて" class="headerlink" title="仮想マシン セレクターについて"></a>仮想マシン セレクターについて</h3><p>ご利用の環境において CPU やメモリの必要な容量などの要件が既に明確な場合、仮想マシン セレクターにてご希望に応じた VM サイズを自動でご提案します。<br>その他、リージョンの指定やプレミアム ストレージの利用可否など、細かな設定が可能ですので、VM サイズの選定の第一歩として有効活用いただければと存じます。  </p><p>ご参考：<a href="https://azure.microsoft.com/ja-jp/pricing/vm-selector/">Microsoft Azure VM セレクター</a>  </p><hr><h2 id="VM-サイズの選択・変更ができない場合のトラブルシューティング"><a href="#VM-サイズの選択・変更ができない場合のトラブルシューティング" class="headerlink" title="VM サイズの選択・変更ができない場合のトラブルシューティング"></a>VM サイズの選択・変更ができない場合のトラブルシューティング</h2><p>続いて、VM サイズの変更ができない場合のトラブルシューティングについてご紹介します。</p><h3 id="当該リージョン、ゾーンにて変更先のサイズが提供されているか"><a href="#当該リージョン、ゾーンにて変更先のサイズが提供されているか" class="headerlink" title="当該リージョン、ゾーンにて変更先のサイズが提供されているか"></a>当該リージョン、ゾーンにて変更先のサイズが提供されているか</h3><p>GPU 搭載の VM サイズや、提供開始が比較的直近の VM サイズをご利用いただく場合、ご利用可能なリージョンや可用性ゾーンに制限が生じている場合があります。<br>リージョンおよび可用性ゾーンそれぞれの制限につきましては、下記の手順にてご確認いただくことが可能です。</p><ul><li>各リージョンでの提供状況<br>下記公開情報内「製品」項目にて「Virtual Machines」を検索いただき、「リージョン」にてご利用予定のリージョンをご選択ください。</li></ul><p>ご参考：<a href="https://azure.microsoft.com/ja-jp/explore/global-infrastructure/products-by-region/?products=virtual-machines">リージョン別の Azure 製品 | Microsoft Azure</a></p><ul><li>各可用性ゾーンでの提供状況<br>各可用性ゾーンでの VM サイズのご提供状況につきましては、VM をご利用いただくサブスクリプションにて、下記コマンド例をご参考に Azure CLI または Azure PowerShell コマンドよりご確認ください。<br>なお、各可用性ゾーンでのご提供状況につきましては、サブスクリプションごとにご確認いただく必要がございます点、ご留意のほどお願いいたします。  </li></ul><p>JapanEast リージョンでの確認コマンド例<br>Azure CLI の場合：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm list-skus --location japaneast --output table  </span><br></pre></td></tr></table></figure><p>Azure PowerShell の場合：</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Get-AzComputeResourceSku | where &#123;$_.Locations.Contains(&quot;japaneast&quot;)&#125;;  </span><br></pre></td></tr></table></figure><p>出力例について、一部表記が異なりますが概ね同じ内容となるため、統合してご紹介いたします。  </p><p>出力例：  </p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ResourceType      Locations    Name                      Zones    Restrictions</span><br><span class="line">----------------  -----------  ------------------------  -------  ------------</span><br><span class="line">virtualMachines   japaneast    Standard_D2s_v5           <span class="number">1</span>,<span class="number">2</span>,<span class="number">3</span>    None</span><br></pre></td></tr></table></figure><p>下記例の場合、Japan East リージョンの Standard_B16as_v2 サイズは、当該サブスクリプションにて、可用性ゾーン 1,2 で提供されている状況となります。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ResourceType      Locations    Name                      Zones    Restrictions</span><br><span class="line">----------------  -----------  ------------------------  -------  ------------</span><br><span class="line">virtualMachines   japaneast    Standard_B16as_v2         <span class="number">1</span>,<span class="number">2</span>      None</span><br></pre></td></tr></table></figure><p>なお、Restrictions として何からの制限が記載されていることもございます。 </p><p>ご参考：<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/linux/create-cli-availability-zone#check-vm-sku-availability">Azure CLI を使用してゾーン VM を作成する - Azure Virtual Machines | Microsoft Learn</a><br>ご参考：<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/create-powershell-availability-zone#check-vm-sku-availability">Azure PowerShell を使用したゾーン VM の作成 - Azure Virtual Machines | Microsoft Learn</a>  </p><hr><h3 id="ローカル一時ディスクの有無"><a href="#ローカル一時ディスクの有無" class="headerlink" title="ローカル一時ディスクの有無"></a>ローカル一時ディスクの有無</h3><p>ローカル一時ディスクの有無が異なるサイズへ変更する場合、VM の再作成が必要となります。<br>ゲスト OS 上での事前作業等が必要となりますので、詳細な手順につきましては下記の公式ドキュメントをご参照ください。  </p><p>ご参考：<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/azure-vms-no-temp-disk">FAQ - ローカル一時ディスクを持たない Azure VM のサイズ - Azure Virtual Machines | Microsoft Learn</a>  </p><hr><h3 id="割り当て解除を行うことで-VM-サイズの選択肢が増える場合"><a href="#割り当て解除を行うことで-VM-サイズの選択肢が増える場合" class="headerlink" title="割り当て解除を行うことで VM サイズの選択肢が増える場合"></a>割り当て解除を行うことで VM サイズの選択肢が増える場合</h3><p>シリーズ違いなど大きく異なる VM サイズへの変更を行う際、割り当て解除を行うことで Azure Portal から確認可能な変更先の VM サイズの種類が増える場合があります。<br>これは仮想マシンが割り当てられる物理ホストごとに利用可能な VM サイズが決まっていることから、この制限を撤廃する割り当て解除を実施することで選択肢が増えるものとなります。<br>リージョン・可用性ゾーンでの提供、および後述のクォータ等に問題がないにもかかわらず変更先の VM サイズが表示されない場合、VM の割り当て解除をご検討ください。  </p><hr><h3 id="可用性セット利用時の注意"><a href="#可用性セット利用時の注意" class="headerlink" title="可用性セット利用時の注意"></a>可用性セット利用時の注意</h3><p>可用性セットをご利用の場合、通常の VM と比較し VM の割り当てを行う物理ホストに一定の制限が生じますため、サイズ変更の際に割り当てのエラーが発生する場合があります。<br>当該事象の発生時には、可用性セットに含まれる全ての VM を割り当て解除いただくことで、より最適な物理ホストへの配置が可能となりますので、お試しください。  </p><p>ご参考：<a href="https://learn.microsoft.com/ja-jp/troubleshoot/azure/virtual-machines/allocation-failure">Azure VM の割り当てエラーのトラブルシューティング - Virtual Machines | Microsoft Learn</a>  </p><hr><h2 id="注意事項"><a href="#注意事項" class="headerlink" title="注意事項"></a>注意事項</h2><h3 id="クォータの不足による-VM-サイズの選択不能事例"><a href="#クォータの不足による-VM-サイズの選択不能事例" class="headerlink" title="クォータの不足による VM サイズの選択不能事例"></a>クォータの不足による VM サイズの選択不能事例</h3><p>Azure のサブスクリプションでは各機能に対しクォータに制限があり、VM サイズにも同様にクォータが設定されています。<br>Azure Portal 上で仮想マシンの作成時や変更時に VM サイズの選択を行う際、下記画面例のように「クォータの要求」が表示される場合、当該サブスクリプションにて適切なカテゴリでのクォータの引き上げが必要となります。  </p><p>画面例：<br><img src="/blog/vm/vm-size-change/vm-size-change001.png" alt="vm-size-change001"></p><p>特に、GPU を利用する VM サイズでは、クォータに制限が生じている場合が散見されますので、ご注意いただければと存じます。<br>下記公開情報をご参考に、事象に該当する場合はクォータの引き上げについてもご検討いただけますと幸いです。  </p><p>ご参考：<a href="https://learn.microsoft.com/ja-jp/azure/quotas/per-vm-quota-requests">VM ファミリの vCPU クォータの増加 - Azure Quotas | Microsoft Learn</a>  </p><hr><h3 id="仮想マシン-サイズの変更により再起動が発生する"><a href="#仮想マシン-サイズの変更により再起動が発生する" class="headerlink" title="仮想マシン サイズの変更により再起動が発生する"></a>仮想マシン サイズの変更により再起動が発生する</h3><p>仮想マシン サイズの変更時は、いずれのサイズの場合であっても再起動が発生します。<br>現時点での仕様としてご理解いただき、ユーザー影響の少ない時間帯での実施をご検討いただきますようお願いいたします。  </p><p>ご参考：<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/resize-vm?tabs=portal">仮想マシンのサイズ変更 - Azure Virtual Machines | Microsoft Learn</a>  </p><hr><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>VM サイズの選定・変更に際し、弊サポートへよくお問い合わせいただく事例をご紹介いたしました。<br>Azure VM では VM サイズの変更が容易でございますので、VM サイズの選定の際はお手元にて負荷テスト等を検証の上でご判断をいただければと存じます。<br>お手元での VM サイズの選定に際し、本記事の内容がご参考となりましたら幸いでございます。  </p>]]></content>
    
    
      
      
    <summary type="html">&lt;span id=&quot;more&quot;&gt;&lt;/span&gt;

&lt;p&gt;こんにちは、Azure テクニカル サポート チームの前田です。&lt;br&gt;Azure テクニカル サポート窓口におきまして、Azure VM のサイズに関するお問い合わせをいただくことがあります。&lt;br&gt;しかしながら、弊サポー</summary>
      
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>Azure Front Door (クラシック) のリタイアについて</title>
    <link href="https://jpaztech.github.io/blog/network/afd-classic-retire/"/>
    <id>https://jpaztech.github.io/blog/network/afd-classic-retire/</id>
    <published>2024-03-29T12:00:00.000Z</published>
    <updated>2024-07-03T06:47:12.861Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure テクニカル サポート チームの石原です。</p><p>本ブログでは、Azure Front Door (クラシック) のリタイアのアナウンスと Azure Front Door Standard 及び Premium への移行方法に関する情報をご案内致します (以降は Azure Front Door を AFD と記載致します)。</p><span id="more"></span><hr><h2 id="AFD-クラシック-のリタイアについて"><a href="#AFD-クラシック-のリタイアについて" class="headerlink" title="AFD (クラシック) のリタイアについて"></a>AFD (クラシック) のリタイアについて</h2><p>2027 年 3 月 31 日に AFD (クラシック) の提供が終了し、AFD (クラシック) に対するサポートも終了します。<br>提供終了までの間は既存の AFD (クラシック) の設定を変更することは可能ですが、2025 年 4 月 1 日以降は Azure ポータル、Terraform、Azure PowerShell や Azure CLI などを使用して新しい AFD (クラシック) リソースが作成できなくなります。<br>アナウンス内容につきましては、下記の URL に記載がございますので、ご参考になれば幸いです。</p><p><a href="https://azure.microsoft.com/ja-jp/updates/azure-front-door-classic-will-be-retired-on-31-march-2027/">Azure Front Door (classic) will be retired on 31 March 2027</a></p><h2 id="AFD-クラシック-のリタイアに関する-FAQ"><a href="#AFD-クラシック-のリタイアに関する-FAQ" class="headerlink" title="AFD (クラシック) のリタイアに関する FAQ"></a>AFD (クラシック) のリタイアに関する FAQ</h2><p>AFD (クラシック) のリタイアに関するよくある質問につきましては、下記の URL に記載がございますので、ご参考になれば幸いです。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/frontdoor/classic-retirement-faq">Azure Front Door (classic) retirement FAQ</a></p><h2 id="AFD-クラシック-から-AFD-Standard-Premium-への移行方法について"><a href="#AFD-クラシック-から-AFD-Standard-Premium-への移行方法について" class="headerlink" title="AFD (クラシック) から AFD Standard/Premium への移行方法について"></a>AFD (クラシック) から AFD Standard/Premium への移行方法について</h2><p>AFD (クラシック) の提供が終了する 2027 年 3 月 31 日までに、事前にお客様にて AFD Standard/Premium へ移行する必要がございます。<br>AFD (クラシック) から AFD Standard/Premium にゼロ ダウンタイムで移行するプロセスや手順に関しましては、下記の URL に記載がございますので、ご参考になれば幸いです。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/frontdoor/migrate-tier">Azure Front Door (クラシック) から Standard/Premium に移行する</a></p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azure テクニカル サポート チームの石原です。&lt;/p&gt;
&lt;p&gt;本ブログでは、Azure Front Door (クラシック) のリタイアのアナウンスと Azure Front Door Standard 及び Premium への移行方法に関する情報をご案内致します (以降は Azure Front Door を AFD と記載致します)。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="AzureFrontDoor" scheme="https://jpaztech.github.io/blog/tags/AzureFrontDoor/"/>
    
  </entry>
  
  <entry>
    <title>ExpressRoute にデフォルトルートを広報していてオンプレミス以外とも通信したい場合の構成</title>
    <link href="https://jpaztech.github.io/blog/network/expressroute-forced-tunneling-routing/"/>
    <id>https://jpaztech.github.io/blog/network/expressroute-forced-tunneling-routing/</id>
    <published>2024-03-29T06:00:00.000Z</published>
    <updated>2024-07-03T06:47:12.885Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの角田です。<br>オンプレミスから ExpressRoute 経由で デフォルトルート (0.0.0.0/0) を広報している場合に、特定のサブネットからオンプレミスに通信させたくない場合や、オンプレミス以外にも通信させたい要件があるかと存じます。<br>今回は、その様な要件を解決する方法をご紹介します。 </p><span id="more"></span><hr><h2 id="想定シナリオ"><a href="#想定シナリオ" class="headerlink" title="想定シナリオ"></a>想定シナリオ</h2><p>以下 3 パターンのシナリオについてご紹介します。<br>全てオンプレミスからデフォルトルートを広報されている構成 (Azure では強制トンネリング構成とも呼称) を前提としており、いずれも対象のサブネットにルートテーブルリソースを関連付けて解決します。 </p><ul><li>シナリオ 1. 特定のサブネットからオンプレミスに対して通信させたくない場合 </li><li>シナリオ 2. 基本的にはオンプレミスと通信するが、一部の宛先だけインターネットと通信したい場合 </li><li>シナリオ 3. 基本的にはインターネットと通信するが、一部の宛先だけオンプレミスと通信したい場合 </li></ul><p>以下それぞれ記載いたします。</p><h3 id="シナリオ-1-特定のサブネットからオンプレミスに対して通信させたくない場合"><a href="#シナリオ-1-特定のサブネットからオンプレミスに対して通信させたくない場合" class="headerlink" title="シナリオ 1. 特定のサブネットからオンプレミスに対して通信させたくない場合"></a>シナリオ 1. 特定のサブネットからオンプレミスに対して通信させたくない場合</h3><p>ルートテーブルリソースでは、「ゲートウェイのルートを伝達する」というオプションがございます。<br>このオプションが無効の場合、Gateway から対象のサブネットへのルート伝達を停止することが可能となります。<br>ルート伝達を停止することで、対象のサブネットから オンプレミスに対して通信不能とさせることが可能です。 </p><p><img src="/blog/network/expressroute-forced-tunneling-routing/scenario1.png" alt="scenario1"></p><p>本設定は UDR の構成ページにございますので、「いいえ」をご選択ください。</p><p><img src="/blog/network/expressroute-forced-tunneling-routing/scenario1-config.png" alt="scenario1-config"></p><h3 id="シナリオ-2-基本的にはオンプレミスと通信するが、一部の宛先だけインターネットと通信したい場合"><a href="#シナリオ-2-基本的にはオンプレミスと通信するが、一部の宛先だけインターネットと通信したい場合" class="headerlink" title="シナリオ 2. 基本的にはオンプレミスと通信するが、一部の宛先だけインターネットと通信したい場合"></a>シナリオ 2. 基本的にはオンプレミスと通信するが、一部の宛先だけインターネットと通信したい場合</h3><p>Azure ではルーティングの優先順位付けにロンゲストマッチを利用しておりますので、より詳細な経路を学習している場合は、そちらを優先する動作となります。<br>例えば 203.0.113.0/24 に対する経路を 直接インターネットに通信したい場合、ルートテーブルリソースにて 203.0.113.0/24 のユーザー定義ルート (以下 UDR) を記載することで、直接インターネットと通信することが可能です。 </p><blockquote><p>注意<br>仮想マシンがインターネットと通信する場合、<br>インターネットと通信する手段をサブネット内の仮想マシンが持つ必要がございます。<br>詳しくは下記をご参照ください。<br><a href="https://jpaztech.github.io/blog/network/snat-options-for-azure-vm/">Azure VM の送信接続 (SNAT) オプション まとめ | Japan Azure IaaS Core Support Blog</a></p></blockquote><p>下図では、仮想マシンに パブリック IP リソースを持たせた際の動作となります。</p><p><img src="/blog/network/expressroute-forced-tunneling-routing/scenario2.png" alt="scenario2"></p><p>ルートの追加はルートテーブルリソースのルートページにございますので、「追加」を押下して追加ください。</p><p><img src="/blog/network/expressroute-forced-tunneling-routing/scenario2-config.png" alt="scenario2-config"></p><h3 id="シナリオ-3-基本的にはインターネットと通信するが、一部の宛先だけオンプレミスと通信したい場合"><a href="#シナリオ-3-基本的にはインターネットと通信するが、一部の宛先だけオンプレミスと通信したい場合" class="headerlink" title="シナリオ 3. 基本的にはインターネットと通信するが、一部の宛先だけオンプレミスと通信したい場合"></a>シナリオ 3. 基本的にはインターネットと通信するが、一部の宛先だけオンプレミスと通信したい場合</h3><p>Azure では、同一のアドレスプレフィックスを複数の方法で学習している場合、BGP で学習したルートよりも UDR で記載したルートを優先する動作となります。 (参考 1 )<br>そのため UDR にて宛先をインターネットとしたデフォルトルートを記載した場合、すべてのトラフィックがインターネットに転送され、オンプレミスに対して通信することができない状態となります。<br>この状態で オンプレミスに対して通信させたい場合、対象のアドレスプレフィックスをオンプレミスより広報いただくことで、ロンゲストマッチによりルートが優先され、通信可能となります。<br>例えば 192.168.254.0/24 の宛先についてオンプレミスと通信したい場合、デフォルトルートに加えて 192.168.254.0/24 のルートを広報いただくことで、192.168.254.0/24 宛のトラフィックをオンプレミスに対して通信することが可能となります。</p><p><img src="/blog/network/expressroute-forced-tunneling-routing/scenario3.png" alt="scenario3"></p><blockquote><p>注意<br>UDR で特定の経路のネクストホップを[仮想ネットワーク ゲートウェイ]に設定し、オンプレミスと通信させることはできません。<br>ExpressRoute ゲートウェイをネクストホップとして設定することをサポートしていないためです。 (参考 2 )<br>このシナリオを解決する場合は、当該経路を BGP 経由で広報頂けますようお願いいたします。</p></blockquote><h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p>1.) <a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-udr-overview#how-azure-selects-a-route">Azure 仮想ネットワーク トラフィックのルーティング | Microsoft Learn</a></p><blockquote><p>Azure がルートを選択するしくみ<br>送信トラフィックがサブネットから送信されると、Azure は最長プレフィックス一致アルゴリズムを使用して、宛先 IP アドレスに基づいてルートを選択します。<br>たとえば、ルート テーブルに 2 つのルートがあるとします。<br>一方のルートではアドレス プレフィックス 10.0.0.0/24 を指定し、もう一方のルートではアドレス プレフィックス 10.0.0.0/16 を指定しています。<br>Azure は、10.0.0.5 宛てのトラフィックを、10.0.0.0/24 アドレス プレフィックスを使用してルートで指定されたネクスト ホップの種類に転送します。<br>このプロセスが発生するのは、10.0.0.5 が両方のアドレス プレフィックスに含まれている場合でも、10.0.0.0/24 が 10.0.0.0/16 よりも長いプレフィックスであるためです。<br>Azure は、10.0.1.5 宛てのトラフィックを、10.0.0.0/16 アドレス プレフィックスを使用してルートで指定されたネクストホップの種類に転送します。<br>このプロセスが発生するのは、10.0.1.5 が 10.0.0.0/24 アドレス プレフィックスに含まれておらず、10.0.0.0/16 アドレス プレフィックスを持つルートが一致する最長プレフィックスであるためです。<br>複数のルートに同じアドレス プレフィックスが含まれている場合は、次の優先順位に基づいてルートの種類が選択されます。</p><p>1.ユーザー定義のルート<br>2.BGP のルート<br>3.システム ルート </p></blockquote><p>2.) <a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-udr-overview#custom-routes">Azure 仮想ネットワーク トラフィックのルーティング | Microsoft Learn</a></p><blockquote><p>ユーザー定義ルートを作成するときは、次のネクストホップの種類を指定できます。<br>(中略)<br>[仮想ネットワーク ゲートウェイ] :<br>特定のアドレス プレフィックス宛てのトラフィックを仮想ネットワーク ゲートウェイにルーティングする場合に指定します。<br>種類が VPN の仮想ネットワーク ゲートウェイを作成する必要があります。<br>ExpressRoute ではカスタム ルートに BGP を使用する必要があるため、種類を ExpressRoute として作成された仮想ネットワーク ゲートウェイをユーザー定義ルートで指定することはできません。<br>VPN 接続と ExpressRoute 接続が共存している場合、仮想ネットワーク ゲートウェイは指定できません。 </p></blockquote><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの角田です。&lt;br&gt;オンプレミスから ExpressRoute 経由で デフォルトルート (0.0.0.0/0) を広報している場合に、特定のサブネットからオンプレミスに通信させたくない場合や、オンプレミス以外にも通信させたい要件があるかと存じます。&lt;br&gt;今回は、その様な要件を解決する方法をご紹介します。 &lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="ExpressRoute" scheme="https://jpaztech.github.io/blog/tags/ExpressRoute/"/>
    
  </entry>
  
  <entry>
    <title>VM イメージ バージョンを指定して VM を作成する方法について</title>
    <link href="https://jpaztech.github.io/blog/vm/create-vm-specific-version/"/>
    <id>https://jpaztech.github.io/blog/vm/create-vm-specific-version/</id>
    <published>2024-03-28T03:00:00.000Z</published>
    <updated>2024-07-03T06:47:13.045Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azureサポートチームです。<br>この記事では、VM イメージ バージョンを指定して VM を作成する方法についてご紹介します。</p><span id="more"></span><p>通常、Marketplace から VM を作成すると、最新のバージョン (latest) が既定で作成されます。</p><p>ここで Azure Marketplace の Windows Server イメージを例にとると、以下のドキュメントに示す通り毎月最新のパッチがリリースされていることを確認いただくことができます。</p><ul><li><a href="https://support.microsoft.com/ja-jp/topic/windows-server-release-on-azure-marketplace-update-history-6dbc5136-db53-6c5d-61f6-da370e2fa68c">Windows Server release on Azure Marketplace update history - Microsoft サポート</a></li></ul><p>通常、最新のセキュリティパッチが適用されたイメージをご利用いただくことが一般的かと存じます。しかし、お客様によっては何らかの理由により最新のセキュリティ更新プログラムが適用されていない VM を作成する必要がある場合もあるかと存じます。<br>そのような場合には、VM イメージ バージョンを指定して VM をデプロイすることができます。</p><p>例えば、2023 年 10 月時点の Windows Server バージョン 2022 のイメージをデプロイする場合は「<a href="https://support.microsoft.com/ja-jp/topic/2023-%E5%B9%B4-10-%E6%9C%88%E3%81%AE-windows-server-%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8-cb930aa9-4609-48f4-90b2-13767a0f9dcd">2023 年 10 月の Windows Server イメージ - Microsoft サポート</a>」に記載されているバージョン「20348.2031.231006」を指定して VM を作成するという手順となります。<br>本記事では、VM 作成時にイメージ バージョンを指定する手順について説明します。</p><hr><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>下記手順にそって VM イメージ バージョンを指定し、VM をデプロイします。</p><h3 id="大まかな流れ"><a href="#大まかな流れ" class="headerlink" title="大まかな流れ"></a>大まかな流れ</h3><ol><li>イメージを検索する<br> 1-1. Azure CLI を使用して VM イメージを検索する<br> 1-2. PowerShell を使用して VM イメージを検索する</li><li>Azure Portal より ARM テンプレートを用意する</li><li>VM バージョンを指定する</li><li>VM をデプロイする</li><li>指定したバージョンで作成できたかを確認する</li></ol><h2 id="実際の手順"><a href="#実際の手順" class="headerlink" title="実際の手順"></a>実際の手順</h2><p>それでは、上記の大まかな流れに沿って実際の手順をやってみましょう。</p><hr><h3 id="1-VM-イメージを検索する"><a href="#1-VM-イメージを検索する" class="headerlink" title="1. VM イメージを検索する"></a>1. VM イメージを検索する</h3><p>この項では、必要なバージョンの VM イメージを検索する手順について説明します。最新のバージョンでない VM イメージは、Azure Marketplace からは検索できず、 Azure CLI または PowerShell を使用して検索する必要があります。</p><p>VM イメージを検索するには、次の 4 つの属性を指定する必要があります。</p><table><thead><tr><th>属性</th><th>意味</th><th>説明</th><th>例</th></tr></thead><tbody><tr><td>Publisher</td><td>発行元</td><td>イメージを作成した組織</td><td>Canonical、MicrosoftWindowsServer</td></tr><tr><td>Offer</td><td>プラン</td><td>発行元によって作成された関連するイメージのグループ名</td><td>UbuntuServer、WindowsServer</td></tr><tr><td>Sku</td><td>SKU</td><td>ディストリビューションのメジャー リリースなど、<br>プランのインスタンス</td><td>18.04-LTS、2019-Datacenter</td></tr><tr><td>Version</td><td>バージョン</td><td>イメージの SKU のバージョン番号</td><td>20348.2031.231006、latest</td></tr></tbody></table><p>この記事では、次の属性の例に基づいて東日本リージョンから <a href="https://support.microsoft.com/ja-jp/topic/2023-%E5%B9%B4-10-%E6%9C%88%E3%81%AE-windows-server-%E3%82%A4%E3%83%A1%E3%83%BC%E3%82%B8-cb930aa9-4609-48f4-90b2-13767a0f9dcd">2023 年 10 月の Windows Server イメージ</a>を検索し、VM をデプロイします。</p><table><thead><tr><th>属性</th><th>意味</th><th>後述の検索の結果、今回利用する値</th></tr></thead><tbody><tr><td>Publisher</td><td>発行元</td><td>MicrosoftWindowsServer</td></tr><tr><td>Offer</td><td>プラン</td><td>WindowsServer</td></tr><tr><td>Sku</td><td>SKU</td><td>2022-datacenter-azure-edition</td></tr><tr><td>Version</td><td>バージョン</td><td>20348.2031.231006</td></tr></tbody></table><hr><h4 id="1-1-Azure-CLI-を使用して-VM-イメージを検索する"><a href="#1-1-Azure-CLI-を使用して-VM-イメージを検索する" class="headerlink" title="1-1. Azure CLI を使用して VM イメージを検索する"></a>1-1. Azure CLI を使用して VM イメージを検索する</h4><p>基本的には、「<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/linux/cli-ps-findimage">Azure CLI を使用して Azure Marketplace イメージ情報を検索する</a>」のドキュメントにある通りの手順で検索します。</p><hr><h5 id="1-Publisher-を指定して、Offer-を一覧表示します。"><a href="#1-Publisher-を指定して、Offer-を一覧表示します。" class="headerlink" title="1. Publisher を指定して、Offer を一覧表示します。"></a>1. Publisher を指定して、Offer を一覧表示します。</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm image list-offers --location &lt;リージョン&gt; --publisher &lt;発行元&gt; --output table</span><br></pre></td></tr></table></figure><p>コマンド実行例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm image list-offers --location japaneast --publisher MicrosoftWindowsServer --output table</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果です。指定した Publisher 内の Offer の一覧が表示されました。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Location    Name</span><br><span class="line">----------  ----------------------------------------</span><br><span class="line">japaneast   19h1gen2servertest</span><br><span class="line">japaneast   microsoftserveroperatingsystems-previews</span><br><span class="line">japaneast   servertesting</span><br><span class="line">japaneast   windows-cvm</span><br><span class="line">japaneast   WindowsServer</span><br><span class="line">japaneast   windowsserver-gen2preview</span><br><span class="line">japaneast   windowsserver-previewtest</span><br><span class="line">japaneast   windowsserverdotnet</span><br><span class="line">japaneast   windowsserverhotpatch-previews</span><br><span class="line">japaneast   WindowsServerSemiAnnual</span><br><span class="line">japaneast   windowsserverupgrade</span><br></pre></td></tr></table></figure><p>次に、確認した Offer を指定してその Offer 内の Sku の一覧を表示します。</p><hr><h5 id="2-Publisher、Offer-を指定して、Sku-を一覧表示します。"><a href="#2-Publisher、Offer-を指定して、Sku-を一覧表示します。" class="headerlink" title="2. Publisher、Offer を指定して、Sku を一覧表示します。"></a>2. Publisher、Offer を指定して、Sku を一覧表示します。</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm image list-skus --location &lt;リージョン&gt; --publisher &lt;発行元&gt; --offer &lt;プラン&gt; --output table</span><br></pre></td></tr></table></figure><p>コマンド実行例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm image list-skus --location japaneast --publisher MicrosoftWindowsServer --offer WindowsServer --output table</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果の一部です。指定した Offer 内の Sku の一覧が表示されました。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">Location    Name</span><br><span class="line">----------  -------------------------------------------------</span><br><span class="line">(略)</span><br><span class="line"> </span><br><span class="line">japaneast   2022-datacenter</span><br><span class="line">japaneast   2022-datacenter-azure-edition</span><br><span class="line">japaneast   2022-datacenter-azure-edition-core</span><br><span class="line">japaneast   2022-datacenter-azure-edition-core-smalldisk</span><br><span class="line">japaneast   2022-datacenter-azure-edition-hotpatch</span><br><span class="line">japaneast   2022-datacenter-azure-edition-hotpatch-smalldisk</span><br><span class="line">japaneast   2022-datacenter-azure-edition-smalldisk</span><br><span class="line">japaneast   2022-datacenter-core</span><br><span class="line">japaneast   2022-datacenter-core-g2</span><br><span class="line">japaneast   2022-datacenter-core-smalldisk</span><br><span class="line">japaneast   2022-datacenter-core-smalldisk-g2</span><br><span class="line">japaneast   2022-datacenter-g2</span><br><span class="line"> </span><br><span class="line">(略)</span><br></pre></td></tr></table></figure><p>東日本リージョンに 2022-datacenter-azure-edition の Sku が存在することが確認できたので、次に、その Sku を指定して、Sku 内の Version を一覧表示します。</p><hr><h5 id="3-Publisher、Offer、Sku-を指定して、Version-を一覧表示します。"><a href="#3-Publisher、Offer、Sku-を指定して、Version-を一覧表示します。" class="headerlink" title="3. Publisher、Offer、Sku を指定して、Version を一覧表示します。"></a>3. Publisher、Offer、Sku を指定して、Version を一覧表示します。</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm image list --location &lt;リージョン&gt; --publisher &lt;発行元&gt; --offer &lt;プラン&gt; --sku &lt;SKU&gt; --all --output table</span><br></pre></td></tr></table></figure><p>コマンド実行例：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">az vm image list --location japaneast --publisher MicrosoftWindowsServer --offer WindowsServer --sku 2022-datacenter-azure-edition --all --output table</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果の一部です。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Architecture    Offer          Publisher               Sku                               Urn                                                                                      Version</span><br><span class="line">--------------  -------------  ----------------------  --------------------------------  ---------------------------------------------------------------------------------------  -----------------</span><br><span class="line">x64             WindowsServer  MicrosoftWindowsServer  2022-datacenter-azure-edition     MicrosoftWindowsServer:WindowsServer:2022-datacenter-azure-edition:20348.1970.230905     20348.1970.230905</span><br><span class="line">x64             WindowsServer  MicrosoftWindowsServer  2022-datacenter-azure-edition     MicrosoftWindowsServer:WindowsServer:2022-datacenter-azure-edition:20348.2031.231006     20348.2031.231006</span><br><span class="line">x64             WindowsServer  MicrosoftWindowsServer  2022-datacenter-azure-edition     MicrosoftWindowsServer:WindowsServer:2022-datacenter-azure-edition:20348.2113.231109     20348.2113.231109</span><br><span class="line">x64             WindowsServer  MicrosoftWindowsServer  2022-datacenter-azure-edition     MicrosoftWindowsServer:WindowsServer:2022-datacenter-azure-edition:20348.2159.231202     20348.2159.231202</span><br><span class="line">(略)</span><br></pre></td></tr></table></figure><p>Version 20348.2031.231006 のイメージが存在することが確認できたので、次に VM をデプロイします。「2. Azure Portal より ARM テンプレートを用意する」以降の手順を実施します。</p><hr><h4 id="1-2-PowerShell-を使用して-VM-イメージを検索する"><a href="#1-2-PowerShell-を使用して-VM-イメージを検索する" class="headerlink" title="1-2. PowerShell を使用して VM イメージを検索する"></a>1-2. PowerShell を使用して VM イメージを検索する</h4><p>基本的には、「<a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/cli-ps-findimage#list-image">Azure PowerShell を使用して Azure Marketplace VM イメージを検索して使用する</a>」のドキュメントにある通りの手順で検索します。</p><hr><h5 id="1-Publisher-を指定して、Offer-を一覧表示します。-1"><a href="#1-Publisher-を指定して、Offer-を一覧表示します。-1" class="headerlink" title="1. Publisher を指定して、Offer を一覧表示します。"></a>1. Publisher を指定して、Offer を一覧表示します。</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$locName=&quot;japaneast&quot;</span><br><span class="line">$pubName=&quot;MicrosoftWindowsServer&quot;</span><br><span class="line">Get-AzVMImageOffer -Location $locName -PublisherName $pubName | Select Offer</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果です。指定した Publisher  内の Offer の一覧が表示されました。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">Offer</span><br><span class="line">-----</span><br><span class="line">19h1gen2servertest</span><br><span class="line">microsoftserveroperatingsystems-previews</span><br><span class="line">servertesting</span><br><span class="line">windows-cvm</span><br><span class="line">WindowsServer</span><br><span class="line">windowsserver-gen2preview</span><br><span class="line">windowsserver-previewtest</span><br><span class="line">windowsserverdotnet</span><br><span class="line">windowsserverhotpatch-previews</span><br><span class="line">WindowsServerSemiAnnual</span><br><span class="line">windowsserverupgrade</span><br></pre></td></tr></table></figure><p>次に、確認した Offer を指定してその Offer 内の Sku の一覧を表示します。</p><hr><h5 id="2-Publisher、Offer-を指定して、Sku-を一覧表示します。-1"><a href="#2-Publisher、Offer-を指定して、Sku-を一覧表示します。-1" class="headerlink" title="2. Publisher、Offer を指定して、Sku を一覧表示します。"></a>2. Publisher、Offer を指定して、Sku を一覧表示します。</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$offerName=&quot;WindowsServer&quot;</span><br><span class="line">Get-AzVMImageSku -Location $locName -PublisherName $pubName -Offer $offerName | Select Skus</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果の一部です。指定した Offer 内の Sku の一覧が表示されました。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">Skus</span><br><span class="line">----</span><br><span class="line">(略)</span><br><span class="line">2022-datacenter</span><br><span class="line">2022-datacenter-azure-edition</span><br><span class="line">2022-datacenter-azure-edition-core</span><br><span class="line">2022-datacenter-azure-edition-core-smalldisk</span><br><span class="line">2022-datacenter-azure-edition-hotpatch</span><br><span class="line">2022-datacenter-azure-edition-hotpatch-smalldisk</span><br><span class="line">2022-datacenter-azure-edition-smalldisk</span><br><span class="line">2022-datacenter-core</span><br><span class="line">2022-datacenter-core-g2</span><br><span class="line">2022-datacenter-core-smalldisk</span><br><span class="line">2022-datacenter-core-smalldisk-g2</span><br><span class="line">2022-datacenter-g2</span><br><span class="line">2022-datacenter-smalldisk</span><br><span class="line">2022-datacenter-smalldisk-g2</span><br></pre></td></tr></table></figure><p>東日本リージョンに 2022-datacenter-azure-edition の Sku が存在することが確認できたので、次に、その Sku を指定して、Sku 内の Version を一覧表示します。</p><hr><h5 id="3-Publisher、Offer、Sku-を指定して、Versionを一覧表示します。"><a href="#3-Publisher、Offer、Sku-を指定して、Versionを一覧表示します。" class="headerlink" title="3. Publisher、Offer、Sku を指定して、Versionを一覧表示します。"></a>3. Publisher、Offer、Sku を指定して、Versionを一覧表示します。</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$skuName=&quot;2022-datacenter-azure-edition&quot;</span><br><span class="line">Get-AzVMImage -Location $locName -PublisherName $pubName -Offer $offerName -Sku $skuName | Select Version</span><br></pre></td></tr></table></figure><p>以下が実際に実行した結果の一部です。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">Version</span><br><span class="line">-------</span><br><span class="line">20348.1129.221007</span><br><span class="line">20348.1131.221014</span><br><span class="line">20348.1249.221105</span><br><span class="line">20348.1366.221207</span><br><span class="line">20348.1487.230106</span><br><span class="line">20348.1547.230207</span><br><span class="line">20348.1607.230310</span><br><span class="line">20348.1668.230404</span><br><span class="line">20348.1726.230505</span><br><span class="line">20348.1787.230607</span><br><span class="line">20348.1787.230621</span><br><span class="line">20348.1850.230707</span><br><span class="line">20348.1906.230803</span><br><span class="line">20348.1970.230905</span><br><span class="line">20348.2031.231006</span><br><span class="line">20348.2113.231109</span><br><span class="line">20348.2159.231202</span><br></pre></td></tr></table></figure><p>Version 20348.2031.231006 のイメージが存在することが確認できたので、次に VM をデプロイします。「2. Azure Portal より ARM テンプレートを用意する」以降の手順を実施します。</p><hr><h3 id="2-Azure-Portal-より-ARM-テンプレートを用意する"><a href="#2-Azure-Portal-より-ARM-テンプレートを用意する" class="headerlink" title="2. Azure Portal より ARM テンプレートを用意する"></a>2. Azure Portal より ARM テンプレートを用意する</h3><p>この項では、1項にて検索したバージョンの Azure Marketplace イメージを利用し VMを作成する方法を説明します。先にも記載した通り Azure Portal から VM を通常通り作成すると最新のバージョンが利用される動作となることから、ARM テンプレートを編集しバージョン指定を行って VM を作成する必要があります。</p><p>Azure ポータルより [Virtual Machines] を開き、VM の新規作成画面を開きます。<br>必要な項目を設定し、画面下部にある [確認および作成] を選択します。</p><p><img src="/blog/vm/create-vm-specific-version/img001.png"></p><p> [検証に成功しました] と表示されたら、画面下部にある [Automation のテンプレートをダウンロードする] を選択します。</p><p><img src="/blog/vm/create-vm-specific-version/img002.png"></p><p>表示された ARM テンプレートを使用して VM をデプロイするため、[デプロイ] を選択します。</p><p><img src="/blog/vm/create-vm-specific-version/img003.png"></p><p>ARM テンプレートを使用したカスタム デプロイの画面へ遷移しましたら、テンプレートを編集するため、[テンプレートの編集] を選択します。</p><p><img src="/blog/vm/create-vm-specific-version/img010.png"></p><hr><h3 id="3-VM-バージョンを指定する"><a href="#3-VM-バージョンを指定する" class="headerlink" title="3. VM バージョンを指定する"></a>3. VM バージョンを指定する</h3><p>ARM テンプレートの “imageReference” 配下で、 バージョンを編集します。<br> “version”: “latest” の “latest” を修正し、今回指定するバージョンを入力します。</p><p><img src="/blog/vm/create-vm-specific-version/img004.png"></p><p>今回の例では、”version”: “20348.2031.231006” と設定します。</p><figure class="highlight json"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">&quot;imageReference&quot;</span>: &#123;</span><br><span class="line">    <span class="attr">&quot;publisher&quot;</span>: <span class="string">&quot;MicrosoftWindowsServer&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;offer&quot;</span>: <span class="string">&quot;WindowsServer&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;sku&quot;</span>: <span class="string">&quot;2022-datacenter-azure-edition&quot;</span>,</span><br><span class="line">    <span class="attr">&quot;version&quot;</span>: <span class="string">&quot;20348.2031.231006&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>編集が完了しましたら、画面下部にある [保存] を選択します。</p><p><img src="/blog/vm/create-vm-specific-version/img005.png"></p><hr><h3 id="4-VM-をデプロイする"><a href="#4-VM-をデプロイする" class="headerlink" title="4. VM をデプロイする"></a>4. VM をデプロイする</h3><p>[カスタム デプロイ] 画面に戻ります。リソースグループ名など、いくつかの値は設定されていない既定の状態に戻ってしまいますので、再度設定しなおします。<br>[リソース グループ]、[Admin Password] の値を再度設定したら、[確認と作成] をクリックします。</p><p><img src="/blog/vm/create-vm-specific-version/img006.png"></p><p>“カスタム デプロイ” 画面にて [確認と作成] をクリックし、”確認と作成” の “ご契約条件” の画面で、[作成] をクリックするとデプロイが開始されます。</p><p><img src="/blog/vm/create-vm-specific-version/img007.png"></p><p>テンプレート編集画面に戻って “保存されていない編集は破棄されます” のポップアップメッセージが表示された場合は、[OK] をクリックしてデプロイ進行中の画面に遷移します。<br>最後に、デプロイが完了したことを確認します。</p><p><img src="/blog/vm/create-vm-specific-version/img008.png"></p><hr><h3 id="5-指定したバージョンで作成できたかの確認"><a href="#5-指定したバージョンで作成できたかの確認" class="headerlink" title="5. 指定したバージョンで作成できたかの確認"></a>5. 指定したバージョンで作成できたかの確認</h3><p>VM に RDP 接続をして OS ビルドを確認します。今回の例では、指定した “20348.2031” となっています。</p><p><img src="/blog/vm/create-vm-specific-version/img009.png"></p><hr><h2 id="まとめ"><a href="#まとめ" class="headerlink" title="まとめ"></a>まとめ</h2><p>今回の記事では、Windows Server のイメージを検索し、VM をデプロイしました。</p><p>上記の手順において、発行元、プラン、SKU、バージョンを置き換えることによって、Linux など他のイメージについてもこの手順が応用できます。詳細については、次のドキュメントを参照してください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/linux/cli-ps-findimage">CLI を使用してマーケットプレース購入プランの情報を検索および使用する - Azure Virtual Machines | Microsoft Learn</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/virtual-machines/windows/cli-ps-findimage">PowerShell を使用してマーケットプレース購入プランの情報を検索および使用する - Azure Virtual Machines | Microsoft Learn</a></li></ul><p>手順は以上となります。<br>本記事が皆様のお役に立てれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは。Azureサポートチームです。&lt;br&gt;この記事では、VM イメージ バージョンを指定して VM を作成する方法についてご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway と Key Vault を統合した際によくある問題について</title>
    <link href="https://jpaztech.github.io/blog/network/appgw-kv/"/>
    <id>https://jpaztech.github.io/blog/network/appgw-kv/</id>
    <published>2024-03-27T05:00:00.000Z</published>
    <updated>2024-07-03T06:47:12.869Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの金です。<br>Application Gateway v2 (Standard/WAF) の TLS 終端は、リスナーに直接証明書をアップロードする、またはリスナーにて Key Vault 証明書/シークレットを参照することで実現できます。<br>リスナーにて Key Vault 証明書/シークレットを参照する構成では、Application Gateway から 4 時間毎に Key Vault に対して証明書/シークレットをポーリングします。Application Gateway を更新するタイミングでも、Key Vault に対して証明書/シークレットをポーリングします。</p><p>この記事では、リスナーにて Key Vault 証明書/シークレットを参照する構成で、Application Gateway に HTTPS でアクセスした際に、「ERR_SSL_UNRECOGNIZED_NAME_ALERT」といった証明書エラーが発生する、もしくは Application Gateway の停止・起動や変更が正常に完了せず、Application Gateway のプロビジョニング状態が失敗になった場合に、確認すべき設定をご紹介します。リスナーにて Key Vault 証明書/シークレットを参照する設定を行う際にも該当します。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>Application Gateway から Key Vault 証明書/シークレットを取得する際は、マネージド ID を使用しており、Key Vault 側では、ロールベースのアクセス制御、またはアクセス ポリシーで、当該マネージド ID に対して適切なアクセス権限を付与する必要があります。</p><p>Application Gateway と Key Vault 統合の詳細については、<a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/key-vault-certs">公式ドキュメント</a>をご参照ください。</p></div><p>Application Gateway のリスナーを削除した際に、適応済みの証明書/シークレットはそのまま残ります。下記の各チェック項目は Application Gateway の構成に含まれるすべての証明書/シークレットが該当します。<br>Application Gateway の証明書/シークレット一覧は、以下のように Application Gateway の [リスナー] → [リスナー TLS 証明書] からご確認頂けます。[関連付けられたリスナー] が「０」となっているのは、現在どのリスナーにも関連付けられていないことを示します。</p><p><img src="/blog/network/appgw-kv/Listener-cert-list.png" alt="ListenerCertList"><br>※ [Key Vault ID] に「vault.azure.net」のドメインの URL が表示されている場合は、Key Vault 証明書/シークレットであることを示し、それ以外は直接リスナーにアップロードした証明書を示します。下記のチェック項目は Key Vault 証明書/シークレットにのみ適用されます。</p><h3 id="Key-Vault-自体、Key-Vault-証明書-シークレットの存在有無"><a href="#Key-Vault-自体、Key-Vault-証明書-シークレットの存在有無" class="headerlink" title="Key Vault 自体、Key Vault 証明書/シークレットの存在有無"></a>Key Vault 自体、Key Vault 証明書/シークレットの存在有無</h3><h5 id="Key-Vault-自体"><a href="#Key-Vault-自体" class="headerlink" title="Key Vault 自体"></a>Key Vault 自体</h5><p>Application Gateway のリスナーで参照される Key Vault 自体が削除された場合は、Key Vault を復元する、もしくは <a href="https://learn.microsoft.com/ja-jp/azure/key-vault/general/quick-create-portal">Key Vault を新規作成</a>する必要があります。<br>もし Key Vault を新規作成する際に、下記のようなエラーが出力される場合は、エラーの文言通りに同名の Key Vault を作成することはできないため、Key Vault を復元する必要があります。</p><blockquote><p>Certificate test-cert is currently in a deleted but recoverable state, and its name cannot be reused; in this state, the certificate can only be recovered or purged.</p></blockquote><h5 id="Key-Vault-証明書-シークレット"><a href="#Key-Vault-証明書-シークレット" class="headerlink" title="Key Vault 証明書/シークレット"></a>Key Vault 証明書/シークレット</h5><p>Key Vault 証明書/シークレットが削除された場合は、Key Vault 証明書/シークレットを復元する、もしくは Key Vault 証明書/シークレットを<a href="https://learn.microsoft.com/ja-jp/azure/key-vault/certificates/create-certificate">新規作成</a>/<a href="https://learn.microsoft.com/ja-jp/azure/key-vault/certificates/tutorial-import-certificate?tabs=azure-portal">インポート</a>する必要があります。</p><p>Key Vault 自体、Key Vault 証明書/シークレットの削除や復元する方法に関しては、<a href="https://learn.microsoft.com/ja-jp/azure/key-vault/general/key-vault-recovery?tabs=azure-portal">公式ドキュメント</a>をご参照ください。</p><h3 id="マネージド-ID-の存在有無"><a href="#マネージド-ID-の存在有無" class="headerlink" title="マネージド ID の存在有無"></a>マネージド ID の存在有無</h3><p>一度 Application Gateway にマネージド ID を関連付けたら、当該関連付けは Application Gateway の構成から削除しない限り、マネージド ID 自体の削除、もしくはリスナーや関連の証明書を削除することで削除されることはありません。<br>Application Gateway に関連付けられているマネージド ID は、以下の PowerShell コマンドでご確認頂けます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$appgw = Get-AzApplicationGateway -Name “Application Gateway 名” -ResourceGroupName “Application Gateway のリソース グループ名”</span><br><span class="line">$appgw.IdentityText</span><br></pre></td></tr></table></figure><p>Application Gateway にマネージド ID を関連付けた状態で、マネージド ID 自体が削除された場合は、リスナーにおける証明書関連の設定更新のみならず、Application Gateway 停止・起動や変更が正常に完了せず、Application Gateway のプロビジョニング状態が失敗になります。その際は、以下のようなエラーが出力されます。</p><blockquote><p>Response: ‘{“error”:{“code”:”BadRequest”,”message”:”Resource ‘/subscriptions/サブスクリプション ID/resourcegroups/リソース グループ名/providers/Microsoft.ManagedIdentity/userAssignedIdentities/マネージド ID’ was not found.”}}’.’ で失敗しました。</p></blockquote><p>解決方法：<br>① 上記エラーに示したリソース グループに同名の<a href="https://learn.microsoft.com/ja-jp/entra/identity/managed-identities-azure-resources/how-manage-user-assigned-managed-identities?pivots=identity-mi-methods-azp#create-a-user-assigned-managed-identity">マネージド ID を作成</a>し、Key Vault 側で当該マネージド ID に対して適切なアクセス権限を付与します。<br>② Key Vault 証明書/シークレットの参照で使用されないマネージド ID は、以下の PowerShell コマンドで Application Gateway の構成から当該マネージド ID の関連付けを削除します。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$appgw = Get-AzApplicationGateway -Name “Application Gateway 名” -ResourceGroupName “Application Gateway のリソース グループ名”</span><br><span class="line">$appgw = Remove-AzApplicationGatewayIdentity -ApplicationGateway $appgw</span><br><span class="line">$updatedgateway = Set-AzApplicationGateway -ApplicationGateway $appgw</span><br></pre></td></tr></table></figure><h3 id="Key-Vault-におけるマネージド-ID-のアクセス権限の確認"><a href="#Key-Vault-におけるマネージド-ID-のアクセス権限の確認" class="headerlink" title="Key Vault におけるマネージド ID のアクセス権限の確認"></a>Key Vault におけるマネージド ID のアクセス権限の確認</h3><p>Key Vault のアクセス制御方式は、Azure ロールベースのアクセス制御とコンテナーのアクセス ポリシーの二つの方式がございます。<br>現在適用されている制御方式は、下記のように Key Vault の [アクセス構成] → [アクセス許可モデル] からご確認頂けます。</p><p><img src="/blog/network/appgw-kv/KV-access-control.png" alt="KVAccessControl"></p><h5 id="ロールベースのアクセス制御"><a href="#ロールベースのアクセス制御" class="headerlink" title="ロールベースのアクセス制御"></a>ロールベースのアクセス制御</h5><p>ロールベースのアクセス制御を利用している場合は、Key Vault の [アクセス制御 (IAM)] で対象のマネージド ID に「キー コンテナー シークレット ユーザー」ロールを付与する必要があります。ロールを割り当てる方法に関しては、<a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/role-assignments-portal?tabs=delegate-condition">公式ドキュメント</a>をご参照ください。</p><p><img src="/blog/network/appgw-kv/KV-RBAC.png" alt="ListenerCertList"></p><h5 id="アクセス-ポリシー"><a href="#アクセス-ポリシー" class="headerlink" title="アクセス ポリシー"></a>アクセス ポリシー</h5><p>アクセス ポリシーを利用している場合は、Key Vault の [アクセス ポリシー] で対象のマネージド ID に [シークレットのアクセス許可] の [取得] 権限を付与する必要があります。</p><p><img src="/blog/network/appgw-kv/KV-access-policy.png" alt="ListenerCertList"></p><h3 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h3><p>Key Vault 統合で設定不備があった場合は、Azure Advisor より Key Vault エラーが出力される場合もありますので、エラー コードと解決策については、<a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/application-gateway-key-vault-common-errors">公式ドキュメント</a>をご参照ください。</p><h3 id="プライベート-エンドポイントを介して-Key-Vault-にアクセスする場合"><a href="#プライベート-エンドポイントを介して-Key-Vault-にアクセスする場合" class="headerlink" title="プライベート エンドポイントを介して Key Vault にアクセスする場合"></a>プライベート エンドポイントを介して Key Vault にアクセスする場合</h3><p>Application Gateway からプライベート エンドポイントを介して Key Vault にアクセスする場合は、以下の設定も必要となります。</p><ul><li>プライベート DNS ゾーン (privatelink.vaultcore.azure.net) にプライベート エンドポイントの DNS レコードが登録されている</li><li>プライベート DNS ゾーン (privatelink.vaultcore.azure.net) に Application Gateway の VNet がリンクされている</li></ul><p><img src="/blog/network/appgw-kv/pDNS-vnet-link.png" alt="pDNSVnetLink"></p><ul><li>プライベート エンドポイントが所属するサブネットに NSG を構成 (必須の構成ではない) しており、下記のように、当該サブネットの [プライベート エンドポイント ネットワーク ポリシー] の [ネットワーク セキュリティ グループ] が有効になっている場合は、NSG の受信規則で Application Gateway のサブネットからの通信を許可する</li></ul><p><img src="/blog/network/appgw-kv/NSG.png" alt="NSG"></p><h3 id="その他の注意点"><a href="#その他の注意点" class="headerlink" title="その他の注意点"></a>その他の注意点</h3><ul><li>AppService 証明書を Key Vault に格納して使用する場合は、AppService 証明書のドメイン検証が終わってから、Application Gateway のリスナー側で指定してください。そうでない場合、Key Vault 側で証明書参照の準備ができていないため、Application Gateway のプロビジョニング状態が失敗になる可能性があります。</li><li>Application Gateway のリスナーを削除した際に、適応済みに証明書/シークレットはそのまま残りますので、不要な証明書は削除することをお勧めします。Azure ポータルより対象の Application Gateway を開き、[リソース] → [リスナー TLS 証明書] 一覧から、対象の証明書を削除できます。</li><li>Application Gateway に複数のリスナーがある場合、リスナー毎に異なるマネージド ID を指定せず、Application Gateway 単位で同一マネージド ID をご利用ください。</li></ul><h3 id="お願い"><a href="#お願い" class="headerlink" title="お願い"></a>お願い</h3><p>上記の設定内容に不備がない場合、Application Gateway の観点でお問い合わせいただければと存じますが、その場合は、以下の三つのコマンドを実行し、実行したコマンドとその結果をお問い合わせ時に添付いただけるとスムーズかと存じます。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Get-AzKeyVault -VaultName &lt;KeyVault 名&gt;</span><br><span class="line">Get-AzKeyVaultSecret -VaultName &lt;KeyVault 名&gt;</span><br><span class="line">Get-AzKeyVaultSecret -VaultName &lt;KeyVault 名&gt; -Name</span><br></pre></td></tr></table></figure><hr>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの金です。&lt;br&gt;Application Gateway v2 (Standard/WAF) の TLS 終端は、リスナーに直接証明書をアップロードする、またはリスナーにて Key Vault 証明書/シークレットを参照す</summary>
      
    
    
    
    
    <category term="Application Gateway" scheme="https://jpaztech.github.io/blog/tags/Application-Gateway/"/>
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Key Vault" scheme="https://jpaztech.github.io/blog/tags/Key-Vault/"/>
    
  </entry>
  
  <entry>
    <title>Azure プライベート DNS ゾーンに関するベスト プラクティス及びよくあるお問合せ</title>
    <link href="https://jpaztech.github.io/blog/network/private-dns-zone-faq/"/>
    <id>https://jpaztech.github.io/blog/network/private-dns-zone-faq/</id>
    <published>2024-03-26T02:00:00.000Z</published>
    <updated>2024-07-03T06:47:12.917Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの杜です。</p><p>Azure DNS では、仮想ネットワーク内の名前解決結果を上書きできる<a href="https://learn.microsoft.com/ja-jp/azure/dns/private-dns-privatednszone">プライベート DNS ゾーン</a>というサービスをご提供しており、<br><a href="https://learn.microsoft.com/ja-jp/azure/private-link/private-endpoint-overview">プライベート エンドポイント</a>の名前解決などと併用する場合が多いです。</p><p>このブログでは、プライベート DNS ゾーンのベスト プラクティス、及びよく頂いているお問い合わせをご紹介させて頂きます。</p><span id="more"></span><hr><h3 id="シナリオ"><a href="#シナリオ" class="headerlink" title="シナリオ"></a>シナリオ</h3><ul><li>仮想ネットワーク上のリソース (VM) がプライベート エンドポイント経由でストレージ アカウントに接続する</li><li>仮想ネットワークでは Azure 既定の DNS (168.63.129.16) を DNS サーバーとして指定している</li><li>プライベート エンドポイント経由でストレージ アカウント<code>storagebloga</code>へアクセスするために、プライベート DNS ゾーン <code>privatelink.blob.core.windows.net</code> をクライアント VM の仮想ネットワークにリンクした</li><li>プライベート DNS ゾーン <code>privatelink.blob.core.windows.net</code> に <code>storagebloga IN A ＜プライベート エンドポイント IP＞</code> のレコードを登録し、プライベート エンドポイントの名前解決が成功している</li><li>ただし、それ以外一部のストレージ アカウントの名前解決を行ったところ、空の結果 (NXDOMAIN) が返されてしまい、接続も失敗している</li><li>すべてストレージ アカウントの名前解決が失敗するわけではなく、問題なく接続できる場合もある</li><li>ストレージ アカウントの他に、AppService や Azure SQL Database など他の Azure PaaS サービスにも類似の事象がある</li></ul><h3 id="原因分析"><a href="#原因分析" class="headerlink" title="原因分析"></a>原因分析</h3><p>発生原因を理解するために、まず全体的な名前解決フローを説明させて頂きます。</p><p>ストレージ アカウントなどの Azure PaaS サービスでは、プライベート エンドポイントの有効化状況により、名前解決フローが異なります。<br>プライベート エンドポイントが無効化されているリソースでは、名前解決フローが以下となります。<code>privatelink.blob.core.windows.net</code> のドメインを経由しません。<br><img src="./01.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">※プライベート エンドポイント無効化時の名前解決フロー</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;storagebloga.blob.core.windows.net. IN A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">storagebloga.blob.core.windows.net. 20 IN CNAME blob.tyo22prdstr07a.store.core.windows.net.</span><br><span class="line">blob.tyo22prdstr07a.store.core.windows.net. 60 IN A 20.150.85.196</span><br></pre></td></tr></table></figure><p>プライベート エンドポイントを有効化すると、<code>storagebloga.blob.core.windows.net</code> の CNAME 先が <code>privatelink.blob.core.windows.net</code> ドメインに変更される動作となります。<br>クライアントが存在する仮想ネットワークがプライベート DNS ゾーンにリンクしていない場合、名前解決結果は変わりません。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">※プライベート エンドポイント有効化時の名前解決フロー (プライベート DNS ゾーンのリンクなし)</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;storagebloga.blob.core.windows.net. IN A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">storagebloga.blob.core.windows.net. 60 IN CNAME storagebloga.privatelink.blob.core.windows.net.</span><br><span class="line">storagebloga.privatelink.blob.core.windows.net. 60 IN CNAME blob.tyo22prdstr07a.store.core.windows.net.</span><br><span class="line">blob.tyo22prdstr07a.store.core.windows.net. 17 IN A 20.150.85.196</span><br></pre></td></tr></table></figure><p>プライベート エンドポイントへ接続させるには、お客様側にプライベート DNS ゾーン <code>privatelink.blob.core.windows.net</code> に A レコードを作成し、仮想ネットワークにリンクすることで、該当 CNAME 先を上書きして実現できているわけです。<br><img src="./02.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">※プライベート エンドポイント有効化、プライベート DNS ゾーン使用時の名前解決フロー</span><br><span class="line">※10.0.3.4 がプライベート エンドポイントの IP アドレスとなります。</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;storagebloga.blob.core.windows.net. IN A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">storagebloga.blob.core.windows.net. 60 IN CNAME storagebloga.privatelink.blob.core.windows.net.</span><br><span class="line">storagebloga.privatelink.blob.core.windows.net. 60 IN A 10.0.3.4</span><br></pre></td></tr></table></figure><p>プライベート DNS ゾーンをリンクすると、Azure DNS が該当 DNS ゾーン <code>privatelink.blob.core.windows.net</code> の権威サーバーとなります。<br>そのドメインへの名前解決要求を受信する時に、インターネット経由で再帰的問い合わせを行わずに、プライベート DNS ゾーンに登録されているレコードを権威結果として応答するようになります。<br>その場合、プライベート DNS ゾーンに <code>storagebloga</code> 以外のレコードが登録されていないため、以下のように、NXDOMAIN が応答されてしまいます。<br><img src="./03.png"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">※プライベート エンドポイント有効化、プライベート DNS ゾーン使用時に、別のリソース（プライベート エンドポイント有効化）の名前解決フロー</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;storageblogbwithpe.blob.core.windows.net. INA</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">storageblogbwithpe.blob.core.windows.net. 60 IN CNAMEstorageblogbwithpe.privatelink.blob.core.windows.net.</span><br></pre></td></tr></table></figure><p>また、各ストレージ アカウントの構成次第で、プライベート エンドポイントが有効化されていない場合があります。<br>その場合の名前解決フローでは <code>privatelink.blob.core.windows.net</code> のドメインが存在しないため、プライベート DNS ゾーン <code>privatelink.blob.core.windows.net</code> をリンクしても影響がありません。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">※プライベート エンドポイント有効化、プライベート DNS ゾーン使用時に、別のリソース（プライベート エンドポイント無効化）の名前解決フロー</span><br><span class="line"></span><br><span class="line">;; QUESTION SECTION:</span><br><span class="line">;storageblogcwithoutpe.blob.core.windows.net. IN A</span><br><span class="line"></span><br><span class="line">;; ANSWER SECTION:</span><br><span class="line">storageblogcwithoutpe.blob.core.windows.net. 20 IN CNAME blob.tyo22prdstr07a.store.core.windows.net.</span><br><span class="line">blob.tyo22prdstr07a.store.core.windows.net. 60 IN A 20.150.85.196</span><br></pre></td></tr></table></figure><h3 id="回避策"><a href="#回避策" class="headerlink" title="回避策"></a>回避策</h3><p>特定のストレージ アカウントの名前解決のみをプライベート DNS ゾーンで実現し、それ以外の名前解決への影響を回避したい場合は、<code>privatelink.blob.core.windows.net</code> ではなく、<br><code>storagebloga.privatelink.blob.core.windows.net</code> のプライベート DNS ゾーンを作成し、頂点（APEX）レコード <code>@ IN A ＜プライベート エンドポイント IP＞</code> を構成すれば実現できます。<br>そうしますと、Azure DNS の権威ドメインが <code>storagebloga.privatelink.blob.core.windows.net</code> のみとり、それ以外 <code>storageblogcwithoutpe.privatelink.blob.core.windows.net</code> の名前解決要求を受けると、<br>インターネット経由で再帰的問い合わせを行い、プライベート DNS ゾーンに影響されなくなります。<br><img src="./04.png"></p><p>ただし、もし複数のストレージ アカウントが存在する場合は、ストレージ アカウントの名前ごとにプライベート DNS ゾーンを用意する必要がありますので、ご注意ください。</p><h1 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h1><h2 id="プライベート-DNS-ゾーンのレコードを変更する時に、リンク先の仮想ネットワークの名前解決が影響されるのでしょうか。"><a href="#プライベート-DNS-ゾーンのレコードを変更する時に、リンク先の仮想ネットワークの名前解決が影響されるのでしょうか。" class="headerlink" title="プライベート DNS ゾーンのレコードを変更する時に、リンク先の仮想ネットワークの名前解決が影響されるのでしょうか。"></a>プライベート DNS ゾーンのレコードを変更する時に、リンク先の仮想ネットワークの名前解決が影響されるのでしょうか。</h2><p>変更対象以外のレコードには影響がなく、該当プライベート DNS ゾーンで一時的に名前解決ができなくなるといった事象は発生しませんので、ご安心ください。</p><h2 id="東日本リージョンに本番環境を構築しており、プライベート-DNS-ゾーンをリンクし、仮想ネットワークに仮想マシンなどを運用しています。リージョン-レベルの冗長化を取るために、西日本リージョンに同じ構成を取りたいですが、プライベート-DNS-ゾーンもリージョンごとに作成する必要がありますでしょうか。"><a href="#東日本リージョンに本番環境を構築しており、プライベート-DNS-ゾーンをリンクし、仮想ネットワークに仮想マシンなどを運用しています。リージョン-レベルの冗長化を取るために、西日本リージョンに同じ構成を取りたいですが、プライベート-DNS-ゾーンもリージョンごとに作成する必要がありますでしょうか。" class="headerlink" title="東日本リージョンに本番環境を構築しており、プライベート DNS ゾーンをリンクし、仮想ネットワークに仮想マシンなどを運用しています。リージョン レベルの冗長化を取るために、西日本リージョンに同じ構成を取りたいですが、プライベート DNS ゾーンもリージョンごとに作成する必要がありますでしょうか。"></a>東日本リージョンに本番環境を構築しており、プライベート DNS ゾーンをリンクし、仮想ネットワークに仮想マシンなどを運用しています。リージョン レベルの冗長化を取るために、西日本リージョンに同じ構成を取りたいですが、プライベート DNS ゾーンもリージョンごとに作成する必要がありますでしょうか。</h2><p>プライベート DNS ゾーンを含め、Azure DNS は 100% の <a href="https://azure.microsoft.com/ja-jp/updates/azuredns100sla/">SLA</a> でご提供しているため、冗長化の観点ではリージョンごとに作成する必要はありません。</p><p>ただし、もし各リージョンの IP アドレス構成が異なり、同じ FQDN に対し、リージョンごとに名前解決結果を分けたい場合は、１つのプライベート DNS ゾーンでは実現できませんので、各リージョンごとにリソース グループを作成し、複数のプライベート DNS ゾーンの構成をご検討ください。</p><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの杜です。&lt;/p&gt;
&lt;p&gt;Azure DNS では、仮想ネットワーク内の名前解決結果を上書きできる&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/dns/private-dns-privatednszone&quot;&gt;プライベート DNS ゾーン&lt;/a&gt;というサービスをご提供しており、&lt;br&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/private-link/private-endpoint-overview&quot;&gt;プライベート エンドポイント&lt;/a&gt;の名前解決などと併用する場合が多いです。&lt;/p&gt;
&lt;p&gt;このブログでは、プライベート DNS ゾーンのベスト プラクティス、及びよく頂いているお問い合わせをご紹介させて頂きます。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="DNS" scheme="https://jpaztech.github.io/blog/tags/DNS/"/>
    
  </entry>
  
  <entry>
    <title>168.63.129.16 の DNS 機能について</title>
    <link href="https://jpaztech.github.io/blog/network/dns-168-63-129-16/"/>
    <id>https://jpaztech.github.io/blog/network/dns-168-63-129-16/</id>
    <published>2024-03-08T03:00:00.000Z</published>
    <updated>2024-07-03T06:47:12.885Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの箕輪です。<br>Azure データーセンターでは、168.63.129.16 のパブリック IP アドレスは重要な役割を担います。<br>168.63.129.16 の役割については<a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/what-is-ip-address-168-63-129-16">こちら</a> でご紹介していますが、このブログでは 168.63.129.16 の DNS 機能について補足やよくあるお問い合わせをご紹介します。</p><span id="more"></span><h2 id="168-63-129-16-の概要"><a href="#168-63-129-16-の概要" class="headerlink" title="168.63.129.16 の概要"></a>168.63.129.16 の概要</h2><p>168.63.129.16 は Microsoft が保有するパブリック IP アドレスであり、Azure データーセンター上でのみ利用している仮想 IP アドレスです。<br>この 168.63.129.16 は Azure データーセンターのホスト サーバー (物理サーバー) 上で動作する IP アドレスとして割り当てられていて、パブリック インターネット上には公開されていないため Azure データーセンター上のリソース以外からは接続ができません。<br>仮想マシンなど Azure データーセンター上のリソースが正常に稼働するためのエンドポイントでもあるため、NSG やルート テーブル (UDR) で 168.63.129.16 を制御することは出来ず、仮想マシン上の OS 上でも制御しないことを強く推奨しています。</p><blockquote><p>注意<br>NSG では 168.63.129.16 に対する制御はできないと記載しましたが、AzurePlatformDNS や AzureLoadBalancer のサービスタグを利用することで、168.63.129.16 に関する通信の一部を NSG で制御可能です。<br>ただし、意図しない動作を回避するためにも原則制御しないことを強く推奨します。</p></blockquote><h2 id="168-63-129-16-の-DNS-機能"><a href="#168-63-129-16-の-DNS-機能" class="headerlink" title="168.63.129.16 の DNS 機能"></a>168.63.129.16 の DNS 機能</h2><p>168.63.129.16 は <a href="https://learn.microsoft.com/ja-jp/azure/virtual-network/virtual-networks-name-resolution-for-vms-and-role-instances?tabs=redhat">Azure 上の名前解決</a> のための再帰的リゾルバー (フルサービス リゾルバー) の機能を提供しています。下記の用途で利用いただけます。</p><p><strong>・インターネット上のドメインに対する名前解決</strong><br><strong>・<a href="https://learn.microsoft.com/ja-jp/azure/dns/private-dns-privatednszone">プライベート DNS ゾーン</a> の名前解決</strong><br><strong>・同一仮想ネットワーク上のホスト名での名前解決</strong>  </p><p>この 168.63.129.16 の DNS 機能は、Azure ポータルであれば仮想ネットワークの DNS 設定における既定値である <strong>“既定 (Azure 提供)”</strong> で利用でき、明示的に 168.63.129.16 を指定する必要はありません。<br>また、冗長構成を意識いただくことなく、Azure 基盤内で既定で冗長化されています。<br>仮想ネットワークの DNS の観点で、168.63.129.16 を参照することは必須要件ではなく、仮想ネットワークや仮想マシンの仮想 NIC の DNS サーバーの設定として、任意の DNS サーバーを指定可能です。<br>Azure では任意の DNS サーバーを指定する構成をカスタム DNS サーバーと呼んでおり、仮想ネットワーク上のカスタム DNS サーバーでよくあるお問い合わせについては <a href="/blog/network/custom-dns-faq/">こちら</a> をご確認ください。</p><blockquote><p>注意<br>168.63.129.16 が提供するホスト名での名前解決は、同一の仮想ネットワークに限定されています。<br>例えば 2 つの仮想ネットワークでピアリング接続をしている構成では、ピアリング先のリソースをホスト名で名前解決することは出来ません。</p></blockquote><h2 id="168-63-129-16-を参照する-DNS-構成"><a href="#168-63-129-16-を参照する-DNS-構成" class="headerlink" title="168.63.129.16 を参照する DNS 構成"></a>168.63.129.16 を参照する DNS 構成</h2><p>168.63.129.16 の DNS サーバーは、Azure データーセンター上のリソースからのみ DNS クエリを受け付け可能な為、ExpressRoute や VPN で接続されたオンプレミスから 168.63.129.16 を DNS サーバーとして参照できません。<br>プライベート DNS ゾーンをオンプレミスから参照させたい場合や、ハブ&amp;スポーク構成の仮想ネットワークにおいてハブの仮想ネットワークのプライベート DNS ゾーンを参照させたい場合など、Azure 上に DNS プロキシに該当する機能が必要です。<br>この DNS プロキシは、Azure であれば現在下記の構成案があります。</p><p><strong>・Azure DNS Private Resolver を利用する</strong><br><strong>・Azure Firewall の DNS プロキシ機能を有効化する</strong><br><strong>・仮想マシン上に DNS サーバーを構成する</strong>  </p><p>それぞれの特徴としては下記があります。</p><h4 id="Azure-DNS-Private-Resolver"><a href="#Azure-DNS-Private-Resolver" class="headerlink" title="Azure DNS Private Resolver"></a>Azure DNS Private Resolver</h4><p><a href="https://learn.microsoft.com/ja-jp/azure/dns/dns-private-resolver-overview">Azure DNS Private Resolver</a> は、仮想ネットワークのサブネット上に、DNS クエリを受け付ける受信エンドポイントを構成します。<br>受信エンドポイントの IP アドレスは仮想ネットワーク上の IP アドレスとなり、IP レイヤーで疎通性があればオンプレミスからも DNS クエリを受け付けることができます。既定で高可用性/ゾーン冗長構成のマネージド サービスであるため、運用コストが削減できます。<br>168.63.129.16 の DNS サーバーは条件付き転送などカスタマイズ機能がありませんでしたが、Azure DNS Private Resolver であれば送信エンドポイントと転送ルールを構成することで条件付き転送も利用できます。</p><h4 id="Azure-Firewall"><a href="#Azure-Firewall" class="headerlink" title="Azure Firewall"></a>Azure Firewall</h4><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/overview">Azure Firewall</a> は仮想ネットワーク上でデプロイ可能なファイアウォール アプライアンスですが、DNS クエリを受け付ける <a href="https://learn.microsoft.com/ja-jp/azure/firewall/dns-settings#dns-proxy">DNS プロキシ</a> の機能があります。<br>Azure Firewall が参照する DNS サーバーは仮想ネットワークのカスタム DNS サーバーとは連動しておらず、既定で 168.63.129.16 を参照します。Azure Firewall の DNS サーバーの設定で任意の DNS サーバーを参照するように構成変更可能です。<br>既に Azure Firewall をご利用いただいており、条件付き転送が不要であれば DNS プロキシとしてご利用いただけますが、DNS プロキシの機能のみをご利用いただく場合は Azure DNS Private Resolver よりも高額です。</p><h4 id="仮想マシン上の-DNS-サーバー"><a href="#仮想マシン上の-DNS-サーバー" class="headerlink" title="仮想マシン上の DNS サーバー"></a>仮想マシン上の DNS サーバー</h4><p>Azure 上の DNS プロキシとしては、仮想マシン上に DNS サーバー (Windows サーバーや BIND など) を構成いただき、フォワーダー先として 168.63.129.16 を指定いただく構成も考えられます。<br>仮想マシン上の構成となるため、DNS サーバーの構成及び運用はお客様のご対応範囲となり、Azure サポートではご支援できかねる点はご留意ください。  </p><p>DNS プロキシをオンプレミスから参照する構成イメージとしては、<a href="https://learn.microsoft.com/ja-jp/azure/private-link/private-endpoint-dns-integration">プライベート エンドポイントのドキュメント</a> に Azure DNS Private Resolver をベースとした構成例があります。<br>必要に応じて Azure Firewall や仮想マシン上の DNS サーバーと置き換えてください。</p><blockquote><p>注意<br>オンプレミスの DNS サーバーから Azure 上の DNS プロキシを参照する構成で、プライベート エンドポイントに関連するドメインを条件付きフォワーダーで指定する時、指定するドメイン ゾーンは対象 Azure PaaS の パブリック DNS ゾーンを指定することを推奨しています。<br>プライベート エンドポイントで利用される privatelink サブドメインの DNS ゾーンだけ条件付きフォワーダーで転送した場合、オンプレミスの DNS サーバーの動作によっては意図した名前解決とならない場合があります。  </p></blockquote><h2 id="よくいただくお問い合わせ"><a href="#よくいただくお問い合わせ" class="headerlink" title="よくいただくお問い合わせ"></a>よくいただくお問い合わせ</h2><p>168.63.129.16 の DNS 機能に関して、Azure サポートによくお問い合わせいただく内容についてご案内します。<br>仮想ネットワーク上のカスタム DNS サーバーでよくあるお問い合わせについては <a href="/blog/network/custom-dns-faq/">こちら</a> をご確認ください。<br>プライベート DNS ゾーンに関してよくあるお問い合わせについては <a href="/blog/network/private-dns-zone-faq/">こちら</a> をご参照ください。  </p><h4 id="DNS-プロキシから-168-63-129-16-をフォワーダー先に指定して制限がかかりませんか？"><a href="#DNS-プロキシから-168-63-129-16-をフォワーダー先に指定して制限がかかりませんか？" class="headerlink" title="DNS プロキシから 168.63.129.16 をフォワーダー先に指定して制限がかかりませんか？"></a>DNS プロキシから 168.63.129.16 をフォワーダー先に指定して制限がかかりませんか？</h4><p>1 台の仮想マシンから 1 秒あたりに送信可能な DNS クエリの数 (QPS) は 1000  という <a href="https://learn.microsoft.com/ja-jp/azure/azure-resource-manager/management/azure-subscription-service-limits#azure-dns-limits">Azure 上の制限内</a> であれば、168.63.129.16 は DNS サーバーとして DNS クエリを処理可能です。<br>言い換えますと、仮想マシン上の DNS サーバー、または Azure Firewall を経由して 168.63.129.16 に対する  1000 QPS 以上の DNS クエリは失敗する可能性があります。<br>なお、Azure DNS Private Resolver はエンドポイント毎に 10,000 QPS が上限です。</p><h4 id="仮想マシン上の名前解決でホスト名で-IP-アドレスが解決できなくなりました。"><a href="#仮想マシン上の名前解決でホスト名で-IP-アドレスが解決できなくなりました。" class="headerlink" title="仮想マシン上の名前解決でホスト名で IP アドレスが解決できなくなりました。"></a>仮想マシン上の名前解決でホスト名で IP アドレスが解決できなくなりました。</h4><p>考えられる要因として、仮想ネットワークの DNS サーバーの設定が変更されてカスタム DNS サーバーを参照する構成になったことが考えられます。<br>仮想マシンが 168.63.129.16 を参照している構成では、ホスト名で名前解決をした際、Azure 基盤が内部 DNS サフィックス (.internal.cloudapp.net) を自動で付与します。<br>この動作により仮想マシン上でホスト名だけで名前解決ができます。<br>仮想マシンが 168.63.129.16 を参照しない構成 (カスタム DNS サーバー構成) に変更された場合、Azure 基盤の内部 DNS サフィックス (.internal.cloudapp.net) の自動付与の機能が停止されるため、仮想マシンはホスト名で名前解決ができなくなります。</p><h4 id="仮想マシン上のホスト名での名前解決の-IP-アドレスが変更されました。"><a href="#仮想マシン上のホスト名での名前解決の-IP-アドレスが変更されました。" class="headerlink" title="仮想マシン上のホスト名での名前解決の IP アドレスが変更されました。"></a>仮想マシン上のホスト名での名前解決の IP アドレスが変更されました。</h4><p>考えられる要因として、同一のコンピューター名を持つ仮想マシンを 1 つの仮想ネットワーク上に複数展開したことが挙げられます。<br>仮想マシンが展開されたとき、Azure 基盤では内部 DNS サフィックス (.internal.cloudapp.net) に仮想マシンのコンピューター名をホスト名とした DNS レコード情報を追加します。<br>仮想マシンのバックアップなどでバックアップ先を同一の仮想ネットワークにした場合、Azure 基盤は仮想マシンの展開時に DNS レコード情報を更新します。<br>この動作により、ホスト名に対する名前解決の結果が、後からデプロイされた仮想マシンの IP アドレスと紐づけられることで、ホスト名に対する名前解決の結果が変更されます。</p><p>もし、仮想マシン間の名前解決をホスト名のみで実施されており、仮想マシンのバックアップなどを実施される場合は、別の仮想ネットワーク上にデプロイいただくなどのご対応を実施願います。</p><h4 id="サフィックスとして追加された-reddog-microsoft-com-は消しても良いですか？"><a href="#サフィックスとして追加された-reddog-microsoft-com-は消しても良いですか？" class="headerlink" title="サフィックスとして追加された reddog.microsoft.com は消しても良いですか？"></a>サフィックスとして追加された reddog.microsoft.com は消しても良いですか？</h4><p>仮想マシンが 168.63.129.16 を DNS サーバーとして参照しないカスタム DNS サーバー構成では、Azure 基盤は既定の内部 DNS サフィックス (.internal.cloudapp.net) ではなく、機能を持たないプレース ホルダー (reddog.microsoft.com) が付与されます。<br>この reddog.microsoft.com  プレフィックスを削除または上書きされても仮想マシンの動作上は影響ありません。</p><h4 id="168-63-129-16-で名前解決された-DNS-クエリのログは確認できますか？"><a href="#168-63-129-16-で名前解決された-DNS-クエリのログは確認できますか？" class="headerlink" title="168.63.129.16 で名前解決された DNS クエリのログは確認できますか？"></a>168.63.129.16 で名前解決された DNS クエリのログは確認できますか？</h4><p>現状 168.63.129.16 の DNS ログを Azure ユーザーが確認する方法はございません。<br>Azure サポート担当にご依頼いただければ該当ログの調査支援が可能ですが、ログの調査をするには対象の FQDN と調査対象の時刻を可能な限り具体的にご提示願います。<br>なお、Azure 既定の DNS のログは、30 日程度でローテーションされ、過去のログは参照できない点はご留意ください。</p><h4 id="DNSSEC-はサポートしていますか？"><a href="#DNSSEC-はサポートしていますか？" class="headerlink" title="DNSSEC はサポートしていますか？"></a>DNSSEC はサポートしていますか？</h4><p>現状 168.63.129.16 において DNSSEC はサポートされていません。<br>今後の機能追加として検討されているため、今後の機能追加にご期待いただければと存じます。</p></br><p>以上、ご参考になれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの箕輪です。&lt;br&gt;Azure データーセンターでは、168.63.129.16 のパブリック IP アドレスは重要な役割を担います。&lt;br&gt;168.63.129.16 の役割については&lt;a href=&quot;https://learn.microsoft.com/ja-jp/azure/virtual-network/what-is-ip-address-168-63-129-16&quot;&gt;こちら&lt;/a&gt; でご紹介していますが、このブログでは 168.63.129.16 の DNS 機能について補足やよくあるお問い合わせをご紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="DNS" scheme="https://jpaztech.github.io/blog/tags/DNS/"/>
    
  </entry>
  
  <entry>
    <title>Gateway メンテナンスコントロール機能について</title>
    <link href="https://jpaztech.github.io/blog/network/gw-maintenance/"/>
    <id>https://jpaztech.github.io/blog/network/gw-maintenance/</id>
    <published>2024-02-29T15:00:00.000Z</published>
    <updated>2024-07-03T06:47:12.901Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。</p><p>Azure ゲートウェイサービスでは以前からお客様よりメンテナンスのコントロールについてご要望をいただいておりました。<br>2023 年 11 月よりプレビュー中の機能とはなりますが、メンテナンスコントロールのための機能が実装されましたのでご紹介させていただきます。</p><ul><li>ご参考: <a href="https://azure.microsoft.com/ja-jp/updates/public-preview-customercontrolled-maintenance/">Public preview: Customer-controlled maintenance | Azure の更新情報 | Microsoft Azure</a></li></ul><h2 id="仮想ネットワークゲートウェイ-VGW-メンテナンスとは"><a href="#仮想ネットワークゲートウェイ-VGW-メンテナンスとは" class="headerlink" title="仮想ネットワークゲートウェイ( VGW ) メンテナンスとは"></a>仮想ネットワークゲートウェイ( VGW ) メンテナンスとは</h2><p>VGW ではサービスを健全に保つため、月に数回のメンテナンスを実施しており、定期メンテナンスは大きく以下の 3 種類に分類されます。</p><ol><li>ゲートウェイ機能を提供するソフトウェア メンテナンス</li><li>ホスト基盤メンテナンス </li><li>ハードウェアメンテナンス</li></ol><p>ゲートウェイ機能を提供しているソフトウェアのアップグレードの他、一般的な VM と同様の IaaS サービス基盤上で動作しているため、<br>ホストで稼働するソフトウェアアップグレードやホスト、上位ネットワーク装置などハードウェアの更新などの作業を行います。<br>一般的にこれらは Azure サービス基盤上で自動化された作業で、冗長性を考慮し、数千、数万のリソースに対し、順次、更新を適用いたします。</p><ul><li>ご参考: <a href="https://jpaztech.github.io/blog/vm/vm-maintenance/">Azure IaaS VM で実施されるメンテナンスについて</a></li></ul><p>定期メンテナンスでは極力お客様サービスに影響が発生しないように、ExressRoute ゲートウェイではトラフィックを迂回した上で実施するなどの対処を行っております。しかしながら現状、実行時に多少の通信遅延の増加、パケットロスが検出されることがあります。また VPNGW では VPN 接続で再接続が必要になることがあります。</p><h2 id="メンテナンスコントロール機能でできること"><a href="#メンテナンスコントロール機能でできること" class="headerlink" title="メンテナンスコントロール機能でできること"></a>メンテナンスコントロール機能でできること</h2><p>本機能を設定することで、 VGW リソース毎に定期メンテナンスを実行するためのメンテナンスウィンドウを指定することができます。トラフィックの少ない時間帯、営業時間外にメンテナンスウィンドウを設定いただくことにより、サービス影響を極力避けた運用が可能となります。この機能を用いても、上記の 3 種類のメンテナンスの中の “1. ゲートウェイ機能を提供するソフトウェア メンテナンス” のみの制御となりますので、<strong>全メンテナンスを制御できるわけではございませんのでご注意ください。</strong></p><p>( VGW は共有リソース上で稼働しているため、ホスト基盤、ハードウェアメンテナンスについては本機能の制御対象外となります )</p><h2 id="対応可能なゲートウェイの種類"><a href="#対応可能なゲートウェイの種類" class="headerlink" title="対応可能なゲートウェイの種類"></a>対応可能なゲートウェイの種類</h2><p>対象可能な VGW の種類は下記となります。<br>現時点では Virtual WAN Point-to-Site GW, VirtualWAN 仮想ハブルータついては未対応です</p><ul><li>ExpressRoute GW</li><li>VPNGW</li><li>VirtualWAN Site-to-Site GW</li><li>VirtualWAN ExpressRoute GW</li></ul><h2 id="設定例"><a href="#設定例" class="headerlink" title="設定例"></a>設定例</h2><p>設定方法詳細については以下ドキュメントご参照ください。</p><p>＊ご参考: <a href="https://learn.microsoft.com/ja-jp/azure/vpn-gateway/customer-controlled-gateway-maintenance">VPN Gateway にお客様が管理するゲートウェイ メンテナンスを構成する (プレビュー)</a></p><p>＊ご参考: <a href="https://learn.microsoft.com/ja-jp/azure/expressroute/customer-controlled-gateway-maintenance">ExpressRoute にお客様が管理するゲートウェイ メンテナンスを構成する (プレビュー)</a></p><p>仮想ネットワーク ゲートウェイにお客様が管理するメンテナンスを構成する - Azure VPN Gateway | Microsoft Learn</p><p>重要な設定項目としてメンテナンスウィンドウ スケジュールを指定する箇所がありますが、直観的にわかりにくいため、設定例とその動作について以下例を挙げて説明いたします。</p><p>スケジュールの設定例</p><p><img src="/blog/network/gw-maintenance/maintenance_control_1.png"> </p><p>“スケジュールの追加” を選択することで、メンテナンスウィンドウの開始時刻と許容するメンテナンス期間を設定します。<br>※メンテナンス期間の最小値は 5 時間で、それ以下を設定することはできません。</p><p><img src="/blog/network/gw-maintenance/maintenance_control_2.png"> </p><h2 id="設定例と実際の動作について"><a href="#設定例と実際の動作について" class="headerlink" title="設定例と実際の動作について"></a>設定例と実際の動作について</h2><h3 id="設定シナリオ-1"><a href="#設定シナリオ-1" class="headerlink" title="設定シナリオ 1."></a>設定シナリオ 1.</h3><p>メンテナンス構成設定を追加した日時 1/1 9:00</p><h4 id="設定内容"><a href="#設定内容" class="headerlink" title="設定内容"></a>設定内容</h4><ul><li>開始日 1/31 5:00 </li><li>メンテナンス期間 ５時間</li></ul><h4 id="実際の動作"><a href="#実際の動作" class="headerlink" title="実際の動作"></a>実際の動作</h4><p>1/31 に計画メンテナンスがある場合<br>メンテナンスウィンドウ設定に従い、 1/31 5:00 ～ 10:00 の間にメンテナンスが発生します</p><hr><h3 id="設定シナリオ-2"><a href="#設定シナリオ-2" class="headerlink" title="設定シナリオ 2."></a>設定シナリオ 2.</h3><p>メンテナンス構成設定を追加した日時 1/1 9:00</p><h4 id="設定内容-1"><a href="#設定内容-1" class="headerlink" title="設定内容"></a>設定内容</h4><ul><li>開始日 1/31 5:00 </li><li>終了日 2/28 23:00</li><li>メンテナンス期間 ５時間</li></ul><h4 id="実際の動作-1"><a href="#実際の動作-1" class="headerlink" title="実際の動作"></a>実際の動作</h4><p>2/10 に計画メンテナンスがある場合、メンテナンスウィンドウ設定に従い、 2/10 5:00 ～ 10:00 の間にメンテナンスが発生します</p><hr><h3 id="設定シナリオ-3"><a href="#設定シナリオ-3" class="headerlink" title="設定シナリオ 3."></a>設定シナリオ 3.</h3><p>メンテナンス構成設定を追加した日時 1/1 9:00</p><h4 id="設定内容-2"><a href="#設定内容-2" class="headerlink" title="設定内容"></a>設定内容</h4><ul><li>開始日 1/31 5:00 </li><li>メンテナンス期間 5 時間</li></ul><h4 id="実際の動作-2"><a href="#実際の動作-2" class="headerlink" title="実際の動作"></a>実際の動作</h4><p>1/15 に計画メンテナンスがある場合、<strong>メンテナンス構成設定は働かず</strong>、元々の計画メンテナンスの予定通り 1/15 にメンテナンスが実行されます</p><h2 id="運用上注意すべき点"><a href="#運用上注意すべき点" class="headerlink" title="運用上注意すべき点"></a>運用上注意すべき点</h2><ul><li>メンテナンス構成設定は制御対象ゲートウェイリソースと同じリージョンに設定する必要があります</li><li>メンテナンスウィンドウは最低 5 時間必要です</li><li>障害、セキュリティ対応など緊急性が要求されるメンテナンスについては制御対象外です</li><li>設定が即時反映されるわけではなく、反映までに最大 24 時間かかることがございます。</li><li>VPNGW basic SKU は非対応です</li><li>P2S GW 非対応です</li><li>現状 daily スケジュール( 1 日単位のスケジュール )のみ使用可能です</li></ul><ul><li>ご参考: <a href="https://learn.microsoft.com/ja-jp/azure/vpn-gateway/vpn-gateway-vpn-faq#customer-controlled">顧客が管理するゲートウェイのメンテナンス</a></li></ul><h2 id="今後の予定"><a href="#今後の予定" class="headerlink" title="今後の予定"></a>今後の予定</h2><p>VirtualWAN 仮想ハブルータ, P2S GW, Application Gateway, Azure Firewall への対応時期は未定です</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;/p&gt;
&lt;p&gt;Azure ゲートウェイサービスでは以前からお客様よりメンテナンスのコントロールについてご要望をいただいておりました。&lt;br&gt;2023 年 11 月よりプレビュー中の機能とはなりますが、メンテナンスコ</summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="ExpressRoute" scheme="https://jpaztech.github.io/blog/tags/ExpressRoute/"/>
    
    <category term="VPN Gateway" scheme="https://jpaztech.github.io/blog/tags/VPN-Gateway/"/>
    
    <category term="FAQ" scheme="https://jpaztech.github.io/blog/tags/FAQ/"/>
    
  </entry>
  
  <entry>
    <title>Azure Network 製品について TLS 1.2 以降に移行するアナウンスの補足 (Tracking ID:7_8G-D8Z)</title>
    <link href="https://jpaztech.github.io/blog/network/tls1.2_migration/"/>
    <id>https://jpaztech.github.io/blog/network/tls1.2_migration/</id>
    <published>2024-02-27T00:10:00.000Z</published>
    <updated>2024-07-03T06:47:12.921Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。<br>「2024 年 10 月 31 日までに、各種 Azure サービスとの通信に TLS 1.2 を使用していることを確認してください。」（Ensure your resources that interact with Azure services are using TLS 1.2 by 31 October 2024）の通知について補足させて頂きます。</p><p>メールに記載されておりますとおり、セキュリティとコンプライアンスの観点からレガシー TLS 1.0/1.1 は既知の脆弱性が存在しており、Azure 上のマネージド サービス全般におきまして、2024 年 10 月 31 日以降は TLS 1.2 以上の接続が必須となるよう変更されるものです。</p><h2 id="TLS-バージョンとは"><a href="#TLS-バージョンとは" class="headerlink" title="TLS バージョンとは"></a>TLS バージョンとは</h2><p>TLS（Transport Layer Security）は、インターネット上でデータを安全に送受信するための暗号化する仕組みとして、主に TLS 1.0, TLS 1.1、TLS 1.2 及び TLS 1.3 バージョンが存在していますが、<a href="https://datatracker.ietf.org/doc/html/rfc8996">RFC 8996</a> により、セキュリティ脆弱性の原因で、TLS 1.0 及び TLS 1.1 の使用は既に廃止されています。Azure サービスでは、互換性の理由で TLS 1.0 及び TLS 1.1 が引き続き動作できますが、早めに TLS 1.2 以降のバージョンへ移行するのは強く推奨しております。</p><h2 id="TLS-接続時のバージョン選定動作について"><a href="#TLS-接続時のバージョン選定動作について" class="headerlink" title="TLS 接続時のバージョン選定動作について"></a>TLS 接続時のバージョン選定動作について</h2><p>TLS のバージョンはお客様の IaaS 上の仮想マシン OS の設定、ならびにクライアント OS に依存します。こちらの設定確認をし、TLS 1.2 以上を使用できる状態としていただくことで、自動的に TLS の最上位バージョンでの接続を試みることとなります。</p><h3 id="Windows-OS-の場合"><a href="#Windows-OS-の場合" class="headerlink" title="Windows OS の場合"></a>Windows OS の場合</h3><p><a href="https://learn.microsoft.com/ja-jp/security/engineering/solving-tls1-problem#supported-versions-of-tls-in-windows">こちらの公開ドキュメント</a>の記載通り、Windows 8/Windows Server 2012 以降では、既に TLS 1.2 をサポートしているため、基本的にご対応頂く必要はありません。<br>また、特定の TLS バージョンを有効化/無効化されたい場合は、<a href="https://jpwinsup.github.io/blog/2021/12/22/PublicKeyInfrastructure/SSLTLSConnection/tls-registry-settings/">こちらの記事</a>の通りご対応ください。</p><p>Windows 2008/ Windows 7 などのレガシー OS でも更新プログラムを適用することで技術的には TLS 1.2 を使えるようになります。ただし、サポートの提供が終了している OS の場合には、TLS 1.2 を利用できるようになる更新プログラムの適用にかかわらず、技術的なご支援を Microsoft サポートからお届けすることはできません。自己責任の範疇でご利用ください。</p><p>参考として、Android など他のクライアント対応状況は<a href="https://learn.microsoft.com/ja-jp/security/engineering/solving-tls1-problem#appendix-a-handshake-simulation">こちら</a>の公開ドキュメントに開示されています。 </p><h3 id="Chrome-Edge-などのブラウザの場合"><a href="#Chrome-Edge-などのブラウザの場合" class="headerlink" title="Chrome/Edge などのブラウザの場合"></a>Chrome/Edge などのブラウザの場合</h3><p>最新バージョンの各ブラウザでは、基本的に TLS 1.2 以降のバージョンが有効化されているため、ご対応頂く必要はありませんが、<br>特定の TLS バージョンを有効化/無効化されたい場合は、各ブラウザ観点でご確認頂く必要がございます。<br>Edgeの場合は<a href="https://learn.microsoft.com/en-us/answers/questions/487582/is-there-a-way-to-emable-tls-1-0-and-or-1-2-on-edg">こちらの記事</a>の通り対応できます。</p><h3 id="それ以外の場合"><a href="#それ以外の場合" class="headerlink" title="それ以外の場合"></a>それ以外の場合</h3><p>上記以外に、Java などプログラミング言語でお客様が開発したアプリケーションで Azure サービスへ接続する場合は、Windows OS の TLS レジストリ設定を参照せず、独自の設定通り接続する場合がありますので、お客様側にアプリケーション観点で TLS の通信バージョンご確認及びご対応頂く必要があります。</p><h3 id="TLS-チェッカー-ツール"><a href="#TLS-チェッカー-ツール" class="headerlink" title="TLS チェッカー ツール"></a>TLS チェッカー ツール</h3><p><a href="https://clienttest.ssllabs.com:8443/ssltest/viewMyClient.html">こちら</a>のような外部の TLS チェッカー ツールをご活用いただき、想定されるクライアントからアクセスをして TLS バージョンを確認いただくということも有効です。</p><h2 id="Azure-Network製品の対応状況及び推奨アクションについて"><a href="#Azure-Network製品の対応状況及び推奨アクションについて" class="headerlink" title="Azure Network製品の対応状況及び推奨アクションについて"></a>Azure Network製品の対応状況及び推奨アクションについて</h2><p>以下にて Azure Network 製品の対応状況、及びお客様に推奨なアクションをご紹介致します。<br>もしご確認されたい製品が入っていなく、個別にご確認されたい場合は、各製品に対してサポート リクエストを起票してください。</p><div class="alert is-warning"><p class="alert-title">警告</p><p>以下各製品の部分に案内する対処目処はあくまで目途であり、実際には日程が多少前後する可能性があります。予めご了承ください。</p></div><span id="more"></span><h2 id="Application-Gateway"><a href="#Application-Gateway" class="headerlink" title="Application Gateway"></a>Application Gateway</h2><h3 id="クライアントから-Application-Gateway-への接続について"><a href="#クライアントから-Application-Gateway-への接続について" class="headerlink" title="クライアントから Application Gateway への接続について"></a>クライアントから Application Gateway への接続について</h3><p>Application Gateway では、SSL ポリシーを選択することで、クライアントが Application Gateway へ接続する際の最小 TLS バージョン（1.0 から 1.3 まで）を設定できます。 </p><p>現時点では、Application Gateway は2024 年 10 月 31 日以降にも引き続き TLS1.0 から TLS1.3 をサポートしており、TLS1.2 以下のバージョンをサポートしなくなる予定はございません。 </p><p>ただし、<a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/application-gateway-configure-ssl-policy-powershell">こちらの公開ドキュメント</a>の記載通り、セキュリティ強化のためには TLS1.2 のご利用を推奨いたします。 </p><blockquote><p>注意<br>Application Gateway でのセキュリティを強化するために、TLS プロトコルの最小バージョンとして TLS 1.2 を使用することをお勧めします。</p></blockquote><h4 id="最小TLS-バージョンの設定方法"><a href="#最小TLS-バージョンの設定方法" class="headerlink" title="最小TLS バージョンの設定方法"></a>最小TLS バージョンの設定方法</h4><p>下図の通り、Azure ポータル → 対象 Application Gateway → 「リスナー」のタブにて、 「選択した SSL ポリシー」の「変更」ボタンをクリックし、「 SSL ポリシーの変更」より設定できます。<br><img src="./appgw_tls_setting.png"></p><p>また、Application Gateway SKU v2 の場合は、<a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/application-gateway-configure-listener-specific-ssl-policy">こちらの手順通り</a>、リスナー毎に異なる TLS バージョンを設定することも可能です。 </p><h3 id="Application-Gateway-からバックエンド-サーバーへの接続について"><a href="#Application-Gateway-からバックエンド-サーバーへの接続について" class="headerlink" title="Application Gateway からバックエンド サーバーへの接続について"></a>Application Gateway からバックエンド サーバーへの接続について</h3><p><a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/application-gateway-ssl-policy-overview#limitations">こちらの公開ドキュメント</a>の記載通り、Application Gateway がバックエンド サーバーへ通信する際に TLS 1.0, 1.1, 1.2 をサポートしております。 </p><blockquote><p>バックエンド サーバーへの接続は、常に最小でプロトコル TLS v1.0、最大で TLS v1.2 までです。 そのため、バックエンド サーバーとのセキュリティで保護された接続を確立するには、TLS バージョン 1.0、1.1、1.2 のみがサポートされます。</p></blockquote><p>具体的な TLS バージョンの選定は接続先のバックエンド サーバーに依存するため、もし最小 TLS バージョンを 1.2 に指定したい場合は、Application Gateway ではなく、バックエンド サーバー側の TLS 設定に対応して頂く必要があります。 </p><h2 id="Azure-Firewall"><a href="#Azure-Firewall" class="headerlink" title="Azure Firewall"></a>Azure Firewall</h2><p>Azure Firewall では、TLS バージョンが関わる部分は TLS インスペクションのみとなります。アプリケーション ルール、ネットワーク ルール、及び DNAT ルールで通信を許可する場合は本通知の対象外となります。</p><p>TLS インスペクション機能を使用する場合は、<a href="https://learn.microsoft.com/ja-jp/azure/firewall/premium-features#tls-inspection">こちらの公開ドキュメント</a>の記載通り、現状及び 2024 年 10 月 31 日以降にも TLS1.0 及び TLS1.1 は互換性のために引き続き動作する予定ですが、早めに TLS 1.2 に移行することを強く推奨します。</p><blockquote><p>ヒント<br>TLS 1.0 と 1.1 は非推奨になっていて、サポートされません。 TLS 1.0 と 1.1 のバージョンの TLS/SSL (Secure Sockets Layer) は脆弱であることが確認されています。現在、これらは下位互換性を維持するために使用可能ですが、推奨されていません。 できるだけ早く TLS 1.2 に移行してください。</p></blockquote><p>また、現状の TLS インスペクション機能では TLS1.3 をサポートしておりません。</p><h2 id="Front-Door"><a href="#Front-Door" class="headerlink" title="Front Door"></a>Front Door</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/frontdoor/end-to-end-tls?pivots=front-door-standard-premium#supported-tls-versions">こちらの公開ドキュメント</a>の記載通り、 Front Door ではカスタム ドメインを利用する場合は、最小 TLS バージョンを 1.0 または 1.2 を選択できます。 </p><blockquote><p>Azure Front Door では、TLS プロトコルの 4 つのバージョン (TLS バージョン 1.0、1.1、1.2、1.3) がサポートされています。 2019 年 9 月以降に作成されたすべての Azure Front Door プロファイルでは、TLS 1.3 が有効になっている既定の最小値として TLS 1.2 が使用されますが、TLS 1.0 と TLS 1.1 は下位互換性のために引き続きサポートされています。</p></blockquote><p>Front Door では 2024 年 10 月 31 日以降も引き続き TLS 1.0 から TLS 1.3 まで利用できますが、セキュリティ強化のためには TLS 1.2 以上のご利用を推奨いたします。 </p><h2 id="Private-Link-Service-または-Private-Endpoint"><a href="#Private-Link-Service-または-Private-Endpoint" class="headerlink" title="Private Link Service または Private Endpoint"></a>Private Link Service または Private Endpoint</h2><p>Private Link Service と Private Endpoint のサービスでは、TLS プロトコルは終端しません。<br>Private Link Service と Private Endpoint を利用した通信の場合には、クライアントとサーバーの通信上の両端で TLS ネゴシエーションが実施されます。クライアントおよびサーバーとなるサービスの観点でご確認頂く必要があります。 </p><h2 id="Bastion"><a href="#Bastion" class="headerlink" title="Bastion"></a>Bastion</h2><p>Bastion はお客様側で証明書の管理運用を意識する必要のないサービスとして、<a href="https://learn.microsoft.com/ja-jp/azure/bastion/bastion-overview#key">以下の公開ドキュメント</a>の記載通り、 TLS 1.2 のみをサポートしておりますので、お客様側の対処が不要です。 </p><blockquote><p>Bastion では、TLS 1.2 がサポートされています。 以前の TLS バージョンはサポートされません。</p></blockquote><h2 id="Traffic-Manager"><a href="#Traffic-Manager" class="headerlink" title="Traffic Manager"></a>Traffic Manager</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/traffic-manager/traffic-manager-how-it-works#how-clients-connect-using-traffic-manager">こちらの公開ドキュメント</a>の説明通り、TrafficManager は DNS レベルで動作する負荷分散サービスとして、クライアントからの通信は TrafficManager を経由しませんので、本通知の対象外となります。 </p><h2 id="Load-Balancer"><a href="#Load-Balancer" class="headerlink" title="Load Balancer"></a>Load Balancer</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/load-balancer/load-balancer-faqs#azure-load-balancer---tls-ssl---------------">こちらの公開ドキュメント</a>記載通り、Azure Load Balancer では、TLS 接続を終端せずにバックエンド サーバーへ転送する動作となりますので、本通知の対象外となります。 </p><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;br&gt;「2024 年 10 月 31 日までに、各種 Azure サービスとの通信に TLS 1.2 を使用していることを確認してください。」（Ensure your resources that interact with Azure services are using TLS 1.2 by 31 October 2024）の通知について補足させて頂きます。&lt;/p&gt;
&lt;p&gt;メールに記載されておりますとおり、セキュリティとコンプライアンスの観点からレガシー TLS 1.0/1.1 は既知の脆弱性が存在しており、Azure 上のマネージド サービス全般におきまして、2024 年 10 月 31 日以降は TLS 1.2 以上の接続が必須となるよう変更されるものです。&lt;/p&gt;
&lt;h2 id=&quot;TLS-バージョンとは&quot;&gt;&lt;a href=&quot;#TLS-バージョンとは&quot; class=&quot;headerlink&quot; title=&quot;TLS バージョンとは&quot;&gt;&lt;/a&gt;TLS バージョンとは&lt;/h2&gt;&lt;p&gt;TLS（Transport Layer Security）は、インターネット上でデータを安全に送受信するための暗号化する仕組みとして、主に TLS 1.0, TLS 1.1、TLS 1.2 及び TLS 1.3 バージョンが存在していますが、&lt;a href=&quot;https://datatracker.ietf.org/doc/html/rfc8996&quot;&gt;RFC 8996&lt;/a&gt; により、セキュリティ脆弱性の原因で、TLS 1.0 及び TLS 1.1 の使用は既に廃止されています。Azure サービスでは、互換性の理由で TLS 1.0 及び TLS 1.1 が引き続き動作できますが、早めに TLS 1.2 以降のバージョンへ移行するのは強く推奨しております。&lt;/p&gt;
&lt;h2 id=&quot;TLS-接続時のバージョン選定動作について&quot;&gt;&lt;a href=&quot;#TLS-接続時のバージョン選定動作について&quot; class=&quot;headerlink&quot; title=&quot;TLS 接続時のバージョン選定動作について&quot;&gt;&lt;/a&gt;TLS 接続時のバージョン選定動作について&lt;/h2&gt;&lt;p&gt;TLS のバージョンはお客様の IaaS 上の仮想マシン OS の設定、ならびにクライアント OS に依存します。こちらの設定確認をし、TLS 1.2 以上を使用できる状態としていただくことで、自動的に TLS の最上位バージョンでの接続を試みることとなります。&lt;/p&gt;
&lt;h3 id=&quot;Windows-OS-の場合&quot;&gt;&lt;a href=&quot;#Windows-OS-の場合&quot; class=&quot;headerlink&quot; title=&quot;Windows OS の場合&quot;&gt;&lt;/a&gt;Windows OS の場合&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://learn.microsoft.com/ja-jp/security/engineering/solving-tls1-problem#supported-versions-of-tls-in-windows&quot;&gt;こちらの公開ドキュメント&lt;/a&gt;の記載通り、Windows 8/Windows Server 2012 以降では、既に TLS 1.2 をサポートしているため、基本的にご対応頂く必要はありません。&lt;br&gt;また、特定の TLS バージョンを有効化/無効化されたい場合は、&lt;a href=&quot;https://jpwinsup.github.io/blog/2021/12/22/PublicKeyInfrastructure/SSLTLSConnection/tls-registry-settings/&quot;&gt;こちらの記事&lt;/a&gt;の通りご対応ください。&lt;/p&gt;
&lt;p&gt;Windows 2008/ Windows 7 などのレガシー OS でも更新プログラムを適用することで技術的には TLS 1.2 を使えるようになります。ただし、サポートの提供が終了している OS の場合には、TLS 1.2 を利用できるようになる更新プログラムの適用にかかわらず、技術的なご支援を Microsoft サポートからお届けすることはできません。自己責任の範疇でご利用ください。&lt;/p&gt;
&lt;p&gt;参考として、Android など他のクライアント対応状況は&lt;a href=&quot;https://learn.microsoft.com/ja-jp/security/engineering/solving-tls1-problem#appendix-a-handshake-simulation&quot;&gt;こちら&lt;/a&gt;の公開ドキュメントに開示されています。 &lt;/p&gt;
&lt;h3 id=&quot;Chrome-Edge-などのブラウザの場合&quot;&gt;&lt;a href=&quot;#Chrome-Edge-などのブラウザの場合&quot; class=&quot;headerlink&quot; title=&quot;Chrome/Edge などのブラウザの場合&quot;&gt;&lt;/a&gt;Chrome/Edge などのブラウザの場合&lt;/h3&gt;&lt;p&gt;最新バージョンの各ブラウザでは、基本的に TLS 1.2 以降のバージョンが有効化されているため、ご対応頂く必要はありませんが、&lt;br&gt;特定の TLS バージョンを有効化/無効化されたい場合は、各ブラウザ観点でご確認頂く必要がございます。&lt;br&gt;Edgeの場合は&lt;a href=&quot;https://learn.microsoft.com/en-us/answers/questions/487582/is-there-a-way-to-emable-tls-1-0-and-or-1-2-on-edg&quot;&gt;こちらの記事&lt;/a&gt;の通り対応できます。&lt;/p&gt;
&lt;h3 id=&quot;それ以外の場合&quot;&gt;&lt;a href=&quot;#それ以外の場合&quot; class=&quot;headerlink&quot; title=&quot;それ以外の場合&quot;&gt;&lt;/a&gt;それ以外の場合&lt;/h3&gt;&lt;p&gt;上記以外に、Java などプログラミング言語でお客様が開発したアプリケーションで Azure サービスへ接続する場合は、Windows OS の TLS レジストリ設定を参照せず、独自の設定通り接続する場合がありますので、お客様側にアプリケーション観点で TLS の通信バージョンご確認及びご対応頂く必要があります。&lt;/p&gt;
&lt;h3 id=&quot;TLS-チェッカー-ツール&quot;&gt;&lt;a href=&quot;#TLS-チェッカー-ツール&quot; class=&quot;headerlink&quot; title=&quot;TLS チェッカー ツール&quot;&gt;&lt;/a&gt;TLS チェッカー ツール&lt;/h3&gt;&lt;p&gt;&lt;a href=&quot;https://clienttest.ssllabs.com:8443/ssltest/viewMyClient.html&quot;&gt;こちら&lt;/a&gt;のような外部の TLS チェッカー ツールをご活用いただき、想定されるクライアントからアクセスをして TLS バージョンを確認いただくということも有効です。&lt;/p&gt;
&lt;h2 id=&quot;Azure-Network製品の対応状況及び推奨アクションについて&quot;&gt;&lt;a href=&quot;#Azure-Network製品の対応状況及び推奨アクションについて&quot; class=&quot;headerlink&quot; title=&quot;Azure Network製品の対応状況及び推奨アクションについて&quot;&gt;&lt;/a&gt;Azure Network製品の対応状況及び推奨アクションについて&lt;/h2&gt;&lt;p&gt;以下にて Azure Network 製品の対応状況、及びお客様に推奨なアクションをご紹介致します。&lt;br&gt;もしご確認されたい製品が入っていなく、個別にご確認されたい場合は、各製品に対してサポート リクエストを起票してください。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;[!WARNING]&lt;br&gt;以下各製品の部分に案内する対処目処はあくまで目途であり、実際には日程が多少前後する可能性があります。予めご了承ください。&lt;/p&gt;
&lt;/blockquote&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
  </entry>
  
  <entry>
    <title>Application Gateway からの 500 番台の HTTP 応答について</title>
    <link href="https://jpaztech.github.io/blog/network/appgw-http-response-codes-5xx-server-error/"/>
    <id>https://jpaztech.github.io/blog/network/appgw-http-response-codes-5xx-server-error/</id>
    <published>2024-02-22T08:30:00.000Z</published>
    <updated>2024-07-03T06:47:12.869Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure サポート チームの間島です。</p><p>今回は、Application Gateway 経由で Web サイトへアクセスしている際に、Application Gateway からの HTTP 応答でエラーが発生した場合の原因や調査方法などについてご紹介させていただき、特にお客様よりお問い合わせをいただく機会が多い 500 番台の HTTP 応答について、お客様が問題判別を行う際の参考にしていただくことを目的としております。(なお、V1 SKU は廃止となることが発表されておりますので、当ブログの対象外とさせていただいております。)</p><h2 id="Application-Gateway-からの-HTTP-応答の確認方法"><a href="#Application-Gateway-からの-HTTP-応答の確認方法" class="headerlink" title="Application Gateway からの HTTP 応答の確認方法"></a>Application Gateway からの HTTP 応答の確認方法</h2><p>Application Gateway からは、状況に応じて、様々な HTTP 応答コードが返されます。<br><a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/http-response-codes">Application Gateway の HTTP 応答コード</a><br>HTTP 応答コードの確認方法ですが、Azure ポータルより、関連するメトリックを参照することが可能です。<br><a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/application-gateway-metrics#application-gateway-metrics">Application Gateway メトリック</a></p><div class="alert is-success"><p class="alert-title">ヒント</p><p>メトリックを確認する際には、上流側 (Up Stream = データ配信側 = バックエンド側) から先に確認してください。(下に記載した各項目は、上流から順に並べています)</p></div><h4 id="異常なホストの数-Unhealthy-Host-Count"><a href="#異常なホストの数-Unhealthy-Host-Count" class="headerlink" title="- 異常なホストの数 (Unhealthy Host Count)"></a>- 異常なホストの数 (Unhealthy Host Count)</h4><p>このメトリックは、正常性プローブによって異常であると判定されたバックエンドの数を表します。バックエンド プールごとにフィルター処理を行って、特定のバックエンド プールの異常なホストの数を表示することも可能です。Application Gateway が バックエンド プールにリクエストを転送するためには、該当のバックエンド プールへの正常性プローブが成功している必要があります。もし、想定外の「異常なホスト」が発生している場合には、下のリンク先を参照し、該当のバックエンド サーバーへの正常性プローブが成功するよう、問題判別を行ってください。<br><a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/application-gateway-backend-health-troubleshooting">Application Gateway のバックエンドの正常性に関する問題のトラブルシューティング</a></p><h4 id="バックエンド応答の状態-Backend-Response-Status"><a href="#バックエンド応答の状態-Backend-Response-Status" class="headerlink" title="- バックエンド応答の状態 (Backend Response Status)"></a>- バックエンド応答の状態 (Backend Response Status)</h4><p>バックエンド サーバーから Application Gateway に返された HTTP 応答コードの数を表します。(Application Gateway によって生成された HTTP 応答コードは含まれません。) HTTP 応答コードの分布をさらに分類し、2xx、3xx、4xx、5xx のカテゴリで応答を表示できます。Application Gateway は、基本的には、バックエンド サーバーによって返された HTTP 応答コードをクライアントに転送しますので、バックエンド サーバーが想定外の HTTP 応答コードを返している場合には、バックエンド サーバー側にて問題判別を行ってください。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>IIS がバックエンド サーバーの場合には、下のリンク先をご参照いただき、IIS ログをご確認ください。</p><p><a href="https://jpdsi.github.io/blog/web-apps/LogCollection1/#2-IIS-%E3%83%AD%E3%82%B0">IIS の調査に必要な基本的なログ情報について</a></p></div><h4 id="応答の状態-Response-Status"><a href="#応答の状態-Response-Status" class="headerlink" title="- 応答の状態 (Response Status)"></a>- 応答の状態 (Response Status)</h4><p>Application Gateway からクライアントに返された HTTP 応答コードの数を表します。応答状態コードの分布をさらに分類し、2xx、3xx、4xx、5xx のカテゴリで応答を表示できます。</p><h4 id="失敗した要求-Failed-Requests"><a href="#失敗した要求-Failed-Requests" class="headerlink" title="- 失敗した要求 (Failed Requests)"></a>- 失敗した要求 (Failed Requests)</h4><p>Application Gateway が 5xx サーバー エラーコードで処理した要求の数です。これには、Application Gateway から生成された 5xx コードと、バックエンドから生成された 5xx のコードが含まれます。<br>要求の数をさらにフィルター処理することで、各々のまたは特定のバックエンド プール http 設定の組み合わせごとに数を表示できます。</p><div class="alert is-success"><p class="alert-title">ヒント</p><p>上記のメトリックにて、バックエンド サーバーもしくは Application Gateway にて、どのような HTTP 応答コードを返しているかを確認した後に、下の HTTP 応答コード毎の発生原因 / 問題判別方法 に進んでください。</p><p>また HTTP 応答コードは、「診断ログ」にてアクセス ログを有効化することにより確認することも可能です。</p></div><h2 id="500-番台の-HTTP-応答コード毎の発生原因-問題判別方法"><a href="#500-番台の-HTTP-応答コード毎の発生原因-問題判別方法" class="headerlink" title="500 番台の HTTP 応答コード毎の発生原因 / 問題判別方法"></a>500 番台の HTTP 応答コード毎の発生原因 / 問題判別方法</h2><p>500 から 599 の HTTP 応答コードは、クライアントからの要求の実行中に Application Gateway または バックエンド サーバーにおいて問題が発生したことを示しています。</p><h4 id="502-無効なゲートウェイ-バックエンド-サーバーが原因であることが多い"><a href="#502-無効なゲートウェイ-バックエンド-サーバーが原因であることが多い" class="headerlink" title="- 502 - 無効なゲートウェイ (バックエンド サーバーが原因であることが多い)"></a>- 502 - 無効なゲートウェイ (バックエンド サーバーが原因であることが多い)</h4><p>Application Gateway が 502 エラーを返す理由はいくつかありますが、まずは前述のように、正常性プローブが成功しているかどうか確認してください。502 エラーは、お客様からのお問い合わせが最も多いエラーですが、前述のように Application Gateway から バックエンド プールへの正常性プローブが失敗しているため、発生しているケースが多く見受けられます。<br><a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/application-gateway-backend-health-troubleshooting">Application Gateway のバックエンドの正常性に関する問題のトラブルシューティング</a></p><p>また、502 エラーの原因といたしましては、下記などもあげられます。</p><ul><li>ネットワーク セキュリティ グループ (NSG)、ユーザー定義ルート (UDR)、またはカスタム DNS に関する問題</li><li>既定の正常性プローブに関する問題</li><li>カスタムの正常性プローブに関する問題</li><li>要求のタイムアウト</li><li>空の BackendAddressPool</li><li>BackendAddressPool の異常なインスタンス</li></ul><p>502 エラーにつきましては、過去にもブログにて取り上げておりますので、下のリンク先もご参照いただければと思います。<br><a href="https://jpaztech.github.io/blog/archive/application-gateway-502-error-info/">Application Gateway における 502 Error について</a><br><a href="https://jpaztech.github.io/blog/network/appgw-502error/">Application Gateway の散発的な 502 エラー</a></p><h4 id="504-ゲートウェイ-タイムアウト-処理時間の長い-Web-アプリケーションで発生することが多い"><a href="#504-ゲートウェイ-タイムアウト-処理時間の長い-Web-アプリケーションで発生することが多い" class="headerlink" title="- 504 - ゲートウェイ タイムアウト (処理時間の長い Web アプリケーションで発生することが多い)"></a>- 504 - ゲートウェイ タイムアウト (処理時間の長い Web アプリケーションで発生することが多い)</h4><p>バックエンド サーバーからの応答時間が、「要求のタイムアウト」値 (既定値 : 20 秒) を超えた場合には、HTTP 504 エラーが発生します。問題判別の方法としては、</p><ol><li>バックエンド サーバー側にて、ログをご確認いただき、Application Gateway からのリクエストに対して、バックエンド サーバーが「要求のタイムアウト」値を超えてレスポンスを返していないかどうか確認してください。</li><li>リクエスト受信からレスポンス送信までが 20 秒を超える場合には、「<a href="https://learn.microsoft.com/ja-jp/azure/application-gateway/application-gateway-troubleshooting-502#request-time-out">要求のタイムアウト</a>」の値を、アプリケーションの処理時間に合わせて、変更してください。(「要求のタイムアウト」の値は、1 ～ 86400 の範囲で設定可能) </li></ol><div class="alert is-success"><p class="alert-title">ヒント</p><p>IIS がバックエンド サーバーの場合には、下のリンク先をご参照いただき、IIS ログをご確認ください。</p><p><a href="https://jpdsi.github.io/blog/web-apps/LogCollection1/#2-IIS-%E3%83%AD%E3%82%B0">IIS の調査に必要な基本的なログ情報について</a></p></div><h4 id="500-内部サーバー-エラー-Application-Gateway-が原因"><a href="#500-内部サーバー-エラー-Application-Gateway-が原因" class="headerlink" title="- 500 - 内部サーバー エラー (Application Gateway が原因)"></a>- 500 - 内部サーバー エラー (Application Gateway が原因)</h4><p>この応答コードは、Application Gateway の内部でエラーが発生したことを示すものです。このコードが表示された場合は、サポート リクエストを起票してください。</p><div class="alert is-important"><p class="alert-title">重要</p><p>サポート リクエスト起票の際には、下記の情報を添えてお問い合わせいただければと思います。</p><p>・問題発生日時 (mm/dd hh:mm:ss)</p><p>・Application Gateway のリソース ID</p><p>・クライアントの情報 (パブリック IP アドレス等、仮想マシンの場合は リソース ID)</p><p>・アクセスした URL</p><p>・HTTP 応答コード</p><p>・お客様にて行った問題判別の内容や確認の結果 (例 : バックエンド サーバーのログの確認結果等)</p><p>・問題発生の前後にて Application Gateway やバックエンド サーバーにて行った設定変更内容 (もしあれば) </p></div><p>当ブログが、お客様よりお問い合わせをいただくことが多い 500 番台の HTTP 応答が発生した場合に、お客様にて問題判別を行う際の手助けになりましたら、幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure サポート チームの間島です。&lt;/p&gt;
&lt;p&gt;今回は、Application Gateway 経由で Web サイトへアクセスしている際に、Application Gateway からの HTTP 応答でエラーが発生した場合の原因や調査方法などについて</summary>
      
    
    
    
    
    <category term="Application Gateway" scheme="https://jpaztech.github.io/blog/tags/Application-Gateway/"/>
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Error" scheme="https://jpaztech.github.io/blog/tags/Error/"/>
    
    <category term="500" scheme="https://jpaztech.github.io/blog/tags/500/"/>
    
  </entry>
  
  <entry>
    <title>Azure Firewall Premium における TLS 検査用の中間 CA 証明書作成方法の違い</title>
    <link href="https://jpaztech.github.io/blog/network/fw-tls-cert/"/>
    <id>https://jpaztech.github.io/blog/network/fw-tls-cert/</id>
    <published>2024-02-20T03:00:00.000Z</published>
    <updated>2024-07-03T06:47:12.897Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの中野です。<br>本ブログでは、Azure Firewall Premium でご利用いただける「TLS 検査」に用いる中間 CA 証明書の作成方法の違いについてご案内いたします。</p><span id="more"></span><h2 id="中間-CA-証明書の要件"><a href="#中間-CA-証明書の要件" class="headerlink" title="中間 CA 証明書の要件"></a>中間 CA 証明書の要件</h2><p>まず前提として、Azure Firewall の観点では、Azure Firewall が参照する中間 CA 証明書によって、TLS 検査を行うためのサーバー証明書が作成できるのであれば、中間 CA 証明書を発行した CA の種別は問いません。  </p><ul><li>参考: <a href="https://learn.microsoft.com/ja-jp/azure/firewall/premium-certificates#certificates-used-by-azure-firewall-premium">Azure Firewall Premium によって使用される証明書</a></li></ul><blockquote><p>Azure Firewall Premium の TLS 検査を適切に構成するには、有効な中間 CA 証明書を用意し、それを Azure Key Vault に格納する必要があります。</p></blockquote><p>上記で抜粋した <code>有効な中間 CA 証明書</code> に関しまして、Azure Firewall の TLS 検査に必要な中間 CA 証明書の要件は下記のドキュメントの通りとなります。<br>こちらの要件を満たした中間 CA 証明書であれば、どの CA から発行されたものであっても、検証環境 / 運用環境を問わずご使用いただくことが可能です。</p><ul><li>参考: <a href="https://learn.microsoft.com/ja-jp/azure/firewall/premium-certificates#intermediate-ca-certificate-requirements">中間 CA 証明書の要件</a></li></ul><blockquote><p>・Key Vault シークレットとしてデプロイする場合、証明書と秘密キーを使用するパスワードレス PFX (PKCS12) を使用する必要があります。<br>・PEM 証明書はサポートされていません。<br>・単一の証明書でなければならず、証明書チェーン全体を含めることはできません。<br>・今後 1 年間有効でなければなりません。<br>・最小サイズが 4096 バイトである RSA 秘密キーでなければなりません。<br>・KeyCertSign フラグによって Critical とマーク付けされた KeyUsage 拡張が必要です (RFC 5280、4.2.1.3 Key Usage)。<br>・Critical とマーク付けされた BasicConstraints 拡張が必要です (RFC 5280、4.2.1.9 Basic Constraints)。<br>・CA フラグが TRUE に設定されている必要があります。<br>・パスの長さは 1 以上でなければなりません。<br>・証明書はエクスポートできる必要があります。  </p></blockquote><h2 id="TLS-検査でご利用いただける証明書について"><a href="#TLS-検査でご利用いただける証明書について" class="headerlink" title="TLS 検査でご利用いただける証明書について"></a>TLS 検査でご利用いただける証明書について</h2><p><a href="https://learn.microsoft.com/ja-jp/azure/firewall/premium-certificates">こちら</a> のドキュメントに記載の通り、TLS 検査で使用可能な中間 CA 証明書は下記の 3 つの方法で作成していただけます。</p><ol><li>エンタープライズ PKI</li><li>openssl コマンドによる手動生成 </li><li>Azure Firewall による自動生成</li></ol><p>以下の表は 3 つの方法の簡単な比較表となります。 </p><p><img src="/blog/network/fw-tls-cert/azfwtls_table.png"> </p><p>下記にそれぞれの生成方法についての詳細をご説明いたします。 </p><h2 id="1-エンタープライズ-PKI"><a href="#1-エンタープライズ-PKI" class="headerlink" title="(1) エンタープライズ PKI"></a>(1) エンタープライズ PKI</h2><p>エンタープライズ PKI としては「エンタープライズ CA」と「スタンドアロン CA」が存在します。  </p><h3 id="1-1-エンタープライズ-CA-こちらを用いた証明書作成手順の詳細は、ドキュメント-に記載がございます"><a href="#1-1-エンタープライズ-CA-こちらを用いた証明書作成手順の詳細は、ドキュメント-に記載がございます" class="headerlink" title="(1-1) エンタープライズ CA  (こちらを用いた証明書作成手順の詳細は、ドキュメント に記載がございます)"></a>(1-1) エンタープライズ CA  (こちらを用いた証明書作成手順の詳細は、<a href="https://learn.microsoft.com/ja-jp/azure/firewall/premium-deploy-certificates-enterprise-ca">ドキュメント</a> に記載がございます)</h3><ul><li>オンプレミスの Active Directory 環境でのみ構築可能 （Azure AD DS 環境では Enterprise Admins の権限を保有できないため構築不可）  </li><li>作成された証明書は配布作業を行わなくとも AD ドメインに参加している各クライアント端末において、デフォルトで「信頼された証明書」となる  </li><li>企業内のプライベート CA であるため、少なくとも企業内においては信頼された CA であると認識され、これによって発行された証明書は自己署名証明書よりもセキュリティ面で優位であると認識される  </li><li>証明書の有効期限は任意に設定可能</li></ul><h3 id="1-2-スタンドアロン-CA"><a href="#1-2-スタンドアロン-CA" class="headerlink" title="(1-2) スタンドアロン CA"></a>(1-2) スタンドアロン CA</h3><ul><li>Azure AD DS 環境でも構築可能</li><li>証明書テンプレートが使用できない</li><li>デフォルトではクライアント端末において「信頼された証明書」ではないため、各クライアント端末にルート証明書の配布が必要</li><li>作成された証明書は グループ ポリシー (GPO) を用いてドメイン参加している各クライアント端末に一括配布可能**</li><li>企業内のプライベート CA であるため、少なくとも企業内においては信頼された CA であると認識され、これによって発行された証明書は自己署名証明書よりもセキュリティ面で優位であると認識される  </li><li>証明書の有効期限は任意に設定可能  </li></ul><p>**参考: <a href="https://learn.microsoft.com/ja-jp/windows-server/identity/ad-fs/deployment/distribute-certificates-to-client-computers-by-using-group-policy">グループ ポリシーを使用してクライアント コンピューターに証明書を配布する</a>  </p><h2 id="3-openssl-コマンドによる手動生成"><a href="#3-openssl-コマンドによる手動生成" class="headerlink" title="(3) openssl コマンドによる手動生成"></a>(3) openssl コマンドによる手動生成</h2><ul><li>自己署名証明書である</li><li>デフォルトではクライアント端末において「信頼された証明書」ではないため、各クライアント端末にルート証明書の配布が必要</li><li>作成された証明書は グループ ポリシー (GPO) を用いてドメイン参加している各クライアント端末に一括配布可能</li><li>証明書の有効期限は任意に設定可能</li></ul><h2 id="4-Azure-Firewall-による自動生成"><a href="#4-Azure-Firewall-による自動生成" class="headerlink" title="(4) Azure Firewall による自動生成"></a>(4) Azure Firewall による自動生成</h2><ul><li>自己署名証明書である</li><li>検証環境での使用を想定しているので、作成されるのはルート証明書である</li><li>デフォルトではクライアント端末において「信頼された証明書」ではないため、各クライアント端末にルート証明書の配布が必要</li><li>作成されたルート CA 証明書を Key Vault からエクスポートすることで、グループ ポリシー (GPO) を用いてドメイン参加している各クライアント端末に一括配布可能</li><li>新規に Key Vault、マネージド ID のリソースが作成される (既存のリソースは使用不可)</li><li>証明書の有効期限は 1 年固定 (1 年ごとに証明書の更新を行う必要があるので、1 年ごとに GPO で証明書の配布が必要)</li></ul><br>以上、ご参考になれば幸いです。<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/firewall/premium-certificates">Azure Firewall Premium の証明書</a></li><li><a href="https://techcommunity.microsoft.com/t5/azure-network-security-blog/building-a-poc-for-tls-inspection-in-azure-firewall/ba-p/3676723">HBuilding a POC for TLS inspection in Azure Firewall</a></li></ul><hr>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの中野です。&lt;br&gt;本ブログでは、Azure Firewall Premium でご利用いただける「TLS 検査」に用いる中間 CA 証明書の作成方法の違いについてご案内いたします。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="Azure Firewall" scheme="https://jpaztech.github.io/blog/tags/Azure-Firewall/"/>
    
    <category term="Certificate" scheme="https://jpaztech.github.io/blog/tags/Certificate/"/>
    
  </entry>
  
  <entry>
    <title>プライベート エンドポイントをご利用いただく上でのポイント</title>
    <link href="https://jpaztech.github.io/blog/network/pe-introduction/"/>
    <id>https://jpaztech.github.io/blog/network/pe-introduction/</id>
    <published>2024-02-20T03:00:00.000Z</published>
    <updated>2024-07-03T06:47:12.913Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの箕輪です。Azure のプライベート エンドポイントは Azure PaaS へのプライベート接続を実現できることから、多くのお客様にご利用いただいています。<br>Azure サポート担当でプライベート エンドポイントに関してお問い合わせいただく中で、プライベート エンドポイントをご利用いただく上でのポイントや、よくあるお問い合わせや情報採取についての内容を 2 回に分けてご紹介します。</p><ol><li>プライベート エンドポイントをご利用いただく上でのポイント  (今回のご紹介)</li><li><a href="/blog/network/pe-troubleshooting/">プライベート エンドポイントのよくあるお問い合わせ</a></li></ol><span id="more"></span><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>プライベート エンドポイントは主に Azure PaaS に対して、仮想ネットワーク上のアドレス空間のプライベート IP アドレスを用いて接続を提供するサービスです。<br>プライベート エンドポイントをご利用いただけば、Azure PaaS に対して、ExpressRoute や VPN で接続されたオンプレミスからもインターネット経由ではなく仮想ネットワーク経由で接続が可能です。<br>またこのブログでは紹介しませんが、Azure Load Balancer に対して適用できる <a href="https://learn.microsoft.com/ja-jp/azure/private-link/private-link-service-overview">Private Link Service</a> をご利用いただけば、アドレス空間が重複した仮想ネットワーク間でも接続が可能です。<br>類似機能のプライベート エンドポイントとサービス エンドポイントの違いについては、<a href="/blog/network/pe-difference-se/">別のブログ</a> で紹介していますのでご参照いただければと思います。</p><h2 id="基本動作"><a href="#基本動作" class="headerlink" title="基本動作"></a>基本動作</h2><p>Azure PaaS は基本的にパブリック インターネットからの接続を前提としています。また、ほとんどの Azure PaaS がマルチテナント構成となり、ご利用時に接続する際は、対象の Azure PaaS に該当する FQDN で接続します。<br>プライベート エンドポイントは仮想ネットワーク上にエンドポイントを構成することで、Azure PaaS にプライベート IP アドレスで接続する機能を提供していますが、クライアントが接続する際の FQDN は変わりません。<br>プライベート エンドポイントは、あくまで Azure PaaS への接続点を仮想ネットワーク上に構成するものであり、Azure PaaS へのプライベート接続は DNS レイヤーのルーティングで実現しています。<br>この時、DNS レイヤーのルーティングを privatelink サブドメインが付与された FQDN を用いて実施します。<br>つまり、プライベート エンドポイントをご利用いただく上で、DNS レイヤーの構成が大変重要な要素になります。</p><h2 id="DNS-レコードの遷移"><a href="#DNS-レコードの遷移" class="headerlink" title="DNS レコードの遷移"></a>DNS レコードの遷移</h2><p>Azure PaaS のプライベート エンドポイントを有効化することで、具体的にどのような変化が発生するのかをご紹介します。<br>ここでは東日本リージョンの Azure Blob Storage の FQDN (jpaztechpeblog.blob.core.windows.net) の DNS レコードの遷移をご紹介します。<br>なお説明の便宜上、dig コマンドで応答された ANSWER SECTION の表示を基にご紹介します。</p><p>まず、プライベート エンドポイントが有効化されていない Azure Blob Storage の FQDN を名前解決した時、下記のような DNS レコードが応答されます。下記の応答結果から、Azure Blob Storage に接続時の FQDN が、Azure Blob Storage のエンドポイントに CNAME レコードで変換され、その後 A レコードでパブリック IP アドレスが応答されることが確認できます。</p><blockquote><p>jpaztechpeblog.blob.core.windows.net. 60 IN CNAME blob.tyo20prdstr07a.store.core.windows.net.<br>blob.tyo20prdstr07a.store.core.windows.net. 60 IN A 20.60.248.65</p></blockquote><p>次に、Azure Blob Storage に対して、プライベート エンドポイントを有効化した時の DNS レコードの応答を確認します。<br>下記の応答結果から、プライベート エンドポイントが有効化された後に、<strong>privatelink サブドメイン</strong>が付与された FQDN が追加されたことが確認できます。</p><blockquote><p>jpaztechpeblog.blob.core.windows.net. 60 IN CNAME jpaztechpeblog.<strong>privatelink</strong>.blob.core.windows.net.<br>jpaztechpeblog.<strong>privatelink</strong>.blob.core.windows.net. 60 IN CNAME blob.tyo20prdstr07a.store.core.windows.net.<br>blob.tyo20prdstr07a.store.core.windows.net. 60 IN A 20.60.248.65</p></blockquote><p>上記の DNS レコードの遷移や応答結果は、ご利用いただくリージョンや各 Azure PaaS によっては細部が異なりますが、基本的には上記の例が大多数となっています。<br>各 Azure PaaS の FQDN がどのように遷移するかは<a href="https://learn.microsoft.com/ja-jp/azure/private-link/private-endpoint-dns">プライベート エンドポイントの公開情報</a> でご紹介しています。<br>なお、Azure PaaS によってはすべてのユーザーに同一の FQDN でエンドポイントを提供している下記のようなサービスもあり、この場合既定で privatelink サブドメインが付与されています。</p><p>・Azure Virtual Desktop : rdweb.wvd.microsoft.com / <foo>www</foo>.wvd.microsoft.com / client.wvd.microsoft.com </br><br>・Azure Synapse : web.azuresynapse.net </br><br>・Azure Data Factory : adf.azure.com </br></p><h2 id="DNS-ルーティング"><a href="#DNS-ルーティング" class="headerlink" title="DNS ルーティング"></a>DNS ルーティング</h2><p>Azure PaaS への接続をパブリック エンドポイントからプライベート エンドポイントに切り替えるには、DNS レイヤーの構成が重要になります。<br>この DNS レイヤーのルーティングについてご紹介します。<br>ここでは Azure の仮想ネットワーク上に仮想マシンをデプロイし、Azure Blob Storage に接続するシナリオを例に挙げて、DNS ルーティングについて説明します。</p><p>通常の Azure Blob Storage に接続する場合、下記の構成図のように接続時の FQDN に対してパブリック IP アドレスが応答され、クライアントは該当のパブリック IP アドレスに接続を試行します。</p><p><img src="/blog/network/pe-introduction/01.png" alt="通常の接続"></p><p>プライベート エンドポイントを有効化した際に、既定の設定では対象の Azure PaaS に対応するプライベート DNS ゾーンが構成されます。プライベート DNS ゾーンは仮想ネットワークとリンクすることで、Azure 既定の DNS (168.63.129.16) を参照しているクライアントに、構成したゾーンの DNS レコードを応答するサービスです。<br>Azure Blob Storage の場合、privatelink.blob.core.windows.net が該当ゾーンとしてデプロイされ、対象のホスト名に対して設定された A レコードが応答されます。これにより、仮想マシンはプライベート エンドポイントに対して Azure Blob Storage の FQDN の接続を試行します。<br>このように、プライベート DNS ゾーンを用いて privatelink サブドメインの DNS レコードをオーバーライドすることで、DNS ルーティングを実現します。</p><p><img src="/blog/network/pe-introduction/02.png" alt="PE経由の接続"></p><p>なお、プライベート エンドポイントの利用にあたり、プライベート DNS ゾーンの利用は必須ではありません。DNS レコードのオーバーライドができれば hosts ファイル、カスタム DNS、オンプレミスの DNS などでも DNS ルーティングが実現可能です。<br>例えば、仮想マシンの OS 上の hosts ファイルで、接続先の FQDN に対して、プライベート エンドポイントの IP アドレスを指定することでも構成可能です。</p><p>以上がプライベート エンドポイントの仕組みとなります。実際にご利用いただく中で、よくお問い合わせいただく内容や情報採取については、<a href="/blog/network/pe-troubleshooting/">こちら</a> をご覧ください。　</p><p>以上、ご参考になれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの箕輪です。Azure のプライベート エンドポイントは Azure PaaS へのプライベート接続を実現できることから、多くのお客様にご利用いただいています。&lt;br&gt;Azure サポート担当でプライベート エンドポイントに関してお問い合わせいただく中で、プライベート エンドポイントをご利用いただく上でのポイントや、よくあるお問い合わせや情報採取についての内容を 2 回に分けてご紹介します。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;プライベート エンドポイントをご利用いただく上でのポイント  (今回のご紹介)&lt;/li&gt;
&lt;li&gt;&lt;a href=&quot;/blog/network/pe-troubleshooting/&quot;&gt;プライベート エンドポイントのよくあるお問い合わせ&lt;/a&gt;&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="DNS" scheme="https://jpaztech.github.io/blog/tags/DNS/"/>
    
    <category term="PrivateEndpoint" scheme="https://jpaztech.github.io/blog/tags/PrivateEndpoint/"/>
    
  </entry>
  
  <entry>
    <title>プライベート エンドポイントのよくあるお問い合わせ</title>
    <link href="https://jpaztech.github.io/blog/network/pe-troubleshooting/"/>
    <id>https://jpaztech.github.io/blog/network/pe-troubleshooting/</id>
    <published>2024-02-20T03:00:00.000Z</published>
    <updated>2024-07-03T06:47:12.917Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの箕輪です。<br>Azure のプライベート エンドポイントは Azure PaaS へのプライベート接続を実現できることから、多くのお客様にご利用いただいています。<br>Azure サポート担当でプライベート エンドポイントに関してお問い合わせいただく中で、プライベート エンドポイントをご利用いただく上でのポイントや、よくあるお問い合わせや情報採取についての内容を 2 回に分けてご紹介します。</p><ol><li><a href="/blog/network/pe-introduction/">プライベート エンドポイントをご利用いただく上でのポイント</a></li><li>プライベート エンドポイントのよくあるお問い合わせ (今回のご紹介)</li></ol><span id="more"></span><h2 id="概要"><a href="#概要" class="headerlink" title="概要"></a>概要</h2><p>プライベート エンドポイントをご利用いただく上で、DNS レイヤーの構成がポイントになる点について、<a href="/blog/network/pe-introduction/">こちら</a>でご紹介しました。<br>今回は実際に構成する上でのよくあるトラブル事例や、Azure サポートにお問い合わせいただく際に情報提供いただきたい事項などを纏めました。</p><h2 id="情報採取"><a href="#情報採取" class="headerlink" title="情報採取"></a>情報採取</h2><p>プライベート エンドポイントのトラブルシューティングでは、DNS 構成を確認するために、クライアントの名前解決の状況を確認することが重要です。<br>そのため、Azure サポート担当にお問い合わせ時に下記の点について情報提供いただけると幸いです。</p><blockquote><p><strong>・接続元のクライアント情報</strong></br><br><strong>・接続先のプライベート エンドポイントのリソース情報</strong></br><br><strong>・接続経路</strong></br><br><strong>・接続元クライアントの DNS 構成</strong></br><br><strong>・接続元クライアントの名前解決の状況</strong></br></p></blockquote><p>上記についてそれぞれ補足致します。</p><blockquote><p><strong>・接続元クライアント情報</strong></p></blockquote><p>接続元クライアントが Azure 仮想マシンなど Azure 上のリソースであれば、該当の Azure リソース ID をご提供ください。<br>もしオンプレミス上の機器が接続元クライアントとなる場合、オンプレミスである旨と接続元クライアントの IP アドレスをご提供ください。</p><blockquote><p><strong>・接続先のプライベート エンドポイントのリソース情報</strong></p></blockquote><p>お問合せ時に対象のプライベート エンドポイントのリソースを選択可能な場合は、選択いただければ Azure サポート担当は対象のリソース情報を確認できます。<br>対象のプライベート エンドポイントのリソースを選択してお問い合わせが難しい場合、プライベート エンドポイントのリソース ID をご提供ください。</p><blockquote><p><strong>・接続経路</strong></p></blockquote><p>想定されている接続元クライアントからプライベート エンドポイントの接続経路についてご提供ください。<br>例えばオンプレミスからの接続の場合は ExpressRoute をご利用いただいている旨や、Azure Firewall で通信制御をされている、プロキシ サーバーをご利用いただいているなどの情報をご提供いただけると幸いです。</p><blockquote><p><strong>・接続元クライアントの DNS 構成</strong></p></blockquote><p>DNS 構成として hosts、オンプレミスの DNS サーバー、Azure DNS Private Resolver 、カスタム DNS など複数の構成方法がありますが、接続元クライアントのご状況に合わせて情報をご提供ください。<br>例えば、hosts で制御している場合は該当の hosts ファイルも併せてご提供いただけると幸いです。<br>接続元クライアントがオンプレミスの DNS サーバーを参照している場合、オンプレミスの DNS サーバーから Azure へのクエリ転送設定 (フォワーダー・条件付きフォワーダー) の状況も併せてご提供ください。<br>また、Azure DNS Private Resolver をご利用いただいている場合は、リソース ID をご提供ください。</p><blockquote><p><strong>・接続元クライアントの名前解決の状況</strong></p></blockquote><p>接続元クライアントの名前解決の確認方法はクライアントの実行環境によって異なります。<br>Azure サポート担当での調査では、下記の情報の提供をお願いする場合がありますため、事前にご提供いただけると幸いです。<br>(お客様の環境に沿って FQDN をご変更ください。)</p><p><strong>・ &lt;推奨&gt; PowerShell</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Get-Date -Format &quot;yyyy/MM/dd HH:mm:ss K&quot;</span><br><span class="line">Test-NetConnection contoso.blob.core.windows.net -port 443 </span><br><span class="line">Resolve-DnsName -name contoso.blob.core.windows.net</span><br><span class="line">nslookup -debug contoso.blob.core.windows.net</span><br><span class="line">Invoke-WebRequest -URI https://contoso.blob.core.windows.net/</span><br></pre></td></tr></table></figure><p>・ dig (Linux)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">date -u</span><br><span class="line">dig contoso.blob.core.windows.net</span><br><span class="line">curl -v contoso.blob.core.windows.net</span><br></pre></td></tr></table></figure><p>なお、パブリック インターネット上で名前解決の状況を確認する場合は、<a href="https://digwebinterface.com/">https://digwebinterface.com/</a> などでカスタマイズしたクエリが実行可能です。</p><h2 id="FAQ"><a href="#FAQ" class="headerlink" title="FAQ"></a>FAQ</h2><p>プライベート エンドポイントに関して、よくお問い合わせいただく内容について下記の通りお伝えいたします。</p><h3 id="プライベート-エンドポイントの-IP-アドレスの仕様について教えてください。"><a href="#プライベート-エンドポイントの-IP-アドレスの仕様について教えてください。" class="headerlink" title="プライベート エンドポイントの IP アドレスの仕様について教えてください。"></a>プライベート エンドポイントの IP アドレスの仕様について教えてください。</h3><p>プライベート エンドポイントの IP アドレスは動的・静的での割り当てが選択できます。<br>動的の割り当ての場合、プライベート エンドポイントをデプロイする対象サブネットのプレフィックスの範囲内で、基本的に若番から割り当てがされます。<br>静的の割り当ての場合、対象サブネットの範囲で任意の IP アドレスを指定可能です。<br>動的の割り当てを選択された場合でも、プライベート エンドポイントのリソースを削除しない限り、一度割り当てられた IP アドレスは変わりません。</p><h3 id="プライベート-DNS-ゾーンを同時に作ったが、プライベート-エンドポイントの-IP-アドレスの名前解決ができません。"><a href="#プライベート-DNS-ゾーンを同時に作ったが、プライベート-エンドポイントの-IP-アドレスの名前解決ができません。" class="headerlink" title="プライベート DNS ゾーンを同時に作ったが、プライベート エンドポイントの IP アドレスの名前解決ができません。"></a>プライベート DNS ゾーンを同時に作ったが、プライベート エンドポイントの IP アドレスの名前解決ができません。</h3><p>プライベート DNS ゾーンに適切な DNS レコードを設定したにも関わらず、名前解決ができない場合は下記の理由が考えられます。</p><p>　　<strong>A プライベート DNS ゾーンが、クライアントが存在する仮想ネットワークとリンク設定されていない。</strong></br><br>　　<strong>B プライベート DNS ゾーンが参照されない構成になっている。</strong></br><br>　　<strong>C プライベート DNS ゾーン上に必要な DNS レコードが存在していない。</strong></br></p><p><strong>A</strong></br><br>プライベート DNS ゾーンは、リンクされた仮想ネットワーク上のリソースに対して、登録されたゾーン上の DNS レコードに関して名前解決を提供します。そのため、プライベート DNS ゾーンのリソースから対象の<a href="https://learn.microsoft.com/ja-jp/azure/dns/private-dns-virtual-network-links">仮想ネットワークにリンク設定</a>を忘れないようにしてください。</p><p><strong>B</strong></br><br>プライベート DNS ゾーンを参照するためには、Azure 既定の DNS サーバー (168.63.129.16) に DNS クエリを転送する必要があります。オンプレミスのリソースからプライベート DNS ゾーンを参照する場合は、Azure DNS Private Resolver をご利用いただき、オンプレミスの DNS サーバーから条件付きフォワーダーなどで参照できるように構成してください。構成事例は<a href="https://learn.microsoft.com/ja-jp/azure/private-link/private-endpoint-dns-integration">こちら</a>にあります。</p><p><strong>C</strong></br><br>プライベート DNS ゾーンは、リソース グループ内で重複がなければ同一ゾーン名で複数構成が可能です。プライベート エンドポイントを構成時に DNS 統合した場合、自動で DNS レコードがプライベート DNS ゾーン上に構成されますが、この時対象のプライベート DNS ゾーンが異なるとクライアントが接続先の FQDN の名前解決ができなくなる場合があります。</p><h3 id="プライベート-DNS-ゾーンや-Azure-既定の-DNS-サーバーの名前解決のログを確認したい。"><a href="#プライベート-DNS-ゾーンや-Azure-既定の-DNS-サーバーの名前解決のログを確認したい。" class="headerlink" title="プライベート DNS ゾーンや Azure 既定の DNS サーバーの名前解決のログを確認したい。"></a>プライベート DNS ゾーンや Azure 既定の DNS サーバーの名前解決のログを確認したい。</h3><p>ご期待に沿えず恐れ入りますが、現状該当 DNS ログを Azure ユーザーが確認する方法はございません、<br>Azure サポート担当にご依頼いただければ、該当ログの調査支援が可能ですが、ログの調査をするには対象の FQDN と調査対象の時刻を可能な限り具体的にご提示願います。<br>なお、Azure 既定の DNS のログは、30 日程度でローテーションされ、過去のログは参照できない点はご留意ください。</p><h3 id="hosts-を使った-DNS-構成は非推奨とありますが、サポート外ですか？"><a href="#hosts-を使った-DNS-構成は非推奨とありますが、サポート外ですか？" class="headerlink" title="hosts を使った DNS 構成は非推奨とありますが、サポート外ですか？"></a>hosts を使った DNS 構成は非推奨とありますが、サポート外ですか？</h3><p>プライベート エンドポイントは、最終的に接続元クライアントが適切な名前解決ができれば接続可能なため、プライベート エンドポイントをご利用いただく上で hosts を利用いただくことがサポート外といった事はございません。そのため、トラブルシューティングの対応の一環でサポート担当から hosts への追加を依頼する場合があります。<br><br>しかしながら、hosts はクライアント端末毎に手動での個別管理となりますため、プライベート エンドポイントの作り直しによる IP アドレスの更新や新規エンドポイントの追加などが自動で適応されません。構成変更時などで hosts の更新漏れによる意図せぬ通信影響を回避するためにも、運用環境では hosts による構成は推奨していません。</p><h3 id="privatelink-サブドメインで-Azure-PaaS-に接続ができないのはなぜですか？"><a href="#privatelink-サブドメインで-Azure-PaaS-に接続ができないのはなぜですか？" class="headerlink" title="privatelink サブドメインで Azure PaaS に接続ができないのはなぜですか？"></a>privatelink サブドメインで Azure PaaS に接続ができないのはなぜですか？</h3><p>プライベート エンドポイントをご利用いただく上での<a href="/blog/network/pe-introduction/">ポイント</a> にも記載の通り、Azure PaaS にプライベート エンドポイント接続をする構成でも、接続時にご利用いただく FQDN は、Azure PaaS の既定のドメインが対象となります。<br>DNS レイヤーでルーティングができるように、privatelink サブドメインが追加されますが、この privatelink サブドメインが付与された FQDN で Azure PaaS に接続することは想定されていないため、接続エラーや証明書エラーが発生します。</p><h3 id="任意のドメイン-カスタムドメイン-を利用して-Azure-PaaS-にプライベート-エンドポイント接続が可能ですか？"><a href="#任意のドメイン-カスタムドメイン-を利用して-Azure-PaaS-にプライベート-エンドポイント接続が可能ですか？" class="headerlink" title="任意のドメイン (カスタムドメイン) を利用して Azure PaaS にプライベート エンドポイント接続が可能ですか？"></a>任意のドメイン (カスタムドメイン) を利用して Azure PaaS にプライベート エンドポイント接続が可能ですか？</h3><p>プライベート エンドポイントは、Azure PaaS への接続点を提供しているものであり、ドメイン管理などの機能は持ち合わせていません。<br>そのため、カスタムドメインをご利用いただけるかは、ご利用される Azure PaaS の機能に依存し、カスタムドメインをご利用いただく場合は対象の FQDN の名前解決が、プライベート エンドポイントの IP アドレスに解決されるように DNS 構成を実施いただく必要があります。</p><p>以上、ご参考になれば幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの箕輪です。&lt;br&gt;Azure のプライベート エンドポイントは Azure PaaS へのプライベート接続を実現できることから、多くのお客様にご利用いただいています。&lt;br&gt;Azure サポート担当でプライベート エンドポイントに関してお問い合わせいただく中で、プライベート エンドポイントをご利用いただく上でのポイントや、よくあるお問い合わせや情報採取についての内容を 2 回に分けてご紹介します。&lt;/p&gt;
&lt;ol&gt;
&lt;li&gt;&lt;a href=&quot;/blog/network/pe-introduction/&quot;&gt;プライベート エンドポイントをご利用いただく上でのポイント&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;プライベート エンドポイントのよくあるお問い合わせ (今回のご紹介)&lt;/li&gt;
&lt;/ol&gt;</summary>
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="DNS" scheme="https://jpaztech.github.io/blog/tags/DNS/"/>
    
    <category term="PrivateEndpoint" scheme="https://jpaztech.github.io/blog/tags/PrivateEndpoint/"/>
    
  </entry>
  
  <entry>
    <title>Azure Peering Service と ExpressRoute の違いについて</title>
    <link href="https://jpaztech.github.io/blog/network/azure-peering-service-vs-expressroute/"/>
    <id>https://jpaztech.github.io/blog/network/azure-peering-service-vs-expressroute/</id>
    <published>2024-01-29T01:00:00.000Z</published>
    <updated>2024-07-03T06:47:12.877Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure サポートの宇田です。<br>今回は Azure Peering Service と ExpressRoute の違いについてご紹介いたします。</p><h2 id="Azure-Peering-Service-とはどのようなサービスか"><a href="#Azure-Peering-Service-とはどのようなサービスか" class="headerlink" title="Azure Peering Service とはどのようなサービスか"></a>Azure Peering Service とはどのようなサービスか</h2><p>Microsoft Azure Peering Service (MAPS) は、インターネット サービス プロバイダー (ISP) や Internet Exchange (IX) 経由で Microsoft のグローバル ネットワーク (AS8075) へのルーティングを最適化し信頼性とパフォーマンスを強化するサービスです。サービス名に “Azure” の名前を冠してはいますが、その接続先は Azure だけではなく、パブリック インターネット経由でアクセス可能な Microsoft 365 や Dynamics 365 等を含んだ Microsoft のグローバル ネットワーク全体になります。</p><p>また、以下のドキュメントにも記載がありますが、Azure Peering Service は閉域接続 (プライベート接続) サービスではありません。あくまでも ISP や IX 経由で直接 Microsoft のネットワークに接続するサービスですので、他の AS を経由しない分だけホップ数や遅延が小さく抑えられ、通信経路上の影響を受けにくいというのみであり、位置づけとしてはパブリック ネットワーク (≒インターネット) 経由での接続となります。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/peering-service/about">Azure Peering Service の概要</a></li></ul><h2 id="ExpressRoute-の-Microsoft-Peering-と何が違うのか"><a href="#ExpressRoute-の-Microsoft-Peering-と何が違うのか" class="headerlink" title="ExpressRoute の Microsoft Peering と何が違うのか"></a>ExpressRoute の Microsoft Peering と何が違うのか</h2><p>Azure Peering Service と似たサービスとして、ExpressRoute 回線 (ExpressRoute Circuit) の Microsoft Peering が存在します。両者の違いについてお問い合わせいただく事も多いため、具体的な差異を以下の表でご説明します。</p><table><thead><tr><th></th><th>Azure Peering Service</th><th>ExpressRoute (Microsoft Peering)</th></tr></thead><tbody><tr><td>接続先</td><td>Microsoft のグローバル ネットワーク</td><td>主に Azure のみ</td></tr><tr><td>Microsoft 側の ASN</td><td>8075</td><td>12076</td></tr><tr><td>接続形態</td><td>パブリック接続 (≒インターネット)</td><td>プライベート接続 (≒閉域網)</td></tr><tr><td>Azure VNet への接続</td><td>不可</td><td>Private Peering を構成すれば可能</td></tr><tr><td>Microsoft 365 との接続 <a href="#Microsoft-365-%E3%81%A8%E3%81%AE%E6%8E%A5%E7%B6%9A%E3%81%AB%E9%96%A2%E3%81%97%E3%81%A6">(*)</a></td><td>可能</td><td>一部の承認されたお客様のみ可能</td></tr><tr><td>Azure 上のリソース <a href="#Microsoft-%E3%81%AE%E9%96%A2%E4%B8%8E%E3%81%99%E3%82%8B%E7%AF%84%E5%9B%B2%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">(**)</a></td><td>テレメトリ機能を利用する場合のみ作成</td><td>ExpressRoute 回線リソースを作成</td></tr><tr><td>接続料金 <a href="#Microsoft-%E3%81%AE%E9%96%A2%E4%B8%8E%E3%81%99%E3%82%8B%E7%AF%84%E5%9B%B2%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">(**)</a></td><td>原則、接続プロバイダー様のみにお支払い</td><td>Azure と接続プロバイダー様の双方にお支払い</td></tr><tr><td>SLA <a href="#Microsoft-%E3%81%AE%E9%96%A2%E4%B8%8E%E3%81%99%E3%82%8B%E7%AF%84%E5%9B%B2%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">(**)</a></td><td>接続プロバイダー様にご確認ください</td><td>MSEE 側の問題であれば Microsoft 側の SLA 有り</td></tr><tr><td>サポート窓口 <a href="#Microsoft-%E3%81%AE%E9%96%A2%E4%B8%8E%E3%81%99%E3%82%8B%E7%AF%84%E5%9B%B2%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">(**)</a></td><td>原則、接続プロバイダー様</td><td>Azure (MSEE) 側は Microsoft、PE 側は接続プロバイダー様</td></tr></tbody></table><h3 id="Microsoft-365-との接続に関して"><a href="#Microsoft-365-との接続に関して" class="headerlink" title="(*) Microsoft 365 との接続に関して"></a>(*) Microsoft 365 との接続に関して</h3><p><a href="https://learn.microsoft.com/ja-jp/microsoft-365/enterprise/azure-expressroute">Azure ExpressRoute for Microsoft 365</a> に以下の記載がある通り、ExpressRoute での Microsoft 365 への接続は承認制となっています。法規制により閉域接続が必須となっているような一部のお客様に限ってのみ承認され、そうした特殊な要件がない場合にはご利用いただけません。<strong>Microsoft 365 との安定した接続を確保したい一般のお客様は、Azure Peering Service での接続をご検討ください。</strong>(ただし、前述の通り Azure Peering Service は閉域接続のためのサービスではございませんのでご留意ください。)</p><blockquote><p><strong>Microsoft 365 の ExpressRoute は、ほとんどの状況でサービスに最適な接続モデルを提供しないため 、お勧めしません。</strong> そのため、この接続モデルを使用するには Microsoft の承認が必要です。 お客様のすべての要求を確認し、必要なまれなシナリオでのみ、Microsoft 365 の ExpressRoute を承認します。 詳細については 、<a href="https://aka.ms/erguide">ExpressRoute for Microsoft 365 ガイド</a> を参照してください。また、生産性、ネットワーク、セキュリティ チームに関するドキュメントの包括的なレビューに従って、Microsoft アカウント チームと協力して、必要に応じて例外を送信してください。 Microsoft 365 のルート フィルターを作成しようとしている未承認のサブスクリプションには、 <a href="https://support.microsoft.com/kb/3181709">エラー メッセージが表示</a>されます。</p></blockquote><p>また、Microsoft 365 は Internet 経由で快適にご利用いただけるよう弊社外の 3rd party の CDN サービス等も利用しているため、ExpressRoute と Azure Peering Service のいずれを利用される場合であっても、弊社外のエンドポイントとの通信に Internet 接続が必要となりますので、十分ご留意ください。</p><h3 id="Microsoft-の関与する範囲について"><a href="#Microsoft-の関与する範囲について" class="headerlink" title="(**) Microsoft の関与する範囲について"></a>(**) Microsoft の関与する範囲について</h3><p>ExpressRoute をご利用の場合には、Azure 上で ExpressRoute 回線のリソースを作成したり、各種設定をご実施いただきます。他方で Azure Peering Service に関しては、(テレメトリの機能を利用しない限りは) Azure 上のリソースは作成したり、設定を行っていただく必要はなく、ExpressRoute 回線のように Microsoft に対して接続料金をお支払いいただくことはありません。言い換えますと、仮に通信障害などが発生したとしても、Microsoft としては料金を頂戴していないため、SLA による返金はございません。(接続プロバイダー様による SLA の提供有無をご確認ください。)</p><p>また、Azure 側に個々のお客様のリソースが存在せず、各接続プロバイダー様とお客様間の契約情報なども弊社では把握できないことから、障害時に Microsoft 側へお問い合わせいただいたとしても環境固有の調査などを行うことができません。したがって、トラブル時のお問い合わせ先 (サポート窓口) は原則として Microsoft ではなく、接続プロバイダー様となります。(接続プロバイダー様によって Microsoft 側に問題があると判断された場合には、接続プロバイダー様と弊社の NOC 間で調査を行うこととなります。)</p><p>以上、ご参考になれば幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure サポートの宇田です。&lt;br&gt;今回は Azure Peering Service と ExpressRoute の違いについてご紹介いたします。&lt;/p&gt;
&lt;h2 id=&quot;Azure-Peering-Service-とはどのようなサービスか&quot;&gt;&lt;a hr</summary>
      
    
    
    
    
    <category term="Network" scheme="https://jpaztech.github.io/blog/tags/Network/"/>
    
    <category term="ExpressRoute" scheme="https://jpaztech.github.io/blog/tags/ExpressRoute/"/>
    
    <category term="Azure Peering Service" scheme="https://jpaztech.github.io/blog/tags/Azure-Peering-Service/"/>
    
  </entry>
  
  <entry>
    <title>設定変更不可の項目を VM 再作成により再設定する手順</title>
    <link href="https://jpaztech.github.io/blog/vm/recreate-vm-to-change-settings/"/>
    <id>https://jpaztech.github.io/blog/vm/recreate-vm-to-change-settings/</id>
    <published>2024-01-25T08:00:00.000Z</published>
    <updated>2024-07-03T06:47:13.225Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームの藤澤です。 </p><p>Azure VM のいくつかの設定項目は、VM 作成後は変更いただくことが叶いませんが、OS / データディスクを保持したまま、VM を再作成いただくことで再作成時に変更することが可能でございます。<br>本記事では、通常変更不可である設定項目を、VM を再作成で変更する手順についてご案内します。 </p><span id="more"></span><hr><h2 id="■再作成が必要となるシナリオ一覧紹介"><a href="#■再作成が必要となるシナリオ一覧紹介" class="headerlink" title="■再作成が必要となるシナリオ一覧紹介"></a>■再作成が必要となるシナリオ一覧紹介</h2><p>以下の項目を変更したい場合、VM の再作成が必要となっております。 </p><ul><li>可用性ゾーンの変更 / 追加 / 削除 </li><li>可用性セットの変更 / 追加 / 削除 </li><li>Spot VM 設定の有効 / 無効 の変更 </li><li>一時ディスク有りの VM サイズから一時ディスク無しの VM へサイズ変更（また、その逆） </li><li>VM リソース名称の変更 </li><li>VM の接続先 VNet の変更</li></ul><hr><h2 id="ポータルで-VM-再作成を行う手順"><a href="#ポータルで-VM-再作成を行う手順" class="headerlink" title="ポータルで VM 再作成を行う手順"></a>ポータルで VM 再作成を行う手順</h2><p>それでは、実際に VM 再作成で各項目を変更するための手順について説明させていただきます。 </p><h3 id="1-必要事項を控える"><a href="#1-必要事項を控える" class="headerlink" title="1. 必要事項を控える"></a>1. 必要事項を控える</h3><p> まずは、VM 再作成時に再度同じ設定をするために Azure ポータルの対象 VM の画面を開き、赤枠の項目を控えます。<br> 多くの項目がございますが、代表的なものについて説明させていただきますので、以下の通り設定値を控えておきましょう。 </p><h4 id="a-概要メニュー"><a href="#a-概要メニュー" class="headerlink" title="a. 概要メニュー"></a>a. 概要メニュー</h4><ul><li>リソースグループ名 </li><li>場所 </li><li>サイズ </li><li>パブリック IP アドレス </li><li>仮想ネットワーク / サブネット </li><li>可用性とスケーリング </li></ul><p> <img src="/blog/vm/recreate-vm-to-change-settings/1.png"></p><h4 id="b-ネットワークメニュー"><a href="#b-ネットワークメニュー" class="headerlink" title="b. ネットワークメニュー"></a>b. ネットワークメニュー</h4><p> 元の NIC を用いるかどうかによって、以下の 2 パターンに分けられます。VM 再作成時は Azure Portal にて既存 NIC を指定できませんが、VM 再作成後に後から NIC を付け替えることが可能です。該当する方を控えてください。 </p><p> <strong>b-1. 元の NIC を用いて新しい仮想マシンを作成する場合</strong></p><ul><li>ネットワーク設定メニュー<ul><li>NIC名 (元のNICが複数ある場合はすべて控える)<br><img src="/blog/vm/recreate-vm-to-change-settings/2.png"></li></ul></li></ul><p> <strong>b-2. 新しい仮想マシンを作成する際に、元の NIC を使用しない場合</strong></p><ul><li><p>ネットワーク設定メニュー</p><ul><li>NIC に設定されている NSG 名<br><img src="/blog/vm/recreate-vm-to-change-settings/3.png"></li></ul></li><li><p>負荷分散メニュー</p><ul><li>負荷分散の設定<br><img src="/blog/vm/recreate-vm-to-change-settings/4.png"></li></ul></li><li><p>ディスクメニュー</p><ul><li>各ディスク名 </li><li>各ディスクのホストキャッシュ設定<br><img src="/blog/vm/recreate-vm-to-change-settings/6.png"></li></ul></li></ul><p>これで、再作成のための情報を控えることができました。</p><hr><h3 id="2-スナップショットからゾーン設定を変更したディスク作成（可用性ゾーンの設定変更のシナリオの場合のみ実施）"><a href="#2-スナップショットからゾーン設定を変更したディスク作成（可用性ゾーンの設定変更のシナリオの場合のみ実施）" class="headerlink" title="2.スナップショットからゾーン設定を変更したディスク作成（可用性ゾーンの設定変更のシナリオの場合のみ実施）"></a>2.スナップショットからゾーン設定を変更したディスク作成（可用性ゾーンの設定変更のシナリオの場合のみ実施）</h3><div class="alert is-info"><p class="alert-title">Note</p><p>この手順は<strong>以下のシナリオに該当する場合のみ</strong>実施をお願いいたします。</p><p>該当しない場合は、後述の「3. 元の仮想マシンを削除する」の手順に進んでください。</p></div><p> <strong>【該当シナリオ】</strong></p><ul><li>もともと可用性ゾーンを使っており、今回可用性ゾーンに関する設定変更を行う<ul><li>例：ゾーン番号の変更・可用性ゾーンから可用性セットへの切り替え・可用性ゾーンをやめる</li></ul></li><li>可用性ゾーンを使っていなかったが、今回可用性ゾーンを使用するように変更する</li></ul><p> 上記シナリオの場合は、そのゾーン設定に対応するディスクを作成する必要があります。<br> 理由としては、以下の例のように特定のゾーン対応に存在しないディスクから、そのゾーン以外の VM を作成しようとすると、以下のような警告メッセージが表示され、VM 再作成ができないからとなります。 </p><p> <img src="/blog/vm/recreate-vm-to-change-settings/7.png"></p><h3 id="2-1-元の仮想マシンの-OS-ディスクのスナップショットを取る"><a href="#2-1-元の仮想マシンの-OS-ディスクのスナップショットを取る" class="headerlink" title="2-1. 元の仮想マシンの OS ディスクのスナップショットを取る"></a>2-1. 元の仮想マシンの OS ディスクのスナップショットを取る</h3><p>  a. Azure ポータルより [Virtual Machines] - [&lt;当該 VM 名&gt;] を開きます。 </p><p>  b. 左メニュー “設定” より [ディスク] を選択し、開いた画面 “OS ディスク” より [&lt;当該 OS ディスク名&gt;] をクリックします。</p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/5.png"></p><p>  c. 画面の [+ スナップショットの作成] をクリックします。</p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/8.png"></p><p>  d. 必要項目を適宜入力し、[確認および作成] - [作成] をクリックします。<br>  [ストレージの種類] は、スナップショットを高パフォーマンスのディスクに保存する必要がある場合を除き、 [Standard HDD(ローカル冗長ストレージ)] を選択します。 </p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/9.png"></p><p>  e. データディスクがある場合、データディスクについても同様にスナップショットを作成します。 </p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/10.png"></p><h3 id="2-2-スナップショットからディスクを作成する際に可用性ゾーン-可用性セットを変更する"><a href="#2-2-スナップショットからディスクを作成する際に可用性ゾーン-可用性セットを変更する" class="headerlink" title="2-2. スナップショットからディスクを作成する際に可用性ゾーン/可用性セットを変更する"></a>2-2. スナップショットからディスクを作成する際に可用性ゾーン/可用性セットを変更する</h3><p>  a. Azure ポータル 上部の検索バーに “スナップショット” と入力し、サービス [スナップショット] を選択します。<br>  上記手順で作成した OS ディスクおよび、データ ディスクのスナップショットが作成されていることを確認します。 </p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/11.png"></p><p>  b. 対象ディスクのスナップショットを選択し、[+ ディスクの作成] をクリックします </p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/12.png"></p><p>  c. 必要項目を適宜入力し、[確認および作成] - [作成] をクリックします。<br>  特定の可用性ゾーンに所属させたい場合は、以下のように可用性ゾーン番号をご指定ください。<br>  それ以外の場合は [インフラストラクチャ冗長は必要ありません] を選択します。 </p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/13.png"></p><p>これにより、特定のゾーンに所属するディスク（もしくは、ゾーン設定の無いディスク）を用意することが出来ました。<br>この作成したディスク名は VM 再作成時に使用しますので、控えておいてください。 </p><hr><h3 id="3-元の仮想マシンを削除する"><a href="#3-元の仮想マシンを削除する" class="headerlink" title="3. 元の仮想マシンを削除する"></a>3. 元の仮想マシンを削除する</h3><p> 元の仮想マシンを削除します。 </p><p> なお、この際にディスク等のリソースは残しますので、データが消失するものでは無い点はご安心ください。<br> 一時ディスクの内容は破棄されます点はご承知おきくださいませ。</p><p> a. 対象の仮想マシンの概要上部にある「削除」をクリック<br> <img src="/blog/vm/recreate-vm-to-change-settings/14.png"></p><p> b. 以下赤枠内にチェックを入れないように気を付けて削除してください<br> <img src="/blog/vm/recreate-vm-to-change-settings/15.png"></p><p>これでディスクを残したまま、仮想マシンのリソースを削除できました。 </p><hr><h3 id="4-元の仮想マシンの-OS-ディスクから新規仮想マシンを作成する際に変更したい項目を変更する"><a href="#4-元の仮想マシンの-OS-ディスクから新規仮想マシンを作成する際に変更したい項目を変更する" class="headerlink" title="4. 元の仮想マシンの OS ディスクから新規仮想マシンを作成する際に変更したい項目を変更する"></a>4. 元の仮想マシンの OS ディスクから新規仮想マシンを作成する際に変更したい項目を変更する</h3><p>残されたディスクから VM を再作成します。<br>VM 再作成時にお好みの設定に変更が可能となっております。 </p><p> a. Azure ポータルより削除した VM で使用していた OS ディスク (控えていた OS ディスク名を参照) の画面を開きます。<br> なお、ゾーンに関する設定変更を行う場合は <strong>「2.スナップショットからゾーン設定を変更したディスク作成（可用性ゾーンの設定変更のシナリオの場合のみ実施）」</strong> の手順で作成したディスクをかわりに選択します。</p><p> b. [VM の作成] をクリックします。 </p><p> <img src="/blog/vm/recreate-vm-to-change-settings/16.png"></p><p> c. 手順 <strong>「1. 必要事項を控える」</strong> にて控えていた内容をもとに VM の設定項目を入力していきます。<br> この際、変更を行いたい項目をご変更くださいませ。 </p><ul><li><p>リソース名を変更したい場合 </p><p><img src="/blog/vm/recreate-vm-to-change-settings/17.png"></p></li><li><p>データディスクを追加したい場合 </p><p>元の仮想マシンのデータディスクを追加したい場合は、[既存のディスクの接続] より追加します。 </p><p><img src="/blog/vm/recreate-vm-to-change-settings/18.png"></p><p><img src="/blog/vm/recreate-vm-to-change-settings/19.png"></p></li><li><p>新しい仮想マシンで可用性セットを使用したい場合</p><p> [可用性オプション] にて [可用性セット] を選択し、[可用性セット] の項目にてご希望の障害ドメイン、更新ドメイン数を入力ください。 </p><p> <img src="/blog/vm/recreate-vm-to-change-settings/20.png"></p></li><li><p>新しい仮想マシンで可用性ゾーンを使用したい場合 </p><p> [可用性オプション]の項目で[可用性ゾーン] を選択し、[可用性ゾーン] の項目では、スナップショットからディスクを作成する際に指定したゾーン番号を選択します。  </p><p> <img src="/blog/vm/recreate-vm-to-change-settings/21.png"></p></li><li><p>Azure Spot 割引を変更したい場合 </p><p> <img src="/blog/vm/recreate-vm-to-change-settings/22.png"></p></li><li><p> 接続先 VNET を変更したい場合 </p></li></ul><p>   <img src="/blog/vm/recreate-vm-to-change-settings/23.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>ネットワークについて、既存の NIC 接続は VM 作成後に行いますので、既存 NIC を使用する場合、この段階での “NIC ネットワーク セキュリティ グループ” の設定は不要です。</p><p>新規の NIC を使用する場合は、リージョンの変更が無い場合、元と同じ NSG を選択することも可能です。  </p></div><p> d.全ての設定が完了後、 [確認および作成] から[作成] をクリックします。  </p><p> <img src="/blog/vm/recreate-vm-to-change-settings/24.png"></p><hr><h3 id="オプション：-NIC-の付け替え"><a href="#オプション：-NIC-の付け替え" class="headerlink" title="オプション： NIC の付け替え"></a>オプション： NIC の付け替え</h3><p>  Azure ポータルより VM 作成をする際には既存 NIC を指定できませんが、 VM 再作成後に後から NIC を付け替えることが可能です。</p><p>  a. 仮想マシンを作成後、既存の NIC を接続するため、VM を停止 (割り当て解除) します。</p><p>  b. VM 停止 (割り当て解除) 後、VM のページから [ネットワーク] - ネットワーク設定 - [ネットワーク インターフェイスのアタッチ] を選択し、削除した VM で使用していた NIC を接続します。 </p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/26.png"></p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/27.png"></p><p>  c. 既存の NIC の接続完了後も、VM 作成時に作成された NIC がまだプライマリとなっている状態なので、[ネットワーク インターフェイスのデタッチ] を選択し、その NIC をデタッチします。 </p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/28.png"></p><p>  <img src="/blog/vm/recreate-vm-to-change-settings/29.png"></p><p>  NIC のデタッチを実施後、セカンダリとして接続した既存 NIC は自動的にプライマリとなります。<br>  なお、デタッチした NIC については削除されても問題ありません。 </p><p>  d. VM を起動します。 </p><hr><p>手順は以上となります。本記事が皆様のお役に立ちましたら幸いです。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームの藤澤です。 &lt;/p&gt;
&lt;p&gt;Azure VM のいくつかの設定項目は、VM 作成後は変更いただくことが叶いませんが、OS / データディスクを保持したまま、VM を再作成いただくことで再作成時に変更することが可能でございます。&lt;br&gt;本記事では、通常変更不可である設定項目を、VM を再作成で変更する手順についてご案内します。 &lt;/p&gt;</summary>
    
    
    
    
    <category term="VM" scheme="https://jpaztech.github.io/blog/tags/VM/"/>
    
    <category term="HowTo" scheme="https://jpaztech.github.io/blog/tags/HowTo/"/>
    
  </entry>
  
  <entry>
    <title>お問い合わせにてパスワード等の機密情報を記載しないようにお願いいたします</title>
    <link href="https://jpaztech.github.io/blog/information/do-not-provide-sensitive-data/"/>
    <id>https://jpaztech.github.io/blog/information/do-not-provide-sensitive-data/</id>
    <published>2024-01-25T03:00:00.000Z</published>
    <updated>2024-07-03T06:47:12.861Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure テクニカル サポート チームです。<br>Azure テクニカル サポート チームではお客様から頂いた情報は厳重に管理をしております。<br>しかしながら、お客様のセキュリティを守るためにも、お問い合わせにてパスワード等の機密情報を記載しないように注意喚起のご案内をさせていただきたく存じます。</p><hr><h2 id="お問い合わせにて機密情報を記載しないようにお願いいたします"><a href="#お問い合わせにて機密情報を記載しないようにお願いいたします" class="headerlink" title="お問い合わせにて機密情報を記載しないようにお願いいたします"></a>お問い合わせにて機密情報を記載しないようにお願いいたします</h2><p>幣 Azure テクニカル サポート チームにお問い合わせをいただく際に、パスワード等の機密情報を記載されてしまっているというケースが発生しております。<br>恐れ入りますが、機密情報はお客様自身で適切に管理いただき、お問い合わせにてお客様の機密情報を記載をしないようにお願い申し上げます。  </p><p>これはお問い合わせ起票時以外にも、以下のようなお問い合わせ最中のやり取りも含めてのお願いとなります点、ご理解頂けますと幸いでございます。  </p><ul><li>お問い合わせ起票時の本文内への記載</li><li>お問い合わせ起票時にアップロードいただいたファイル内での記載</li><li>弊社とのメールやり取りでの本文内への記載</li><li>弊社とのメールやり取りでの添付ファイルでの記載</li><li>お問い合わせ後にアップロードいただいたファイル内での記載</li><li>電話での口頭でのやり取り</li></ul><p>加えて、テキストベースのファイル以外にもスクリーンショットなどの画像についても機密情報が含まれないようにご注意くださいませ。</p><hr><h2 id="記載してはいけない機密情報の例"><a href="#記載してはいけない機密情報の例" class="headerlink" title="記載してはいけない機密情報の例"></a>記載してはいけない機密情報の例</h2><p>以下の例のような機密情報は、お問い合わせに記載をしないようにお願い申し上げます。  </p><ul><li>OS ユーザー / Azure ユーザー等のパスワード</li><li>Azure ストレージアカウントのアクセスキー</li><li>有効な Azure ストレージアカウントの SAS キー</li><li>秘密鍵</li><li>クレジットカード番号</li></ul><p>もしこれらの情報が含まれる場合は、当該箇所をマスクしていただくようにお願い申し上げます。<br>以下はパスワードや Azure ストレージアカウントのアクセスキーおよび SAS キーについてマスクする一例となります。</p><h3 id="パスワードが入ったコマンドについてお問い合わせする場合"><a href="#パスワードが入ったコマンドについてお問い合わせする場合" class="headerlink" title="パスワードが入ったコマンドについてお問い合わせする場合"></a>パスワードが入ったコマンドについてお問い合わせする場合</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">-- password P@ssw0rd!</span><br><span class="line">　   ↓</span><br><span class="line">-- password &lt;●●●機密情報のためパスワードはマスクします●●●&gt;</span><br></pre></td></tr></table></figure><h3 id="Azure-ポータルから取得した-Azure-Files-への接続スクリプトについてお問い合わせする場合の例（アクセスキーをマスク）"><a href="#Azure-ポータルから取得した-Azure-Files-への接続スクリプトについてお問い合わせする場合の例（アクセスキーをマスク）" class="headerlink" title="Azure ポータルから取得した Azure Files への接続スクリプトについてお問い合わせする場合の例（アクセスキーをマスク）"></a>Azure ポータルから取得した Azure Files への接続スクリプトについてお問い合わせする場合の例（アクセスキーをマスク）</h3><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$connectTestResult</span> = <span class="built_in">Test-NetConnection</span> <span class="literal">-ComputerName</span> <span class="built_in">test-storage</span><span class="literal">-account</span>.file.core.windows.net <span class="literal">-Port</span> <span class="number">445</span></span><br><span class="line"><span class="keyword">if</span> (<span class="variable">$connectTestResult</span>.TcpTestSucceeded) &#123;</span><br><span class="line">    <span class="comment"># 再起動時にドライブが維持されるように、パスワードを保存する</span></span><br><span class="line">    cmd.exe /C <span class="string">&quot;cmdkey /add:`&quot;test-storage-account.file.core.windows.net`&quot; /user:`&quot;localhost\test-storage-account`&quot; /pass:`&quot;&lt;●●●ストレージアカウントのアクセスキーなのでマスクします●●●&gt;`&quot;&quot;</span></span><br><span class="line">    <span class="comment"># ドライブをマウントする</span></span><br><span class="line">    <span class="built_in">New-PSDrive</span> <span class="literal">-Name</span> Z <span class="literal">-PSProvider</span> FileSystem <span class="literal">-Root</span> <span class="string">&quot;\\test-storage-account.file.core.windows.net\test&quot;</span> <span class="literal">-Persist</span></span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="built_in">Write-Error</span> <span class="literal">-Message</span> <span class="string">&quot;Unable to reach the Azure storage account via port 445. Check to make sure your organization or ISP is not blocking port 445, or use Azure P2S VPN, Azure S2S VPN, or Express Route to tunnel SMB traffic over a different port.&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="SAS-キーを用いたストレージアカウントの-Blob-コンテナへのアクセスについてお問い合わせする際の例（SAS-キーをマスク）"><a href="#SAS-キーを用いたストレージアカウントの-Blob-コンテナへのアクセスについてお問い合わせする際の例（SAS-キーをマスク）" class="headerlink" title="SAS キーを用いたストレージアカウントの Blob コンテナへのアクセスについてお問い合わせする際の例（SAS キーをマスク）"></a>SAS キーを用いたストレージアカウントの Blob コンテナへのアクセスについてお問い合わせする際の例（SAS キーをマスク）</h3><p><code>https://test-storage-account.blob.core.windows.net/container?sv=2022-11-02&amp;ss=bfqt&amp;srt=sco&amp;sp=rwdlacupiytfx&amp;se=2023-12-29T12:05:45Z&amp;st=2023-12-29T04:05:45Z&amp;spr=https&amp;sig=&lt;●●●ストレージアカウントの SAS キーなのでマスクします●●●&gt;</code></p><div class="alert is-success"><p class="alert-title">ヒント</p><p>Azure ストレージアカウントのアクセスキーについてご懸念がございます場合は、以下の公開ドキュメントの通りローテーションを行うことが可能です。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/storage/common/storage-account-keys-manage#manually-rotate-access-keys">https://learn.microsoft.com/ja-jp/azure/storage/common/storage-account-keys-manage#manually-rotate-access-keys</a></p></div><hr><h2 id="機密情報をお問い合わせで記載してしまった場合"><a href="#機密情報をお問い合わせで記載してしまった場合" class="headerlink" title="機密情報をお問い合わせで記載してしまった場合"></a>機密情報をお問い合わせで記載してしまった場合</h2><p>もし、お客様側より上記のような機密情報を記載されてしまった際は、弊社よりお客様へご連絡の上、弊社およびお客様側で当該情報の削除の対応や、場合によっては新規のお問い合わせ発行をお願いさせていただくといったお手間をおかけする可能性があります。<br>そのため、サポート着手までお時間をいただく可能性がございます。<br>迅速なサポートのご提供およびお客様のセキュリティのためにも、機密情報の記載をしないようにご協力をお願い申し上げます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure テクニカル サポート チームです。&lt;br&gt;Azure テクニカル サポート チームではお客様から頂いた情報は厳重に管理をしております。&lt;br&gt;しかしながら、お客様のセキュリティを守るためにも、お問い合わせにてパスワード等の機密情報を記載しないように注</summary>
      
    
    
    
    
    <category term="Information" scheme="https://jpaztech.github.io/blog/tags/Information/"/>
    
  </entry>
  
</feed>
